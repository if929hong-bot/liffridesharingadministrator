<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ˆè²»é é¢ - å¤šå…ƒåŒ–ä¹˜è»Šç®¡ç†ç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS ç°¡åŒ–æ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Font Awesome åœ–æ¨™ -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel='stylesheet'>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <!-- å¼•å…¥ html2canvas å¯¦ç¾æˆªåœ–åŠŸèƒ½ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f5f5f5;
        }
        .meter-card {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background: white;
        }
        .amount-display {
            font-size: 3rem;
            font-weight: bold;
            color: #22c55e;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-display {
            font-size: 1.25rem;
            color: #64748b;
        }
        .mileage-display {
            font-size: 1.5rem;
            color: #334155;
        }
        .btn-primary {
            background: #22c55e;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #16a34a;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-screenshot {
            background: #3b82f6;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-screenshot:hover {
            background: #2563eb;
        }
        .btn-close {
            background: #64748b;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-close:hover {
            background: #475569;
        }
        .timer-animation {
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.8; }
        }
        /* Mapboxåœ°åœ–æ¨£å¼ */
        #ride-map {
            width: 100%;
            height: 200px;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        /* Utilså·¥å…·é¡æ¨£å¼ */
        .utils-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            width: 100%;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease forwards;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .utils-alert.success {
            background: #f0fdf4;
            color: #065f46;
        }
        .utils-alert.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .utils-alert.warning {
            background: #fffbeb;
            color: #92400e;
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #22c55e;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            animation: spin 1s linear infinite;
        }
    </style>
    <script>
        // é…ç½®Mapbox Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWY5Mjlob25nIiwiYSI6ImNtamQxczU2cjAweDMzZnM1Z3BvY2JkejgifQ.q-GNcs0rqWrZ3HtjhmysEQ';
        
        /**
         * å…¨å±€å·¥å…·é¡ - æå‡ç¶²ç«™ç©©å®šæ€§ã€çµ±ä¸€è™•ç†é€šç”¨é‚è¼¯
         * é©ç”¨æ–¼æ‰€æœ‰è»ŠéšŠç®¡ç†ç³»çµ±é é¢ï¼ˆè¨ˆè²»é /å¸æ©Ÿé /ç®¡ç†é ï¼‰
         */
        const Utils = {
            // ========== åŸºç¤å·¥å…·æ–¹æ³• ==========
            /**
             * å®‰å…¨è§£æJSONï¼ˆé¿å…è§£æå¤±æ•—å°è‡´é é¢å´©æ½°ï¼‰
             * @param {string} str - è¦è§£æçš„JSONå­—ä¸²
             * @returns {any|null} è§£æå¾Œçš„æ•¸æ“šï¼Œå¤±æ•—è¿”å›null
             */
            safeParseJSON(str) {
                try {
                    return str && str !== 'null' && str !== 'undefined' ? JSON.parse(str) : null;
                } catch (e) {
                    console.error('JSONè§£æå¤±æ•—:', e, 'åŸå§‹å­—ä¸²:', str);
                    return null;
                }
            },

            /**
             * å®‰å…¨ç²å–DOMå…ƒç´ ï¼ˆé¿å…æ“ä½œç©ºå…ƒç´ å ±éŒ¯ï¼‰
             * @param {string} id - å…ƒç´ ID
             * @returns {HTMLElement|null} å…ƒç´ å°è±¡æˆ–null
             */
            safeGetElement(id) {
                const el = document.getElementById(id);
                if (!el) console.warn(`[Utils] å…ƒç´ #${id}ä¸å­˜åœ¨`);
                return el;
            },

            /**
             * é©—è­‰æ•¸å­—è¼¸å…¥ï¼ˆé©ç”¨åƒ¹æ ¼ã€é‡‘é¡ç­‰è¡¨å–®ï¼‰
             * @param {string} value - è¼¸å…¥å€¼
             * @param {boolean} allowZero - æ˜¯å¦å…è¨±0ï¼ˆé è¨­ä¸å…è¨±ï¼‰
             * @returns {boolean} æ˜¯å¦æœ‰æ•ˆ
             */
            validateNumber(value, allowZero = false) {
                const trimmed = value.trim();
                // é©—è­‰æ˜¯å¦ç‚ºç´”æ•¸å­—
                if (!/^\d+$/.test(trimmed)) return false;
                // é©—è­‰æ˜¯å¦å¤§æ–¼0ï¼ˆå¦‚æœä¸å…è¨±0ï¼‰
                if (!allowZero && Number(trimmed) <= 0) return false;
                return true;
            },

            /**
             * é¡¯ç¤ºçµ±ä¸€æç¤ºè¨Šæ¯ï¼ˆå–ä»£alertï¼Œæå‡é«”é©—ï¼‰
             * @param {string} message - æç¤ºå…§å®¹
             * @param {string} type - é¡å‹ success/error/warning
             * @param {number} duration - è‡ªå‹•é—œé–‰æ™‚é–“ï¼ˆç§’ï¼Œé è¨­3ç§’ï¼‰
             */
            showMessage(message, type = 'success', duration = 3) {
                // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
                const oldAlert = document.querySelector('.utils-alert');
                if (oldAlert) oldAlert.remove();
                
                // å‰µå»ºæç¤ºå…ƒç´ 
                const alertEl = document.createElement('div');
                alertEl.className = `utils-alert ${type}`;
                
                // è¨­ç½®åœ–æ¨™
                const iconMap = {
                    success: '<i class="fa fa-check-circle"></i>',
                    error: '<i class="fa fa-times-circle"></i>',
                    warning: '<i class="fa fa-exclamation-circle"></i>'
                };
                
                alertEl.innerHTML = `
                    ${iconMap[type] || iconMap.success}
                    <span>${message}</span>
                `;
                
                // æ·»åŠ åˆ°é é¢
                document.body.appendChild(alertEl);
                
                // è‡ªå‹•ç§»é™¤
                if (duration > 0) {
                    setTimeout(() => {
                        alertEl.style.animation = 'slideIn 0.3s ease reverse forwards';
                        setTimeout(() => alertEl.remove(), 300);
                    }, duration * 1000);
                }
                
                return alertEl;
            },

            // ========== æœ¬åœ°å­˜å„²ç®¡ç†ï¼ˆå¸¶éæœŸæ©Ÿåˆ¶ï¼‰ ==========
            Storage: {
                /**
                 * å„²å­˜æ•¸æ“šåˆ°localStorageï¼ˆè‡ªå‹•åºåˆ—åŒ–+è¨­ç½®éæœŸï¼‰
                 * @param {string} key - å„²å­˜éµå
                 * @param {any} data - è¦å„²å­˜çš„æ•¸æ“š
                 * @param {number} expireHours - éæœŸå°æ™‚ï¼ˆé è¨­24å°æ™‚ï¼‰
                 */
                set(key, data, expireHours = 24) {
                    try {
                        const value = JSON.stringify(data);
                        localStorage.setItem(key, value);
                        // è¨­ç½®éæœŸæ™‚é–“æˆ³
                        if (expireHours) {
                            const expireTime = Date.now() + expireHours * 60 * 60 * 1000;
                            localStorage.setItem(`${key}_expire`, expireTime);
                        }
                    } catch (e) {
                        console.error('[Storage] å„²å­˜å¤±æ•—:', e);
                        Utils.showMessage('æœ¬åœ°å­˜å„²ç©ºé–“ä¸è¶³ï¼Œç„¡æ³•ä¿å­˜æ•¸æ“šï¼', 'error');
                    }
                },

                /**
                 * å¾localStorageç²å–æ•¸æ“šï¼ˆè‡ªå‹•æª¢æŸ¥éæœŸï¼‰
                 * @param {string} key - å„²å­˜éµå
                 * @returns {any|null} å„²å­˜çš„æ•¸æ“šï¼ŒéæœŸ/ä¸å­˜åœ¨è¿”å›null
                 */
                get(key) {
                    try {
                        const expireTime = localStorage.getItem(`${key}_expire`);
                        // æª¢æŸ¥æ˜¯å¦éæœŸ
                        if (expireTime && Date.now() > Number(expireTime)) {
                            this.remove(key);
                            return null;
                        }
                        // è§£æä¸¦è¿”å›æ•¸æ“š
                        return Utils.safeParseJSON(localStorage.getItem(key));
                    } catch (e) {
                        console.error('[Storage] è®€å–å¤±æ•—:', e);
                        return null;
                    }
                },

                /**
                 * ç§»é™¤localStorageä¸­çš„æ•¸æ“šï¼ˆåŒ…å«éæœŸæ¨™è¨˜ï¼‰
                 * @param {string} key - å„²å­˜éµå
                 */
                remove(key) {
                    localStorage.removeItem(key);
                    localStorage.removeItem(`${key}_expire`);
                },

                /**
                 * æ¸…ç©ºæ‰€æœ‰è»ŠéšŠç®¡ç†ç³»çµ±ç›¸é—œå­˜å„²
                 */
                clearAllFleetData() {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.includes('fleet') || key.includes('admin') || key.includes('price') || key.includes('finance') || key.includes('driver')) {
                            this.remove(key);
                        }
                    });
                }
            },

            // ========== ç™»éŒ„ç‹€æ…‹ç®¡ç† ==========
            Auth: {
                // å¸æ©Ÿç™»éŒ„ç‹€æ…‹ç›¸é—œéµå
                DRIVER_KEYS: {
                    PASSED_LIST: 'driverPassedList',
                    LOGGED_IN: 'driverLoggedIn',
                    EXPIRE: 'driverExpireTime'
                },

                /**
                 * æª¢æŸ¥å¸æ©Ÿç™»éŒ„ç‹€æ…‹æ˜¯å¦æœ‰æ•ˆ
                 * @returns {boolean} æ˜¯å¦ç™»éŒ„æœ‰æ•ˆ
                 */
                checkDriverLoginStatus() {
                    // ç²å–å¸æ©Ÿç™»éŒ„æ•¸æ“š
                    const driverData = Utils.Storage.get(Utils.Auth.DRIVER_KEYS.LOGGED_IN);
                    
                    // é©—è­‰ç™»éŒ„æ•¸æ“šæ˜¯å¦æœ‰æ•ˆ
                    const hasValidData = driverData && driverData.phone && driverData.password;

                    if (!hasValidData) {
                        return false;
                    }

                    // è‡ªå‹•çºŒæœŸï¼ˆæ¯æ¬¡æª¢æŸ¥éƒ½å»¶é•·24å°æ™‚éæœŸï¼‰
                    Utils.Storage.set(Utils.Auth.DRIVER_KEYS.LOGGED_IN, driverData, 24);
                    return true;
                },

                /**
                 * å¼·åˆ¶è·³è½‰åˆ°å¸æ©Ÿç™»å…¥é 
                 */
                redirectToDriverLogin() {
                    Utils.showMessage('è«‹å…ˆç™»éŒ„å¸æ©Ÿå¸³è™Ÿï¼', 'warning');
                    setTimeout(() => {
                        window.location.href = 'driver-login.html';
                    }, 1000);
                },

                /**
                 * å¸æ©Ÿé€€å‡ºç™»éŒ„
                 */
                driverLogout() {
                    Utils.Storage.remove(Utils.Auth.DRIVER_KEYS.LOGGED_IN);
                    window.location.href = 'driver-login.html';
                }
            },

            // ========== UIå¢å¼·æ–¹æ³• ==========
            /**
             * é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹ï¼ˆé©ç”¨æŒ‰éˆ•/é é¢åŠ è¼‰å ´æ™¯ï¼‰
             * @param {HTMLElement} el - è¦é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹çš„å…ƒç´ ï¼ˆå¯é¸ï¼‰
             * @param {string} text - åŠ è¼‰æç¤ºæ–‡å­—ï¼ˆé è¨­ï¼šè™•ç†ä¸­...ï¼‰
             */
            showLoading(el, text = 'è™•ç†ä¸­...') {
                // é é¢ç´šåŠ è¼‰
                if (!el) {
                    const loadingEl = document.createElement('div');
                    loadingEl.className = 'loading-overlay';
                    loadingEl.innerHTML = `
                        <div class="flex flex-col items-center gap-2">
                            <div class="loading-spinner"></div>
                            <span class="text-text-dark text-sm">${text}</span>
                        </div>
                    `;
                    loadingEl.id = 'page-loading';
                    document.body.appendChild(loadingEl);
                    return;
                }

                // å…ƒç´ ç´šåŠ è¼‰
                if (!el) return;
                el.disabled = true;
                el.classList.add('btn-loading');
                const originalText = el.innerHTML;
                el.setAttribute('data-original-text', originalText);
                el.innerHTML = text;
            },

            /**
             * éš±è—åŠ è¼‰ç‹€æ…‹
             * @param {HTMLElement} el - è¦é‚„åŸçš„å…ƒç´ ï¼ˆå¯é¸ï¼‰
             * @param {string} restoreText - é‚„åŸçš„æŒ‰éˆ•æ–‡å­—ï¼ˆå¯é¸ï¼‰
             */
            hideLoading(el, restoreText = '') {
                // ç§»é™¤é é¢ç´šåŠ è¼‰
                const pageLoading = document.getElementById('page-loading');
                if (pageLoading) pageLoading.remove();

                // é‚„åŸå…ƒç´ ç´šåŠ è¼‰
                if (el) {
                    el.disabled = false;
                    el.classList.remove('btn-loading');
                    const originalText = el.getAttribute('data-original-text');
                    if (originalText) el.innerHTML = originalText;
                    else if (restoreText) el.innerHTML = restoreText;
                }
            },

            /**
             * å®‰å…¨è·³è½‰é é¢ï¼ˆå¸¶åŠ è¼‰ç‹€æ…‹å’ŒéŒ¯èª¤è™•ç†ï¼‰
             * @param {string} url - ç›®æ¨™URL
             * @param {string} message - è·³è½‰å‰æç¤ºè¨Šæ¯
             */
            safeNavigate(url, message = '') {
                try {
                    // é¡¯ç¤ºæç¤º
                    if (message) Utils.showMessage(message, 'success');
                    
                    // é¡¯ç¤ºé é¢åŠ è¼‰
                    Utils.showLoading(null, 'è·³è½‰ä¸­...');
                    
                    // å»¶é²è·³è½‰æå‡é«”é©—
                    setTimeout(() => {
                        window.location.href = url;
                    }, 500);
                } catch (e) {
                    console.error('è·³è½‰å¤±æ•—:', e);
                    Utils.hideLoading();
                    Utils.showMessage('é é¢è·³è½‰å¤±æ•—ï¼Œè«‹æ‰‹å‹•æ“ä½œ', 'error');
                }
            },

            // ========== è¨ˆè²»é å°ˆç”¨æ–¹æ³• ==========
            /**
             * å®‰å…¨åŠ è¼‰è¨‚å–®æ•¸æ“š
             * @param {string} orderId - è¨‚å–®ID
             * @returns {object|null} è¨‚å–®æ•¸æ“šæˆ–null
             */
            loadOrderDataSafe(orderId) {
                try {
                    if (!orderId) {
                        Utils.showMessage('è¨‚å–®IDä¸å­˜åœ¨ï¼Œè«‹è¿”å›è¨‚å–®åˆ—è¡¨ï¼', 'error');
                        Utils.safeNavigate('driver-order.html');
                        return null;
                    }

                    // å®‰å…¨ç²å–è¨‚å–®åˆ—è¡¨
                    const orders = Utils.Storage.get('driverOrders') || [];
                    const order = orders.find(order => order.id === orderId);

                    if (!order) {
                        Utils.showMessage('è¨‚å–®ä¿¡æ¯ä¸å­˜åœ¨ï¼Œè«‹è¿”å›è¨‚å–®åˆ—è¡¨ï¼', 'error');
                        Utils.safeNavigate('driver-order.html');
                        return null;
                    }

                    return order;
                } catch (e) {
                    console.error('åŠ è¼‰è¨‚å–®æ•¸æ“šå¤±æ•—:', e);
                    Utils.showMessage('åŠ è¼‰è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                    return null;
                }
            },

            /**
             * æ ¼å¼åŒ–æ™‚é–“ï¼ˆç§’æ•¸è½‰ç‚º HH:MM:SSï¼‰
             * @param {number} seconds - ç¸½ç§’æ•¸
             * @returns {string} æ ¼å¼åŒ–çš„æ™‚é–“å­—ç¬¦ä¸²
             */
            formatTime(seconds) {
                try {
                    const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                    const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                    return `${h}:${m}:${s}`;
                } catch (e) {
                    console.error('æ™‚é–“æ ¼å¼åŒ–å¤±æ•—:', e);
                    return '00:00:00';
                }
            },

            /**
             * è¨ˆç®—è¨ˆè²»é‡‘é¡ï¼ˆå¸¶é©—è­‰ï¼‰
             * @param {number} durationSeconds - è¡Œç¨‹ç§’æ•¸
             * @param {number} mileage - é‡Œç¨‹æ•¸
             * @param {object} fareRules - è¨ˆè²»è¦å‰‡
             * @returns {number} è¨ˆç®—å¾Œçš„é‡‘é¡
             */
            calculateFareSafe(durationSeconds, mileage, fareRules) {
                try {
                    // é©—è­‰åƒæ•¸æœ‰æ•ˆæ€§
                    if (typeof durationSeconds !== 'number' || durationSeconds < 0) durationSeconds = 0;
                    if (typeof mileage !== 'number' || mileage < 0) mileage = 0;
                    
                    let amount = fareRules.startPrice || 80;
                    
                    // è¶…éèµ·æ­¥é‡Œç¨‹çš„éƒ¨åˆ†è¨ˆè²»
                    const startMileage = fareRules.startMileage || 1;
                    if (mileage > startMileage) {
                        const extraMileage = mileage - startMileage;
                        amount += extraMileage * (fareRules.perKmPrice || 25);
                    }
                    
                    // æ™‚é–“è²»ç”¨ï¼ˆæ¯åˆ†é˜ï¼‰
                    const minutes = Math.floor(durationSeconds / 60);
                    amount += minutes * (fareRules.perMinutePrice || 2);
                    
                    return Math.round(amount);
                } catch (e) {
                    console.error('è¨ˆè²»è¨ˆç®—å¤±æ•—:', e);
                    return fareRules.startPrice || 80;
                }
            },

            /**
             * ä¿å­˜è¡Œç¨‹å®Œæˆæ•¸æ“š
             * @param {string} orderId - è¨‚å–®ID
             * @param {object} tripData - è¡Œç¨‹æ•¸æ“š
             * @returns {boolean} æ˜¯å¦ä¿å­˜æˆåŠŸ
             */
            saveTripCompletedData(orderId, tripData) {
                try {
                    // ç²å–ç•¶å‰è¨‚å–®åˆ—è¡¨
                    const orders = Utils.Storage.get('driverOrders') || [];
                    const orderIndex = orders.findIndex(order => order.id === orderId);
                    
                    if (orderIndex === -1) {
                        Utils.showMessage('è¨‚å–®ä¸å­˜åœ¨ï¼Œç„¡æ³•ä¿å­˜è¡Œç¨‹æ•¸æ“š', 'error');
                        return false;
                    }
                    
                    // æ›´æ–°è¨‚å–®æ•¸æ“š
                    orders[orderIndex] = {
                        ...orders[orderIndex],
                        ...tripData,
                        status: 'completed'
                    };
                    
                    // ä¿å­˜æ›´æ–°å¾Œçš„è¨‚å–®åˆ—è¡¨
                    Utils.Storage.set('driverOrders', orders, 48);
                    
                    // å–®ç¨ä¿å­˜æœ€çµ‚é‡‘é¡ï¼ˆä¾›å®Œæˆé ä½¿ç”¨ï¼‰
                    Utils.Storage.set('totalAmount', tripData.finalAmount, 24);
                    
                    return true;
                } catch (e) {
                    console.error('ä¿å­˜è¡Œç¨‹æ•¸æ“šå¤±æ•—:', e);
                    Utils.showMessage('ä¿å­˜è¡Œç¨‹æ•¸æ“šå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¨˜éŒ„é‡‘é¡', 'warning');
                    return false;
                }
            },

            /**
             * ç”Ÿæˆä¸¦ä¸‹è¼‰æˆªåœ–ï¼ˆå¢å¼·ç‰ˆï¼‰
             * @param {HTMLElement} targetEl - æˆªåœ–ç›®æ¨™å…ƒç´ 
             * @param {string} orderId - è¨‚å–®ID
             * @returns {Promise<boolean>} æ˜¯å¦æˆåŠŸ
             */
            async generateScreenshot(targetEl, orderId) {
                try {
                    if (!targetEl) {
                        Utils.showMessage('æˆªåœ–ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨', 'error');
                        return false;
                    }
                    
                    // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
                    Utils.showLoading(null, 'æ­£åœ¨ç”Ÿæˆæˆªåœ–...');
                    
                    // ä½¿ç”¨ html2canvas ç”Ÿæˆé«˜è³ªé‡æˆªåœ–
                    const canvas = await html2canvas(targetEl, {
                        scale: 2, // æé«˜åˆ†è¾¨ç‡
                        useCORS: true, // è§£æ±ºè·¨åŸŸåœ–ç‰‡å•é¡Œ
                        logging: false,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    // å‰µå»ºä¸‹è¼‰éˆæ¥
                    const link = document.createElement('a');
                    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const fileName = `è¨ˆè²»é é¢_${orderId || 'æœªçŸ¥è¨‚å–®'}_${timestamp}.png`;
                    
                    // è¨­ç½®ä¸‹è¼‰å±¬æ€§
                    link.download = fileName;
                    link.href = canvas.toDataURL('image/png', 1.0); // 1.0 è³ªé‡
                    
                    // è§¸ç™¼ä¸‹è¼‰
                    link.click();
                    
                    // éš±è—åŠ è¼‰ç‹€æ…‹
                    Utils.hideLoading();
                    Utils.showMessage('æˆªåœ–å·²æˆåŠŸä¿å­˜ï¼', 'success');
                    
                    return true;
                } catch (e) {
                    console.error('æˆªåœ–ç”Ÿæˆå¤±æ•—:', e);
                    Utils.hideLoading();
                    Utils.showMessage(`æˆªåœ–å¤±æ•—ï¼š${e.message}`, 'error');
                    return false;
                }
            }
        };

        // ========== é é¢æ ¸å¿ƒè®Šé‡ ==========
        let currentOrder = null; // ç•¶å‰è¨‚å–®æ•¸æ“š
        let rideMap = null; // Mapboxåœ°åœ–å¯¦ä¾‹
        
        // è¨ˆè²»ç›¸é—œè®Šé‡
        let rideStarted = false;        // æ˜¯å¦é–‹å§‹ä¹˜è»Š
        let ridePaused = false;         // æ˜¯å¦æš«åœè¨ˆè²»
        let startTime = null;           // ä¹˜è»Šé–‹å§‹æ™‚é–“
        let pauseTime = null;           // æš«åœæ™‚é–“
        let totalPauseTime = 0;         // ç¸½æš«åœæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        let currentAmount = 0;          // ç•¶å‰é‡‘é¡
        let currentMileage = 0;         // ç•¶å‰é‡Œç¨‹
        let timerInterval = null;       // è¨ˆæ™‚å™¨
        
        // è¨ˆè²»è¦å‰‡
        const FARE_RULES = {
            startPrice: 80,             // èµ·æ­¥åƒ¹
            startMileage: 1,            // èµ·æ­¥é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰
            perKmPrice: 25,             // æ¯å…¬é‡Œåƒ¹æ ¼
            perMinutePrice: 2           // æ¯åˆ†é˜ç­‰å¾…è²»
        };

        // ========== DOM å…ƒç´ ç²å–ï¼ˆä½¿ç”¨Utilså®‰å…¨ç²å–ï¼‰ ==========
        const driverNameEl = Utils.safeGetElement('driver-name');
        const logoutBtn = Utils.safeGetElement('logout-btn');
        const orderIdEl = Utils.safeGetElement('order-id');
        const orderStatusEl = Utils.safeGetElement('order-status');
        const passengerNameEl = Utils.safeGetElement('passenger-name');
        const passengerPhoneEl = Utils.safeGetElement('passenger-phone');
        const pickupLocationEl = Utils.safeGetElement('pickup-location');
        const dropoffLocationEl = Utils.safeGetElement('dropoff-location');
        const arriveTimeEl = Utils.safeGetElement('arrive-time');
        const rideStartTimeEl = Utils.safeGetElement('ride-start-time');
        const currentAmountEl = Utils.safeGetElement('current-amount');
        const rideDurationEl = Utils.safeGetElement('ride-duration');
        const rideMileageEl = Utils.safeGetElement('ride-mileage');
        const startRideBtn = Utils.safeGetElement('start-ride-btn');
        const pauseRideBtn = Utils.safeGetElement('pause-ride-btn');
        const resumeRideBtn = Utils.safeGetElement('resume-ride-btn');
        const arriveDestinationBtn = Utils.safeGetElement('arrive-destination-btn');
        const screenshotBtn = Utils.safeGetElement('screenshot-btn');
        const closePageBtn = Utils.safeGetElement('close-page-btn');
        const meterPage = Utils.safeGetElement('meter-page');

        // ========== é é¢åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            // 1. é©—è­‰å¸æ©Ÿç™»éŒ„ç‹€æ…‹
            if (!Utils.Auth.checkDriverLoginStatus()) {
                Utils.Auth.redirectToDriverLogin();
                return;
            }

            // 2. è¨­ç½®å¸æ©Ÿåç¨±
            const loggedInDriver = Utils.Storage.get(Utils.Auth.DRIVER_KEYS.LOGGED_IN);
            if (driverNameEl && loggedInDriver) {
                driverNameEl.textContent = `æ‚¨å¥½ï¼Œ${loggedInDriver.name || 'å¸æ©Ÿ'}`;
            }

            // 3. è·å–URLä¸­çš„è¨‚å–®ID
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            
            // 4. åŠ è¼‰è¨‚å–®æ•¸æ“š
            currentOrder = Utils.loadOrderDataSafe(orderId);
            if (!currentOrder) return;

            // 5. æ¸²æŸ“è¨‚å–®åŸºæœ¬ä¿¡æ¯
            renderOrderInfo();
            
            // 6. åˆå§‹åŒ–è¡Œç¨‹åœ°åœ–
            initRideMap(currentOrder.pickup || 'æœªçŸ¥åœ°é»', currentOrder.dropoff || 'æœªçŸ¥åœ°é»');
            
            // 7. è¨­ç½®åˆå§‹é‡‘é¡ï¼ˆèµ·æ­¥åƒ¹ï¼‰
            currentAmount = FARE_RULES.startPrice;
            if (currentAmountEl) {
                currentAmountEl.textContent = currentAmount;
            }

            // 8. ç¶å®šäº‹ä»¶è™•ç†å™¨
            bindEventHandlers();
        });

        // ========== é é¢å‡½æ•¸ ==========
        /**
         * æ¸²æŸ“è¨‚å–®ä¿¡æ¯åˆ°é é¢
         */
        function renderOrderInfo() {
            try {
                if (orderIdEl) orderIdEl.textContent = currentOrder.id;
                if (passengerNameEl) passengerNameEl.textContent = currentOrder.passengerName || '-';
                if (passengerPhoneEl) passengerPhoneEl.textContent = currentOrder.passengerPhone || '-';
                if (pickupLocationEl) pickupLocationEl.textContent = currentOrder.pickup || '-';
                if (dropoffLocationEl) dropoffLocationEl.textContent = currentOrder.dropoff || '-';
                if (arriveTimeEl) arriveTimeEl.textContent = currentOrder.arriveTime || 'æœªè¨˜éŒ„';
                if (rideStartTimeEl) rideStartTimeEl.textContent = currentOrder.rideStartTime || 'æœªé–‹å§‹';
                
                // æ›´æ–°è¨‚å–®ç‹€æ…‹é¡¯ç¤º
                updateOrderStatusDisplay();
            } catch (e) {
                console.error('æ¸²æŸ“è¨‚å–®ä¿¡æ¯å¤±æ•—:', e);
                Utils.showMessage('æ¸²æŸ“è¨‚å–®ä¿¡æ¯å¤±æ•—', 'error');
            }
        }

        /**
         * åˆå§‹åŒ–è¡Œç¨‹åœ°åœ–
         */
        function initRideMap(pickupAddr, dropoffAddr) {
            try {
                const mapEl = Utils.safeGetElement('ride-map');
                if (!mapEl) return;
                
                // é»˜èªåæ¨™ï¼ˆå°åŒ—ï¼‰
                const pickup = [121.5654, 25.0330];
                const dropoff = [121.5700, 25.0400];

                // å‰µå»ºåœ°åœ–
                rideMap = new mapboxgl.Map({
                    container: mapEl,
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: pickup,
                    zoom: 14
                });

                // æ·»åŠ å°èˆªæ§ä»¶
                rideMap.addControl(new mapboxgl.NavigationControl(), 'top-right');

                // åœ°åœ–åŠ è¼‰å®Œæˆ
                rideMap.on('load', () => {
                    // ä¸Šè»Šé»æ¨™è¨˜
                    new mapboxgl.Marker({ color: '#00C300' })
                        .setLngLat(pickup)
                        .setPopup(new mapboxgl.Popup().setHTML(`<b>ä¸Šè»Šåœ°é»</b><br>${pickupAddr}`))
                        .addTo(rideMap)
                        .togglePopup();

                    // ä¸‹è»Šé»æ¨™è¨˜
                    new mapboxgl.Marker({ color: '#EF4444' })
                        .setLngLat(dropoff)
                        .setPopup(new mapboxgl.Popup().setHTML(`<b>ä¸‹è»Šåœ°é»</b><br>${dropoffAddr}`))
                        .addTo(rideMap);

                    // èª¿æ•´è¦–é‡
                    const bounds = new mapboxgl.LngLatBounds().extend(pickup).extend(dropoff);
                    rideMap.fitBounds(bounds, { padding: 50 });
                });
            } catch (e) {
                console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', e);
                Utils.showMessage('åœ°åœ–åŠ è¼‰å¤±æ•—ï¼Œä¸å½±éŸ¿è¨ˆè²»åŠŸèƒ½', 'warning');
            }
        }

        /**
         * æ›´æ–°è¨‚å–®ç‹€æ…‹é¡¯ç¤º
         */
        function updateOrderStatusDisplay() {
            if (!orderStatusEl) return;
            
            switch (currentOrder.status) {
                case 'arrived':
                    orderStatusEl.className = 'bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'å·²æŠµé”ä¸Šè»Šé»';
                    break;
                case 'riding':
                    orderStatusEl.className = 'bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'ä¹˜è»Šä¸­';
                    break;
                case 'completed':
                    orderStatusEl.className = 'bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'å·²å®Œæˆ';
                    break;
                default:
                    orderStatusEl.className = 'bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'æœªçŸ¥ç‹€æ…‹';
            }
        }

        /**
         * æ›´æ–°è¨ˆè²»é¡¯ç¤º
         */
        function updateMeterDisplay() {
            try {
                if (!rideStarted || ridePaused) return;
                
                // è¨ˆç®—å·²éæ™‚é–“ï¼ˆæ‰£é™¤æš«åœæ™‚é–“ï¼‰
                const now = new Date().getTime();
                const elapsedTime = now - startTime - totalPauseTime;
                const elapsedSeconds = Math.floor(elapsedTime / 1000);
                
                // æ›´æ–°æ™‚é•·é¡¯ç¤º
                if (rideDurationEl) {
                    rideDurationEl.textContent = Utils.formatTime(elapsedSeconds);
                }
                
                // æ¨¡æ“¬é‡Œç¨‹å¢é•·ï¼ˆæ¯10ç§’å¢åŠ 0.1å…¬é‡Œï¼‰
                if (elapsedSeconds % 10 === 0) {
                    currentMileage += 0.1;
                    if (rideMileageEl) {
                        rideMileageEl.textContent = `${currentMileage.toFixed(1)} KM`;
                    }
                    
                    // æ›´æ–°åœ°åœ–è¦–è§’ï¼ˆæ¨¡æ“¬ç§»å‹•ï¼‰
                    if (rideMap && rideStarted) {
                        const currentLng = 121.5654 + (currentMileage * 0.001);
                        const currentLat = 25.0330 + (currentMileage * 0.001);
                        rideMap.panTo([currentLng, currentLat]);
                        
                        // æ·»åŠ ç§»å‹•è»Œè·¡
                        if (rideMap.getSource('track')) {
                            const trackSource = rideMap.getSource('track');
                            const trackData = trackSource._data;
                            trackData.geometry.coordinates.push([currentLng, currentLat]);
                            trackSource.setData(trackData);
                        } else {
                            rideMap.addSource('track', {
                                type: 'geojson',
                                data: {
                                    type: 'Feature',
                                    geometry: {
                                        type: 'LineString',
                                        coordinates: [[121.5654, 25.0330], [currentLng, currentLat]]
                                    }
                                }
                            });
                            rideMap.addLayer({
                                id: 'track',
                                type: 'line',
                                source: 'track',
                                paint: {
                                    'line-color': '#3b82f6',
                                    'line-width': 4,
                                    'line-opacity': 0.7
                                }
                            });
                        }
                    }
                }
                
                // è¨ˆç®—ä¸¦æ›´æ–°é‡‘é¡
                currentAmount = Utils.calculateFareSafe(elapsedSeconds, currentMileage, FARE_RULES);
                if (currentAmountEl) {
                    currentAmountEl.textContent = currentAmount;
                }
            } catch (e) {
                console.error('æ›´æ–°è¨ˆè²»é¡¯ç¤ºå¤±æ•—:', e);
                // ä¸ä¸­æ–·è¨ˆæ™‚å™¨ï¼Œåƒ…è¨˜éŒ„éŒ¯èª¤
            }
        }

        /**
         * ç¶å®šé é¢äº‹ä»¶è™•ç†å™¨
         */
        function bindEventHandlers() {
            // é–‹å§‹ä¹˜è»Š
            if (startRideBtn) {
                startRideBtn.addEventListener('click', () => {
                    if (rideStarted) return;

                    if (confirm('ç¢ºèªé–‹å§‹ä¹˜è»Šï¼Ÿå°‡é–‹å§‹è¨ˆè²»ï¼')) {
                        // é¡¯ç¤ºæŒ‰éˆ•åŠ è¼‰
                        Utils.showLoading(startRideBtn, 'é–‹å§‹ä¸­...');
                        
                        setTimeout(() => {
                            try {
                                // æ›´æ–°è¨‚å–®ç‹€æ…‹
                                const orders = Utils.Storage.get('driverOrders') || [];
                                const orderIndex = orders.findIndex(order => order.id === currentOrder.id);
                                
                                if (orderIndex !== -1) {
                                    rideStarted = true;
                                    startTime = new Date().getTime();
                                    orders[orderIndex].status = 'riding';
                                    orders[orderIndex].rideStartTime = new Date().toLocaleString('zh-TW');
                                    Utils.Storage.set('driverOrders', orders, 48);
                                    
                                    // æ›´æ–°ç•¶å‰è¨‚å–®æ•¸æ“š
                                    currentOrder = orders[orderIndex];
                                    
                                    // æ›´æ–°é é¢é¡¯ç¤º
                                    if (rideStartTimeEl) {
                                        rideStartTimeEl.textContent = currentOrder.rideStartTime;
                                    }
                                    updateOrderStatusDisplay();
                                    Utils.showMessage('å·²é–‹å§‹ä¹˜è»Šï¼Œè¨ˆè²»ä¸­...', 'success');
                                    
                                    // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
                                    startRideBtn.classList.add('hidden');
                                    if (pauseRideBtn) pauseRideBtn.classList.remove('hidden');
                                    
                                    // å•Ÿå‹•è¨ˆæ™‚å™¨ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
                                    timerInterval = setInterval(updateMeterDisplay, 1000);
                                    updateMeterDisplay(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
                                }
                            } catch (e) {
                                console.error('é–‹å§‹ä¹˜è»Šå¤±æ•—:', e);
                                Utils.showMessage('é–‹å§‹ä¹˜è»Šå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                            } finally {
                                // éš±è—åŠ è¼‰ç‹€æ…‹
                                Utils.hideLoading(startRideBtn, '<i class="fa fa-play-circle"></i><span>é–‹å§‹ä¹˜è»Š</span>');
                            }
                        }, 800);
                    }
                });
            }

            // æš«åœè¨ˆè²»
            if (pauseRideBtn) {
                pauseRideBtn.addEventListener('click', () => {
                    if (!rideStarted || ridePaused) return;

                    ridePaused = true;
                    pauseTime = new Date().getTime();
                    
                    // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
                    pauseRideBtn.classList.add('hidden');
                    if (resumeRideBtn) resumeRideBtn.classList.remove('hidden');
                    
                    Utils.showMessage('å·²æš«åœè¨ˆè²»', 'success');
                });
            }

            // æ¢å¾©è¨ˆè²»
            if (resumeRideBtn) {
                resumeRideBtn.addEventListener('click', () => {
                    if (!rideStarted || !ridePaused) return;

                    const resumeTime = new Date().getTime();
                    totalPauseTime += resumeTime - pauseTime;
                    ridePaused = false;
                    
                    // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
                    resumeRideBtn.classList.add('hidden');
                    if (pauseRideBtn) pauseRideBtn.classList.remove('hidden');
                    
                    Utils.showMessage('å·²æ¢å¾©è¨ˆè²»', 'success');
                });
            }

            // æˆªåœ–ä¿å­˜åŠŸèƒ½
            if (screenshotBtn) {
                screenshotBtn.addEventListener('click', async () => {
                    await Utils.generateScreenshot(meterPage, currentOrder.id);
                });
            }

            // åˆ°é”ç›®çš„åœ°ï¼ˆçµæŸè¡Œç¨‹ï¼‰
            if (arriveDestinationBtn) {
                arriveDestinationBtn.addEventListener('click', () => {
                    if (!rideStarted) {
                        Utils.showMessage('å°šæœªé–‹å§‹ä¹˜è»Šï¼Œç„¡æ³•çµæŸè¡Œç¨‹ï¼', 'warning');
                        return;
                    }

                    if (confirm(`ç¢ºèªåˆ°é”ç›®çš„åœ°ï¼Ÿæœ€çµ‚è²»ç”¨ï¼šNT$ ${currentAmount}`)) {
                        // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
                        Utils.showLoading(arriveDestinationBtn, 'è™•ç†ä¸­...');
                        
                        setTimeout(() => {
                            try {
                                // åœæ­¢è¨ˆæ™‚å™¨
                                if (timerInterval) clearInterval(timerInterval);
                                
                                // è¨ˆç®—ç¸½è¡Œç¨‹æ™‚é–“
                                const endTime = new Date().getTime();
                                const totalRideTime = Math.floor((endTime - startTime - totalPauseTime) / 1000);
                                
                                // ä¿å­˜è¡Œç¨‹å®Œæˆæ•¸æ“š
                                const tripData = {
                                    rideEndTime: new Date().toLocaleString('zh-TW'),
                                    totalRideTime: Utils.formatTime(totalRideTime),
                                    totalMileage: currentMileage.toFixed(1),
                                    finalAmount: currentAmount
                                };
                                
                                const saveSuccess = Utils.saveTripCompletedData(currentOrder.id, tripData);
                                
                                if (saveSuccess) {
                                    Utils.showMessage(`è¡Œç¨‹çµæŸï¼æœ€çµ‚è²»ç”¨ï¼šNT$ ${currentAmount}`, 'success');
                                    
                                    // å»¶é²è·³è½‰åˆ°å®Œæˆé 
                                    setTimeout(() => {
                                        Utils.safeNavigate(
                                            `driver-complete.html?orderId=${currentOrder.id}&finalAmount=${currentAmount}`,
                                            'å³å°‡è·³è½‰åˆ°è¡Œç¨‹å®Œæˆé '
                                        );
                                    }, 1500);
                                }
                            } catch (e) {
                                console.error('çµæŸè¡Œç¨‹å¤±æ•—:', e);
                                Utils.showMessage('çµæŸè¡Œç¨‹å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¨˜éŒ„é‡‘é¡', 'error');
                            } finally {
                                // éš±è—åŠ è¼‰ç‹€æ…‹
                                Utils.hideLoading(arriveDestinationBtn, '<i class="fa fa-flag-checkered"></i><span>åˆ°é”ç›®çš„åœ°</span>');
                            }
                        }, 800);
                    }
                });
            }

            // é—œé–‰é é¢
            if (closePageBtn) {
                closePageBtn.addEventListener('click', () => {
                    if (confirm('ç¢ºèªé—œé–‰è¨ˆè²»é é¢ï¼Ÿå°‡è·³è½‰åˆ°è¡Œç¨‹å®Œæˆé ï¼')) {
                        // åœæ­¢è¨ˆæ™‚å™¨ï¼ˆå¦‚æœæ­£åœ¨è¨ˆæ™‚ï¼‰
                        if (timerInterval) clearInterval(timerInterval);
                        
                        // å®‰å…¨è·³è½‰
                        Utils.safeNavigate(
                            `driver-complete.html?orderId=${currentOrder.id}`,
                            'å³å°‡è·³è½‰åˆ°è¡Œç¨‹å®Œæˆé '
                        );
                    }
                });
            }

            // é€€å‡ºç™»éŒ„
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if (confirm('ç¢ºèªé€€å‡ºç™»éŒ„å—ï¼Ÿ')) {
                        // åœæ­¢è¨ˆæ™‚å™¨ï¼ˆå¦‚æœæ­£åœ¨è¨ˆæ™‚ï¼‰
                        if (timerInterval) clearInterval(timerInterval);
                        
                        Utils.Auth.driverLogout();
                    }
                });
            }
        }

        // é é¢é—œé–‰æ™‚åœæ­¢è¨ˆæ™‚å™¨
        window.addEventListener('beforeunload', () => {
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</head>
<body class="min-h-screen">
    <!-- é é ­ -->
    <header class="bg-green-600 text-white py-4 px-6 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <a href="javascript:history.back()" class="text-white hover:text-gray-100">
                    <i class="fa fa-arrow-left text-xl"></i>
                </a>
                <h1 class="text-xl font-bold">å¯¦æ™‚è¨ˆè²»ç³»çµ±</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="driver-name" class="hidden md:inline-block">æ‚¨å¥½ï¼Œå¸æ©Ÿ</span>
                <button id="logout-btn" class="bg-white text-green-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <i class="fa fa-sign-out"></i>
                    <span>é€€å‡ºç™»éŒ„</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="max-w-4xl mx-auto px-4 py-8" id="meter-page"> <!-- æ–°å¢IDç”¨æ–¼æˆªåœ– -->
        <!-- è¨‚å–®åŸºæœ¬ä¿¡æ¯ -->
        <div class="meter-card p-6 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">è¨‚å–®ç·¨è™Ÿï¼š<span id="order-id" class="text-green-600"></span></h2>
                    <p class="text-gray-600 mt-1">ä¹˜å®¢ï¼š<span id="passenger-name"></span> | è¯ç¹«é›»è©±ï¼š<span id="passenger-phone"></span></p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <span id="order-status" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        å·²æŠµé”ä¸Šè»Šé»
                    </span>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-600">ä¸Šè»Šåœ°é»ï¼š<span id="pickup-location"></span></p>
                    <p class="text-gray-600 mt-1">ä¸‹è»Šåœ°é»ï¼š<span id="dropoff-location"></span></p>
                </div>
                <div>
                    <p class="text-gray-600">æŠµé”æ™‚é–“ï¼š<span id="arrive-time"></span></p>
                    <p class="text-gray-600 mt-1">ä¹˜è»Šé–‹å§‹æ™‚é–“ï¼š<span id="ride-start-time" class="text-red-500">æœªé–‹å§‹</span></p>
                </div>
            </div>
            
            <!-- æ–°å¢è¡Œç¨‹åœ°åœ– -->
            <div class="mt-4">
                <p class="text-gray-600 mb-1">è¡Œç¨‹åœ°åœ–ï¼š</p>
                <div id="ride-map"></div>
            </div>
        </div>

        <!-- è¨ˆè²»æ ¸å¿ƒå€åŸŸ -->
        <div class="meter-card p-8 mb-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">å¯¦æ™‚è¨ˆè²»</h3>
            
            <!-- é‡‘é¡é¡¯ç¤º -->
            <div class="mb-6">
                <span class="amount-display" id="current-amount">0</span>
                <span class="text-xl text-gray-700 ml-2">NT$</span>
            </div>
            
            <!-- è¨ˆæ™‚å’Œé‡Œç¨‹ -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div>
                    <p class="text-gray-600 mb-2">ä¹˜è»Šæ™‚é•·</p>
                    <div class="time-display timer-animation" id="ride-duration">00:00:00</div>
                </div>
                <div>
                    <p class="text-gray-600 mb-2">è¡Œé§›é‡Œç¨‹</p>
                    <div class="mileage-display" id="ride-mileage">0.0 KM</div>
                </div>
            </div>
            
            <!-- è¨ˆè²»è¦å‰‡ -->
            <div class="text-left text-sm text-gray-500 mb-6">
                <p>ğŸ“‹ è¨ˆè²»è¦å‰‡ï¼šèµ·æ­¥åƒ¹ 80 NT$ (å‰1å…¬é‡Œ)ï¼Œä¹‹å¾Œæ¯å…¬é‡Œ 25 NT$ï¼Œæ¯åˆ†é˜ç­‰å¾…è²» 2 NT$</p>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex flex-wrap justify-center gap-4">
                <button id="start-ride-btn" class="btn-primary px-8 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-play-circle"></i>
                    <span>é–‹å§‹ä¹˜è»Š</span>
                </button>
                <button id="pause-ride-btn" class="btn-warning px-8 py-3 rounded-lg text-lg font-medium flex items-center gap-2 hidden">
                    <i class="fa fa-pause-circle"></i>
                    <span>æš«åœè¨ˆè²»</span>
                </button>
                <button id="resume-ride-btn" class="btn-warning px-8 py-3 rounded-lg text-lg font-medium flex items-center gap-2 hidden">
                    <i class="fa fa-play-circle"></i>
                    <span>æ¢å¾©è¨ˆè²»</span>
                </button>
            </div>
        </div>

        <!-- åˆ°é”ç›®çš„åœ°æ“ä½œ -->
        <div class="meter-card p-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">è¡Œç¨‹æ“ä½œ</h3>
            <div class="flex flex-wrap justify-center gap-4">
                <!-- æ–°å¢æˆªåœ–æŒ‰éˆ• -->
                <button id="screenshot-btn" class="btn-screenshot px-6 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-camera"></i>
                    <span>æˆªåœ–ä¿å­˜</span>
                </button>
                <!-- åˆ°é”ç›®çš„åœ°æŒ‰éˆ• -->
                <button id="arrive-destination-btn" class="btn-danger px-6 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-flag-checkered"></i>
                    <span>åˆ°é”ç›®çš„åœ°</span>
                </button>
                <!-- æ–°å¢é—œé–‰æŒ‰éˆ• -->
                <button id="close-page-btn" class="btn-close px-6 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-times-circle"></i>
                    <span>é—œé–‰é é¢</span>
                </button>
            </div>
        </div>
    </main>

    <!-- ç§»é™¤åŸæœ‰çš„toastå’Œloadingï¼Œæ”¹ç”¨Utilsçš„çµ±ä¸€æç¤º -->
</body>
</html>