<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>超管後台 - 車隊管理系統</title>
  <!-- 強制加載基礎樣式 + 修復輸入框核心樣式 -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background-color: #111827 !important; 
      color: white; 
      min-height: 100vh; 
      font-family: "Microsoft JhengHei", "PingFang SC", sans-serif;
    }
    /* 保底樣式：確保核心區域可見 */
    .sidebar { 
      width: 250px; 
      height: 100vh; 
      background: #1f2937; 
      position: fixed; 
      top: 0; 
      left: 0; 
      padding: 20px; 
      z-index: 100; 
      transition: all 0.3s ease;
    }
    .sidebar.sidebar-collapsed {
      width: 60px;
    }
    .main-content { 
      margin-left: 250px; 
      padding: 20px; 
      position: relative; 
      z-index: 10;
      transition: all 0.3s ease;
    }
    .main-content.main-content-expanded {
      margin-left: 60px;
    }
    .hidden { display: none !important; }
    .active { display: block !important; }
    .sidebar.show {
      transform: translateX(0);
    }

    /* 修復輸入框核心樣式（解決無法輸入關鍵） */
    .form-input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border: 1px solid #374151;
      border-radius: 0.5rem;
      background-color: #1f2937;
      color: #fff;
      outline: none;
      transition: all 0.2s;
      pointer-events: auto !important; /* 強制開啟鼠標交互 */
      position: relative;
      z-index: 10; /* 確保輸入框在最上層 */
      font-family: inherit;
    }
    .form-input:focus {
      border-color: #10b98180;
      box-shadow: 0 0 0 2px #10b98140;
      z-index: 11;
    }
    .form-input::placeholder {
      color: #9ca3af;
    }
    .form-input:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    /* 按鈕樣式補全 */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
      font-weight: 500;
      cursor: pointer;
      border: none;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-primary {
      background-color: #10b981;
      color: white;
    }
    .btn-primary:hover {
      background-color: #059669;
    }
    .btn-success {
      background-color: #10b981;
      color: white;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }
    .btn-danger {
      background-color: #ef4444;
      color: white;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }
    .btn-outline {
      border: 1px solid #374151;
      background-color: #1f2937;
      color: white;
    }
    .btn-outline:hover {
      background-color: #374151;
    }
    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    /* 模態框樣式補全 */
    .modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      backdrop-filter: blur(4px);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background-color: #1f2937;
      border-radius: 0.75rem;
      width: 100%;
      max-width: 500px;
      z-index: 1001;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    .modal.show .modal-content {
      transform: translateY(0);
    }
    /* 表格樣式補全 */
    .table-cell {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #374151;
      vertical-align: middle;
    }
    /* 狀態標籤樣式 */
    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      display: inline-block;
    }
    .status-active {
      background-color: #10b98130;
      color: #10b981;
    }
    .status-suspended {
      background-color: #ef444430;
      color: #ef4444;
    }
    .status-pending {
      background-color: #f59e0b30;
      color: #f59e0b;
    }
    /* 加載狀態樣式 */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .loading-spinner {
      background-color: #1f2937;
      padding: 1.5rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    /* 響應式調整 */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.show {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .main-content.main-content-expanded {
        margin-left: 0;
      }
    }
    @media (max-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      .table-cell {
        padding: 0.5rem 0.75rem;
      }
    }
  </style>
  <!-- Tailwind 保底加載（僅作補充，核心樣式已自定義） -->
  <script src="https://cdn.tailwindcss.com" onerror="console.log('Tailwind CDN加載失敗，使用保底樣式')"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" onerror="console.log('FontAwesome CDN加載失敗')">
  
  <!-- Firebase 完全註釋（先確保畫面顯示，後續再開啟） -->
  <!-- 
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDBqRxJ076PqVsDNLPG3Ewe5QvG71rDi5w",
      authDomain: "liffridesharingadministrator.firebaseapp.com",
      databaseURL: "https://liffridesharingadministrator-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "liffridesharingadministrator",
      storageBucket: "liffridesharingadministrator.firebasestorage.app",
      messagingSenderId: "920269222684",
      appId: "1:920269222684:web:e7c5beb2cb9ef4a6ef40d9",
      measurementId: "G-69BPH0DVM9"
    };
    try {
      const app = firebase.initializeApp(firebaseConfig);
      window.firebaseDb = firebase.database(app);
    } catch (e) { console.error('Firebase錯誤：', e); }
  </script>
  -->
</head>
<body>
  <!-- 通用工具類加載層 -->
  <div class="loading-overlay" id="global-loading">
    <div class="loading-spinner">
      <i class="fa fa-spinner fa-spin text-xl text-green-500"></i>
      <span>系統加載中...</span>
    </div>
  </div>

  <!-- 左側側邊欄（強制可見） -->
  <div class="sidebar bg-gray-800">
    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
      <div class="flex items-center space-x-3 sidebar-logo">
        <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center">
          <i class="fa fa-shield"></i>
        </div>
        <h1 class="text-lg font-bold">超管後台</h1>
      </div>
      <button id="toggle-sidebar" class="text-gray-400 hover:text-white lg:block hidden">
        <i class="fa fa-bars"></i>
      </button>
    </div>

    <div class="p-4 border-b border-gray-700">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center">
          <i class="fa fa-user text-gray-400"></i>
        </div>
        <div>
          <p class="text-sm font-medium" id="current-admin">超級管理員</p>
          <p class="text-xs text-gray-400">超管模式</p>
        </div>
      </div>
    </div>

    <nav class="py-4">
      <ul class="space-y-1">
        <li>
          <button class="nav-link w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors active" data-page="dashboard">
            <i class="fa fa-home w-6 text-center"></i>
            <span class="ml-2 sidebar-text">首頁</span>
          </button>
        </li>
        <li>
          <button class="nav-link w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors" data-page="audit">
            <i class="fa fa-user-plus w-6 text-center"></i>
            <span class="ml-2 sidebar-text">車隊管理員審核</span>
          </button>
        </li>
        <li>
          <button class="nav-link w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors" data-page="manage">
            <i class="fa fa-users w-6 text-center"></i>
            <span class="ml-2 sidebar-text">車隊管理員管理</span>
          </button>
        </li>
        <li>
          <button class="nav-link w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors" data-page="payment">
            <i class="fa fa-credit-card w-6 text-center"></i>
            <span class="ml-2 sidebar-text">繳費紀錄查看</span>
          </button>
        </li>
        <li>
          <button id="logout-btn" class="nav-link w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
            <i class="fa fa-sign-out w-6 text-center"></i>
            <span class="ml-2 sidebar-text">登出系統</span>
          </button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- 主要內容區（強制可見） -->
  <div class="main-content">
    <header class="bg-gray-800 shadow-sm sticky top-0 z-30 border-b border-gray-700 p-4">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <button id="mobile-menu-btn" class="text-gray-400 hover:text-white lg:hidden block">
          <i class="fa fa-bars text-xl"></i>
        </button>
        <h2 class="text-xl font-semibold" id="page-title">首頁</h2>
        <div>
          <span class="text-sm text-gray-400" id="current-time"></span>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <!-- 1. 首頁 - 租金/銀行設定 -->
      <div class="page-content active" id="dashboard-page">
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">系統設定</h3>
          <p class="text-gray-400 text-sm">租金金額與銀行帳戶設定</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h4 class="text-md font-semibold mb-4 pb-2 border-b border-gray-700">
              <i class="fa fa-money text-green-500 mr-2"></i>租金金額設定
            </h4>
            <form id="rent-setting-form" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-1">月繳金額</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-0">NT$</span>
                    <input type="number" id="monthly-rent" class="form-input pl-10" placeholder="0" min="0" required>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-1">季繳金額</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-0">NT$</span>
                    <input type="number" id="quarterly-rent" class="form-input pl-10" placeholder="0" min="0" required>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-1">半年繳金額</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-0">NT$</span>
                    <input type="number" id="halfyear-rent" class="form-input pl-10" placeholder="0" min="0" required>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-1">年繳金額</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-0">NT$</span>
                    <input type="number" id="yearly-rent" class="form-input pl-10" placeholder="0" min="0" required>
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-full mt-2">
                <i class="fa fa-save mr-2"></i>儲存租金設定
              </button>
            </form>
          </div>

          <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h4 class="text-md font-semibold mb-4 pb-2 border-b border-gray-700">
              <i class="fa fa-bank text-green-500 mr-2"></i>銀行帳戶設定
            </h4>
            <form id="bank-setting-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">銀行名稱</label>
                <input type="text" id="bank-name" class="form-input" placeholder="例如：台灣銀行" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">分行名稱</label>
                <input type="text" id="bank-branch" class="form-input" placeholder="例如：台北車站分行" required>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-1">戶名</label>
                  <input type="text" id="bank-holder" class="form-input" placeholder="請輸入戶名" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-1">帳號</label>
                  <input type="text" id="bank-account" class="form-input" placeholder="請輸入銀行帳號" required>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-full mt-2">
                <i class="fa fa-save mr-2"></i>儲存銀行設定
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- 2. 車隊管理員審核 -->
      <div class="page-content hidden" id="audit-page">
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">車隊管理員審核</h3>
          <p class="text-gray-400 text-sm">審核透過register.html提交的管理員申請</p>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-700">
                <tr>
                  <th class="table-cell text-left font-semibold">申請ID</th>
                  <th class="table-cell text-left font-semibold">車隊名稱</th>
                  <th class="table-cell text-left font-semibold">申請人姓名</th>
                  <th class="table-cell text-left font-semibold">聯繫電話</th>
                  <th class="table-cell text-left font-semibold">申請時間</th>
                  <th class="table-cell text-center font-semibold">操作</th>
                </tr>
              </thead>
              <tbody id="audit-list-body" class="divide-y divide-gray-700">
                <tr class="text-center text-gray-400">
                  <td colspan="6" class="table-cell py-8">
                    <i class="fa fa-inbox text-2xl mb-3"></i>
                    <p>暫無待審核申請</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 3. 車隊管理員管理 -->
      <div class="page-content hidden" id="manage-page">
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">車隊管理員管理</h3>
          <p class="text-gray-400 text-sm">管理已通過審核的車隊管理員</p>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-700">
                <tr>
                  <th class="table-cell text-left font-semibold">車隊ID</th>
                  <th class="table-cell text-left font-semibold">車隊名稱</th>
                  <th class="table-cell text-left font-semibold">管理員姓名</th>
                  <th class="table-cell text-left font-semibold">聯繫電話</th>
                  <th class="table-cell text-left font-semibold">狀態</th>
                  <th class="table-cell text-center font-semibold">操作</th>
                </tr>
              </thead>
              <tbody id="manager-list-body" class="divide-y divide-gray-700">
                <tr class="text-center text-gray-400">
                  <td colspan="6" class="table-cell py-8">
                    <i class="fa fa-users text-2xl mb-3"></i>
                    <p>暫無車隊管理員數據</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 4. 繳費紀錄查看 -->
      <div class="page-content hidden" id="payment-page">
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">繳費紀錄查看</h3>
          <p class="text-gray-400 text-sm">所有車隊的繳費紀錄查詢</p>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">車隊名稱</label>
              <select id="payment-fleet-filter" class="form-input">
                <option value="">全部車隊</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">繳費類型</label>
              <select id="payment-type-filter" class="form-input">
                <option value="">全部類型</option>
                <option value="monthly">月繳</option>
                <option value="quarterly">季繳</option>
                <option value="halfyear">半年繳</option>
                <option value="yearly">年繳</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">繳費狀態</label>
              <select id="payment-status-filter" class="form-input">
                <option value="">全部狀態</option>
                <option value="paid">已繳費</option>
                <option value="unpaid">未繳費</option>
                <option value="overdue">逾期</option>
              </select>
            </div>
          </div>
          <div class="mt-4 flex justify-end">
            <button id="filter-payment-btn" class="btn btn-outline mr-2">
              <i class="fa fa-filter mr-2"></i>查詢
            </button>
            <button id="export-payment-btn" class="btn btn-primary">
              <i class="fa fa-download mr-2"></i>匯出紀錄
            </button>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-700">
                <tr>
                  <th class="table-cell text-left font-semibold">紀錄ID</th>
                  <th class="table-cell text-left font-semibold">車隊ID</th>
                  <th class="table-cell text-left font-semibold">車隊名稱</th>
                  <th class="table-cell text-left font-semibold">繳費金額</th>
                  <th class="table-cell text-left font-semibold">繳費類型</th>
                  <th class="table-cell text-left font-semibold">繳費日期</th>
                  <th class="table-cell text-left font-semibold">繳費狀態</th>
                </tr>
              </thead>
              <tbody id="payment-list-body" class="divide-y divide-gray-700">
                <tr class="text-center text-gray-400">
                  <td colspan="7" class="table-cell py-8">
                    <i class="fa fa-credit-card text-2xl mb-3"></i>
                    <p>暫無繳費紀錄</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 彈窗區域 -->
  <div id="detail-modal" class="modal hidden">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">車隊管理員詳細資訊</h3>
        <button class="close-modal text-gray-400 hover:text-white">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      <div id="detail-content" class="space-y-4"></div>
      <div class="mt-6 flex justify-end">
        <button class="btn btn-outline close-modal">
          <i class="fa fa-times mr-2"></i>關閉
        </button>
      </div>
    </div>
  </div>

  <div id="status-modal" class="modal hidden">
    <div class="modal-content p-6 max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold" id="status-modal-title">變更狀態</h3>
        <button class="close-modal text-gray-400 hover:text-white">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      <p id="status-modal-message" class="text-gray-300 mb-6">確定要變更此管理員的狀態嗎？</p>
      <div class="flex gap-3">
        <button id="confirm-status-btn" class="btn btn-primary flex-1">
          <i class="fa fa-check mr-2"></i>確認
        </button>
        <button class="btn btn-outline flex-1 close-modal">
          <i class="fa fa-times mr-2"></i>取消
        </button>
      </div>
    </div>
  </div>

  <div id="alert-modal" class="modal hidden">
    <div class="modal-content p-6 max-w-sm">
      <div class="text-center mb-4">
        <i id="alert-icon" class="fa fa-info-circle text-4xl mb-3 text-green-500"></i>
        <h3 id="alert-title" class="text-lg font-semibold"></h3>
      </div>
      <p id="alert-message" class="text-gray-300 mb-4 text-center"></p>
      <button id="alert-confirm-btn" class="btn btn-primary w-full">
        確定
      </button>
    </div>
  </div>

  <!-- 完整JS程式碼 -->
  <script>
    /**
     * 全局工具類 - 提升超管後台系統穩定性
     */
    const Utils = {
      // ========== 基礎工具方法 ==========
      safeParseJSON(str) {
        try {
          return str && str !== 'null' && str !== 'undefined' ? JSON.parse(str) : null;
        } catch (e) {
          console.error('JSON解析失敗:', e, '原始字串:', str);
          return null;
        }
      },

      safeGetElement(id) {
        const el = document.getElementById(id);
        if (!el) console.warn(`[Utils] 元素#${id}不存在`);
        return el;
      },

      isEmpty(value) {
        return value === null || value === undefined || (typeof value === 'string' && value.trim() === '');
      },

      // ========== 本地存儲管理（帶過期機制） ==========
      Storage: {
        set(key, data, expireHours = 24) {
          try {
            const value = typeof data === 'string' ? data : JSON.stringify(data);
            localStorage.setItem(key, value);
            
            if (expireHours) {
              const expireTime = Date.now() + expireHours * 60 * 60 * 1000;
              localStorage.setItem(`${key}_expire`, expireTime);
            }
          } catch (e) {
            console.error('[Storage] 儲存失敗:', e);
            Utils.showAlert('錯誤', '本地存儲空間不足，無法保存數據！', 'error');
          }
        },

        get(key) {
          try {
            const expireTime = localStorage.getItem(`${key}_expire`);
            if (expireTime && Date.now() > Number(expireTime)) {
              this.remove(key);
              return null;
            }
            
            const value = localStorage.getItem(key);
            return value;
          } catch (e) {
            console.error('[Storage] 讀取失敗:', e);
            return null;
          }
        },

        remove(key) {
          try {
            localStorage.removeItem(key);
            localStorage.removeItem(`${key}_expire`);
          } catch (e) {
            console.error('[Storage] 移除失敗:', e);
          }
        },

        clearAllAdminData() {
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.includes('admin') || key.includes('fleet') || key.includes('rent') || key.includes('bank') || key.includes('payment')) {
              this.remove(key);
            }
          });
        }
      },

      // ========== UI增強方法 ==========
      showLoading(message = '處理中...') {
        const loadingEl = Utils.safeGetElement('global-loading');
        if (!loadingEl) return;
        
        const spinnerEl = loadingEl.querySelector('.loading-spinner span');
        if (spinnerEl) spinnerEl.textContent = message;
        
        loadingEl.classList.add('show');
        document.body.style.overflow = 'hidden';
      },

      hideLoading() {
        const loadingEl = Utils.safeGetElement('global-loading');
        if (!loadingEl) return;
        
        loadingEl.classList.remove('show');
        document.body.style.overflow = '';
      },

      showAlert(title, message, type = 'info') {
        const alertModal = Utils.safeGetElement('alert-modal');
        const alertIcon = Utils.safeGetElement('alert-icon');
        const alertTitle = Utils.safeGetElement('alert-title');
        const alertMessage = Utils.safeGetElement('alert-message');
        
        if (!alertModal || !alertIcon || !alertTitle || !alertMessage) return;
        
        const iconMap = {
          success: 'fa-check-circle text-green-500',
          error: 'fa-exclamation-circle text-red-500',
          warning: 'fa-exclamation-triangle text-yellow-500',
          info: 'fa-info-circle text-blue-500'
        };
        
        alertIcon.className = `fa ${iconMap[type] || iconMap.info} text-4xl mb-3`;
        alertTitle.textContent = title;
        alertMessage.innerHTML = message;
        
        alertModal.classList.remove('hidden');
        setTimeout(() => alertModal.classList.add('show'), 10);
      },

      openModal(modalId) {
        const modal = Utils.safeGetElement(modalId);
        if (!modal) return;
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('show'), 10);
        document.body.style.overflow = 'hidden';
      },

      closeModal(modalId) {
        const modal = Utils.safeGetElement(modalId);
        if (!modal) return;
        
        modal.classList.remove('show');
        setTimeout(() => modal.classList.add('hidden'), 300);
        document.body.style.overflow = '';
      },

      closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.classList.remove('show');
          setTimeout(() => modal.classList.add('hidden'), 300);
        });
        document.body.style.overflow = '';
        window.currentManagerId = undefined;
        window.currentStatusAction = undefined;
      },

      disableButton(button, text = '處理中...') {
        if (!button) return;
        
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i>${text}`;
        button.dataset.originalText = originalText;
        
        return originalText;
      },

      enableButton(button) {
        if (!button) return;
        
        button.disabled = false;
        const originalText = button.dataset.originalText || button.innerHTML;
        button.innerHTML = originalText;
      },

      // ========== 表單驗證 ==========
      validateForm(fields) {
        for (const field of fields) {
          const { element, validator, errorMessage } = field;
          
          if (!element) continue;
          
          const value = element.value.trim();
          
          if (validator && !validator(value)) {
            Utils.showAlert('驗證失敗', errorMessage, 'warning');
            element.focus();
            return false;
          }
        }
        
        return true;
      },

      // ========== 防止重複提交 ==========
      preventDoubleSubmit(button, submitHandler) {
        let isSubmitting = false;
        
        return async function() {
          if (isSubmitting) return;
          
          isSubmitting = true;
          const originalText = Utils.disableButton(button);
          Utils.showLoading('處理中，請稍候...');
          
          try {
            await submitHandler();
          } catch (error) {
            console.error('提交失敗:', error);
            Utils.showAlert('錯誤', '系統錯誤，請稍後再試', 'error');
          } finally {
            isSubmitting = false;
            Utils.enableButton(button, originalText);
            Utils.hideLoading();
          }
        };
      },

      // ========== 強制跳轉方法（解決登出跳轉問題） ==========
      forceRedirect(url) {
        // 方法1：標準跳轉
        window.location.href = url;
        
        // 備用方案：如果上面失敗，使用replace跳轉
        setTimeout(() => {
          if (window.location.href.indexOf(url) === -1) {
            window.location.replace(url);
          }
        }, 500);
        
        // 最終備用：使用HTML鏈接模擬點擊
        setTimeout(() => {
          if (window.location.href.indexOf(url) === -1) {
            const link = document.createElement('a');
            link.href = url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        }, 1000);
      }
    };

    // ========== 全局配置 ==========
    const CONFIG = {
      LOGGED_KEY: 'superAdminLoggedIn',
      REGISTER_KEY: 'fleetAdminRegistrations',
      MANAGERS_KEY: 'approvedFleetManagers',
      RENT_SETTING_KEY: 'rentSettings',
      BANK_SETTING_KEY: 'bankSettings',
      PAYMENT_KEY: 'paymentRecords',
      LOGIN_PAGE: 'administrator-login.html', // 登出目標頁面
      SESSION_EXPIRE_HOURS: 8
    };

    // ========== 頁面初始化 ==========
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // 顯示加載狀態
        Utils.showLoading('系統初始化中...');
        
        // 強制設置登入狀態
        Utils.Storage.set(CONFIG.LOGGED_KEY, 'true', CONFIG.SESSION_EXPIRE_HOURS);
        Utils.Storage.set('currentAdmin', '超級管理員', CONFIG.SESSION_EXPIRE_HOURS);

        // 基礎初始化
        initCurrentAdminInfo();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // 加載數據
        await Promise.all([
          loadRentSettings(),
          loadBankSettings(),
          loadAuditList(),
          loadManagerList(),
          loadPaymentRecords(),
          loadFleetFilterOptions()
        ]);

        // 綁定事件
        bindNavEvents();
        bindSidebarToggle();
        bindFormEvents();
        bindModalEvents();
        bindLogoutEvent(); // 優先綁定登出事件
        bindFilterEvents();

        // 強制聚焦測試
        setTimeout(() => {
          const testInput = Utils.safeGetElement('monthly-rent');
          if (testInput) {
            testInput.focus();
            console.log('✅ 輸入框已可聚焦，交互正常');
          }
        }, 500);

        console.log("✅ 超管後台初始化完成");
      } catch (error) {
        // 錯誤處理
        document.body.innerHTML = `
          <div style="padding: 30px; background: #111827; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <i class="fa fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
            <h2 style="color: white; font-size: 1.5rem; margin-bottom: 1rem;">系統初始化失敗</h2>
            <p style="color: #9ca3af; margin-bottom: 2rem; text-align: center; max-width: 500px;">
              錯誤信息：${error.message.substring(0, 100)}...
            </p>
            <button onclick="location.reload()" style="padding: 0.75rem 2rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem;">
              <i class="fa fa-refresh mr-2"></i>重新加載頁面
            </button>
          </div>
        `;
        console.error('❌ 超管後台初始化錯誤：', error);
      } finally {
        // 隱藏加載狀態
        Utils.hideLoading();
      }
    });

    // ========== 基礎功能函數 ==========
    function initCurrentAdminInfo() {
      const currentAdmin = Utils.Storage.get('currentAdmin') || '超級管理員';
      const el = Utils.safeGetElement('current-admin');
      if (el) el.textContent = currentAdmin;
    }

    function updateCurrentTime() {
      const now = new Date();
      const el = Utils.safeGetElement('current-time');
      if (el) el.textContent = now.toLocaleString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function bindNavEvents() {
      const navLinks = document.querySelectorAll('.nav-link[data-page]');
      const pageContents = document.querySelectorAll('.page-content');
      const pageTitle = Utils.safeGetElement('page-title');

      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // 更新導航狀態
          navLinks.forEach(l => {
            l.classList.remove('active', 'bg-gray-700', 'text-white');
          });
          link.classList.add('active', 'bg-gray-700', 'text-white');

          // 切換頁面內容
          const pageId = link.getAttribute('data-page');
          pageContents.forEach(content => {
            content.classList.add('hidden');
            content.classList.remove('active');
          });

          const targetPage = Utils.safeGetElement(`${pageId}-page`);
          if (targetPage) {
            targetPage.classList.remove('hidden');
            targetPage.classList.add('active');
            
            // 更新頁面標題
            const titles = {
              dashboard: '首頁',
              audit: '車隊管理員審核',
              manage: '車隊管理員管理',
              payment: '繳費紀錄查看'
            };
            if (pageTitle) pageTitle.textContent = titles[pageId] || '首頁';
          }

          // 移動端關閉側邊欄
          if (window.innerWidth < 1024) {
            document.querySelector('.sidebar').classList.remove('show');
          }
        });
      });
    }

    function bindSidebarToggle() {
      const toggleBtn = Utils.safeGetElement('toggle-sidebar');
      const sidebar = document.querySelector('.sidebar');
      const mainContent = document.querySelector('.main-content');
      const sidebarTexts = document.querySelectorAll('.sidebar-text');
      const sidebarLogo = document.querySelector('.sidebar-logo h1');
      const mobileMenuBtn = Utils.safeGetElement('mobile-menu-btn');

      if (toggleBtn) {
        toggleBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          sidebar.classList.toggle('sidebar-collapsed');
          mainContent.classList.toggle('main-content-expanded');
          sidebarTexts.forEach(text => text.classList.toggle('hidden'));
          if (sidebarLogo) sidebarLogo.classList.toggle('hidden');
        });
      }

      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          sidebar.classList.toggle('show');
        });
      }

      // 點擊主內容區關閉移動端側邊欄
      mainContent.addEventListener('click', () => {
        if (window.innerWidth < 1024) {
          sidebar.classList.remove('show');
        }
      });
    }

    function bindFormEvents() {
      const rentForm = Utils.safeGetElement('rent-setting-form');
      const bankForm = Utils.safeGetElement('bank-setting-form');

      // 租金設定表單
      if (rentForm) {
        rentForm.addEventListener('submit', Utils.preventDoubleSubmit(rentForm.querySelector('button'), async () => {
          // 表單驗證
          const isValid = Utils.validateForm([
            { element: Utils.safeGetElement('monthly-rent'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入月繳金額' },
            { element: Utils.safeGetElement('quarterly-rent'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入季繳金額' },
            { element: Utils.safeGetElement('halfyear-rent'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入半年繳金額' },
            { element: Utils.safeGetElement('yearly-rent'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入年繳金額' }
          ]);
          
          if (!isValid) return;

          // 保存數據
          const rentSettings = {
            monthly: Utils.safeGetElement('monthly-rent').value.trim(),
            quarterly: Utils.safeGetElement('quarterly-rent').value.trim(),
            halfyear: Utils.safeGetElement('halfyear-rent').value.trim(),
            yearly: Utils.safeGetElement('yearly-rent').value.trim(),
            updateTime: new Date().toLocaleString('zh-TW')
          };
          
          Utils.Storage.set(CONFIG.RENT_SETTING_KEY, rentSettings);
          Utils.showAlert('成功', '租金設定已儲存！', 'success');
          syncToDashboard();
        }));
      }

      // 銀行設定表單
      if (bankForm) {
        bankForm.addEventListener('submit', Utils.preventDoubleSubmit(bankForm.querySelector('button'), async () => {
          // 表單驗證
          const isValid = Utils.validateForm([
            { element: Utils.safeGetElement('bank-name'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入銀行名稱' },
            { element: Utils.safeGetElement('bank-branch'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入分行名稱' },
            { element: Utils.safeGetElement('bank-holder'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入戶名' },
            { element: Utils.safeGetElement('bank-account'), validator: v => !Utils.isEmpty(v), errorMessage: '請輸入銀行帳號' }
          ]);
          
          if (!isValid) return;

          // 保存數據
          const bankSettings = {
            name: Utils.safeGetElement('bank-name').value.trim(),
            branch: Utils.safeGetElement('bank-branch').value.trim(),
            holder: Utils.safeGetElement('bank-holder').value.trim(),
            account: Utils.safeGetElement('bank-account').value.trim(),
            updateTime: new Date().toLocaleString('zh-TW')
          };
          
          Utils.Storage.set(CONFIG.BANK_SETTING_KEY, bankSettings);
          Utils.showAlert('成功', '銀行設定已儲存！', 'success');
          syncToDashboard();
        }));
      }

      // 確保所有輸入框可交互
      document.querySelectorAll('.form-input').forEach(input => {
        // 阻止事件冒泡，確保輸入框可點擊
        input.addEventListener('click', (e) => {
          e.stopPropagation();
          input.focus();
        });
        
        // 確保輸入框可獲取焦點
        input.addEventListener('mousedown', (e) => {
          e.stopPropagation();
        });
        
        // 確保輸入框可輸入
        input.addEventListener('keydown', (e) => {
          e.stopPropagation();
        });
      });
    }

    function bindModalEvents() {
      // 關閉模態框按鈕
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          Utils.closeAllModals();
        });
      });

      // 提示框確認按鈕
      const alertBtn = Utils.safeGetElement('alert-confirm-btn');
      if (alertBtn) {
        alertBtn.addEventListener('click', () => Utils.closeModal('alert-modal'));
      }

      // 狀態變更確認按鈕
      const statusBtn = Utils.safeGetElement('confirm-status-btn');
      if (statusBtn) {
        statusBtn.addEventListener('click', Utils.preventDoubleSubmit(statusBtn, confirmStatusChange));
      }

      // 點擊模態框背景關閉
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) Utils.closeAllModals();
        });
      });

      // ESC鍵關閉模態框
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') Utils.closeAllModals();
      });
    }

    // ========== 登出功能增強（核心修改） ==========
    function bindLogoutEvent() {
      const logoutBtn = Utils.safeGetElement('logout-btn');
      if (!logoutBtn) return;

      // 移除所有舊的事件監聽器（防止重複綁定）
      const newLogoutBtn = logoutBtn.cloneNode(true);
      logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
      
      // 重新綁定登出事件
      newLogoutBtn.addEventListener('click', async (e) => {
        // 阻止事件冒泡和默認行為
        e.stopPropagation();
        e.preventDefault();
        
        // 確認登出
        if (!confirm('確定要登出超管後台嗎？')) return;
        
        try {
          // 顯示登出加載狀態
          Utils.showLoading('正在登出...');
          
          // 1. 清除所有相關存儲數據
          Utils.Storage.remove(CONFIG.LOGGED_KEY);
          Utils.Storage.remove('currentAdmin');
          Utils.Storage.clearAllAdminData();
          
          // 2. 清除sessionStorage
          sessionStorage.clear();
          
          // 3. 延遲確保數據清除完成
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // 4. 強制跳轉到登入頁（多重保障）
          Utils.forceRedirect(CONFIG.LOGIN_PAGE);
          
        } catch (error) {
          console.error('登出處理失敗:', error);
          Utils.hideLoading();
          // 即使出錯也強制跳轉
          Utils.forceRedirect(CONFIG.LOGIN_PAGE);
        }
      });
    }

    function bindFilterEvents() {
      const filterBtn = Utils.safeGetElement('filter-payment-btn');
      const exportBtn = Utils.safeGetElement('export-payment-btn');
      
      if (filterBtn) {
        filterBtn.addEventListener('click', Utils.preventDoubleSubmit(filterBtn, async () => {
          await loadPaymentRecords();
          Utils.showAlert('查詢完成', '已顯示符合條件的繳費紀錄', 'success');
        }));
      }
      
      if (exportBtn) {
        exportBtn.addEventListener('click', Utils.preventDoubleSubmit(exportBtn, exportPaymentRecords));
      }
    }

    // ========== 數據加載函數 ==========
    async function loadRentSettings() {
      try {
        const rentSettings = Utils.safeParseJSON(Utils.Storage.get(CONFIG.RENT_SETTING_KEY) || '{}');
        
        const fields = ['monthly', 'quarterly', 'halfyear', 'yearly'];
        fields.forEach(field => {
          const el = Utils.safeGetElement(`${field}-rent`);
          if (el && rentSettings[field]) el.value = rentSettings[field];
        });
      } catch (error) {
        console.error('加載租金設定失敗:', error);
        Utils.showAlert('警告', '無法加載租金設定，將使用默認值', 'warning');
      }
    }

    async function loadBankSettings() {
      try {
        const bankSettings = Utils.safeParseJSON(Utils.Storage.get(CONFIG.BANK_SETTING_KEY) || '{}');
        
        const fields = ['name', 'branch', 'holder', 'account'];
        fields.forEach(field => {
          const el = Utils.safeGetElement(`bank-${field}`);
          if (el && bankSettings[field]) el.value = bankSettings[field];
        });
      } catch (error) {
        console.error('加載銀行設定失敗:', error);
        Utils.showAlert('警告', '無法加載銀行設定，將使用默認值', 'warning');
      }
    }

    async function loadAuditList() {
      try {
        const registrations = Utils.safeParseJSON(Utils.Storage.get(CONFIG.REGISTER_KEY) || '[]') || [];
        const auditBody = Utils.safeGetElement('audit-list-body');
        
        if (!auditBody) return;
        
        if (registrations.length === 0) {
          auditBody.innerHTML = `
            <tr class="text-center text-gray-400">
              <td colspan="6" class="table-cell py-8">
                <i class="fa fa-inbox text-2xl mb-3"></i>
                <p>暫無待審核申請</p>
              </td>
            </tr>
          `;
          return;
        }
        
        auditBody.innerHTML = '';
        registrations.forEach((reg, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-700/50 transition-colors';
          tr.innerHTML = `
            <td class="table-cell font-mono text-sm">${reg.id || 'REG-' + (index + 1)}</td>
            <td class="table-cell">${reg.fleetName || '-'}</td>
            <td class="table-cell">${reg.name || '-'}</td>
            <td class="table-cell font-mono">${reg.phone || '-'}</td>
            <td class="table-cell text-sm text-gray-400">${reg.registerTime || '-'}</td>
            <td class="table-cell">
              <div class="flex justify-center gap-2">
                <button class="btn btn-success px-3 py-1.5 text-sm" data-index="${index}" data-action="approve">
                  <i class="fa fa-check mr-1"></i>通過
                </button>
                <button class="btn btn-danger px-3 py-1.5 text-sm" data-index="${index}" data-action="reject">
                  <i class="fa fa-times mr-1"></i>駁回
                </button>
              </div>
            </td>
          `;
          auditBody.appendChild(tr);
        });
        
        // 綁定審核按鈕事件
        document.querySelectorAll('[data-action="approve"], [data-action="reject"]').forEach(btn => {
          btn.addEventListener('click', handleAuditAction);
        });
      } catch (error) {
        console.error('加載審核列表失敗:', error);
        Utils.showAlert('錯誤', '無法加載審核列表數據', 'error');
      }
    }

    async function loadManagerList() {
      try {
        const managers = Utils.safeParseJSON(Utils.Storage.get(CONFIG.MANAGERS_KEY) || '[]') || [];
        const managerBody = Utils.safeGetElement('manager-list-body');
        
        if (!managerBody) return;
        
        if (managers.length === 0) {
          managerBody.innerHTML = `
            <tr class="text-center text-gray-400">
              <td colspan="6" class="table-cell py-8">
                <i class="fa fa-users text-2xl mb-3"></i>
                <p>暫無車隊管理員數據</p>
              </td>
            </tr>
          `;
          return;
        }
        
        managerBody.innerHTML = '';
        managers.forEach((manager, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-700/50 transition-colors';
          const statusClass = manager.status === '正常' ? 'status-active' : 'status-suspended';
          
          tr.innerHTML = `
            <td class="table-cell font-mono">${manager.fleetId || '-'}</td>
            <td class="table-cell">${manager.fleetName || '-'}</td>
            <td class="table-cell">${manager.name || '-'}</td>
            <td class="table-cell font-mono">${manager.phone || '-'}</td>
            <td class="table-cell">
              <span class="status-badge ${statusClass}">${manager.status || '-'}</span>
            </td>
            <td class="table-cell">
              <div class="flex justify-center gap-2">
                <button class="btn btn-outline px-3 py-1.5 text-sm" data-index="${index}" data-action="detail">
                  <i class="fa fa-info-circle mr-1"></i>詳細
                </button>
                <button class="btn ${manager.status === '正常' ? 'btn-danger' : 'btn-success'} px-3 py-1.5 text-sm" 
                  data-index="${index}" 
                  data-action="${manager.status === '正常' ? 'suspend' : 'activate'}">
                  <i class="fa fa-refresh mr-1"></i>${manager.status === '正常' ? '停權' : '恢復'}
                </button>
              </div>
            </td>
          `;
          managerBody.appendChild(tr);
        });
        
        // 綁定管理員操作按鈕事件
        document.querySelectorAll('[data-action="detail"], [data-action="suspend"], [data-action="activate"]').forEach(btn => {
          btn.addEventListener('click', handleManagerAction);
        });
      } catch (error) {
        console.error('加載管理員列表失敗:', error);
        Utils.showAlert('錯誤', '無法加載管理員列表數據', 'error');
      }
    }

    async function loadPaymentRecords() {
      try {
        const payments = Utils.safeParseJSON(Utils.Storage.get(CONFIG.PAYMENT_KEY) || '[]') || [];
        const paymentBody = Utils.safeGetElement('payment-list-body');
        
        if (!paymentBody) return;
        
        // 獲取過濾條件
        const fleetFilter = Utils.safeGetElement('payment-fleet-filter')?.value || '';
        const typeFilter = Utils.safeGetElement('payment-type-filter')?.value || '';
        const statusFilter = Utils.safeGetElement('payment-status-filter')?.value || '';
        
        // 應用過濾
        let filteredPayments = [...payments];
        if (fleetFilter) filteredPayments = filteredPayments.filter(p => p.fleetId === fleetFilter);
        if (typeFilter) filteredPayments = filteredPayments.filter(p => p.type === typeFilter);
        if (statusFilter) filteredPayments = filteredPayments.filter(p => p.status === statusFilter);
        
        if (filteredPayments.length === 0) {
          paymentBody.innerHTML = `
            <tr class="text-center text-gray-400">
              <td colspan="7" class="table-cell py-8">
                <i class="fa fa-credit-card text-2xl mb-3"></i>
                <p>暫無符合條件的繳費紀錄</p>
              </td>
            </tr>
          `;
          return;
        }
        
        paymentBody.innerHTML = '';
        filteredPayments.forEach((payment, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-700/50 transition-colors';
          
          // 狀態樣式
          let statusClass = '';
          let statusText = '';
          switch(payment.status) {
            case 'paid': statusClass = 'status-active'; statusText = '已繳費'; break;
            case 'unpaid': statusClass = 'status-pending'; statusText = '未繳費'; break;
            case 'overdue': statusClass = 'status-suspended'; statusText = '逾期'; break;
            default: statusClass = ''; statusText = payment.status || '未知';
          }
          
          // 繳費類型文字
          let typeText = '';
          switch(payment.type) {
            case 'monthly': typeText = '月繳'; break;
            case 'quarterly': typeText = '季繳'; break;
            case 'halfyear': typeText = '半年繳'; break;
            case 'yearly': typeText = '年繳'; break;
            default: typeText = payment.type || '未知';
          }
          
          tr.innerHTML = `
            <td class="table-cell font-mono text-sm">PAY-${payment.id || index + 1}</td>
            <td class="table-cell font-mono">${payment.fleetId || '-'}</td>
            <td class="table-cell">${payment.fleetName || '-'}</td>
            <td class="table-cell font-mono">NT$ ${payment.amount || 0}</td>
            <td class="table-cell">${typeText}</td>
            <td class="table-cell text-sm text-gray-400">${payment.payDate || '-'}</td>
            <td class="table-cell">
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
          `;
          paymentBody.appendChild(tr);
        });
      } catch (error) {
        console.error('加載繳費紀錄失敗:', error);
        Utils.showAlert('錯誤', '無法加載繳費紀錄數據', 'error');
      }
    }

    async function loadFleetFilterOptions() {
      try {
        const managers = Utils.safeParseJSON(Utils.Storage.get(CONFIG.MANAGERS_KEY) || '[]') || [];
        const fleetFilter = Utils.safeGetElement('payment-fleet-filter');
        
        if (!fleetFilter) return;
        
        // 清空並添加默認選項
        fleetFilter.innerHTML = '<option value="">全部車隊</option>';
        
        // 去重並添加車隊選項
        const fleets = [...new Map(managers.map(m => [m.fleetId, m])).values()];
        fleets.forEach(fleet => {
          if (fleet.fleetId) {
            const option = document.createElement('option');
            option.value = fleet.fleetId;
            option.textContent = `${fleet.fleetName || '未命名車隊'} (${fleet.fleetId})`;
            fleetFilter.appendChild(option);
          }
        });
      } catch (error) {
        console.error('加載車隊過濾選項失敗:', error);
      }
    }

    // ========== 業務操作函數 ==========
    async function handleAuditAction(e) {
      try {
        const btn = e.target.closest('button');
        const index = btn?.getAttribute('data-index');
        const action = btn?.getAttribute('data-action');
        
        if (index === null || action === null) return;
        
        const registrations = Utils.safeParseJSON(Utils.Storage.get(CONFIG.REGISTER_KEY) || '[]') || [];
        
        if (index >= 0 && index < registrations.length) {
          const reg = registrations[index];
          
          if (action === 'approve') {
            // 生成車隊ID和管理員帳號密碼
            const fleetId = Math.floor(10000 + Math.random() * 90000).toString();
            const account = reg.phone || 'admin_' + fleetId;
            const password = Math.random().toString(36).slice(-8);
            
            // 添加到已批准列表
            const managers = Utils.safeParseJSON(Utils.Storage.get(CONFIG.MANAGERS_KEY) || '[]') || [];
            managers.push({
              fleetId,
              fleetName: reg.fleetName,
              name: reg.name,
              phone: reg.phone,
              lineId: reg.lineId || '',
              email: reg.email || '',
              account,
              password,
              status: '正常',
              approveTime: new Date().toLocaleString('zh-TW'),
              registerData: reg
            });
            
            // 保存數據
            Utils.Storage.set(CONFIG.MANAGERS_KEY, managers);
            
            // 顯示成功提示
            Utils.showAlert(
              '審核通過', 
              `車隊ID：${fleetId}<br>管理員帳號：${account}<br>管理員密碼：${password}`, 
              'success'
            );
          } else if (action === 'reject') {
            Utils.showAlert('審核駁回', '該申請已被駁回', 'info');
          }
          
          // 移除該申請
          registrations.splice(index, 1);
          Utils.Storage.set(CONFIG.REGISTER_KEY, registrations);
          
          // 重新加載列表
          await Promise.all([
            loadAuditList(),
            loadManagerList(),
            loadFleetFilterOptions()
          ]);
          
          syncToDashboard();
        }
      } catch (error) {
        console.error('處理審核操作失敗:', error);
        Utils.showAlert('錯誤', '處理審核申請時發生錯誤', 'error');
      }
    }

    async function handleManagerAction(e) {
      try {
        const btn = e.target.closest('button');
        const index = btn?.getAttribute('data-index');
        const action = btn?.getAttribute('data-action');
        
        if (index === null || action === null) return;
        
        const managers = Utils.safeParseJSON(Utils.Storage.get(CONFIG.MANAGERS_KEY) || '[]') || [];
        
        if (index >= 0 && index < managers.length) {
          const manager = managers[index];
          
          if (action === 'detail') {
            // 打開詳細信息模態框
            openDetailModal(manager);
          } else if (action === 'suspend' || action === 'activate') {
            // 準備狀態變更
            window.currentManagerId = index;
            window.currentStatusAction = action;
            
            const newStatus = action === 'suspend' ? '停權' : '正常';
            const titleEl = Utils.safeGetElement('status-modal-title');
            const msgEl = Utils.safeGetElement('status-modal-message');
            
            if (titleEl) titleEl.textContent = `變更為${newStatus}狀態`;
            if (msgEl) msgEl.textContent = `確定要將【${manager.fleetName || '未命名車隊'} - ${manager.name || '未知'}】設定為${newStatus}狀態嗎？`;
            
            // 打開狀態變更模態框
            Utils.openModal('status-modal');
          }
        }
      } catch (error) {
        console.error('處理管理員操作失敗:', error);
        Utils.showAlert('錯誤', '處理管理員數據時發生錯誤', 'error');
      }
    }

    async function confirmStatusChange() {
      try {
        const index = window.currentManagerId;
        const action = window.currentStatusAction;
        
        if (index === undefined || action === undefined) return;
        
        const managers = Utils.safeParseJSON(Utils.Storage.get(CONFIG.MANAGERS_KEY) || '[]') || [];
        
        if (index >= 0 && index < managers.length) {
          // 更新狀態
          managers[index].status = action === 'suspend' ? '停權' : '正常';
          managers[index].statusUpdate
                    managers[index].statusUpdateTime = new Date().toLocaleString('zh-TW');
          
          // 保存更新後的數據
          Utils.Storage.set(CONFIG.MANAGERS_KEY, managers);
          
          // 重新加載列表
          await loadManagerList();
          
          // 關閉模態框並提示
          Utils.closeAllModals();
          const newStatus = action === 'suspend' ? '停權' : '正常';
          Utils.showAlert('操作成功', `車隊管理員狀態已變更為${newStatus}`, 'success');
          
          // 重置全局變量
          window.currentManagerId = undefined;
          window.currentStatusAction = undefined;
          
          syncToDashboard();
        }
      } catch (error) {
        console.error('確認狀態變更失敗:', error);
        Utils.showAlert('錯誤', '更新管理員狀態時發生錯誤', 'error');
      }
    }

    function openDetailModal(manager) {
      try {
        const detailContent = Utils.safeGetElement('detail-content');
        if (!detailContent) return;
        
        // 構建詳細信息HTML
        detailContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-400">車隊ID</p>
              <p class="font-mono">${manager.fleetId || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">車隊名稱</p>
              <p>${manager.fleetName || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">管理員姓名</p>
              <p>${manager.name || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">聯繫電話</p>
              <p class="font-mono">${manager.phone || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">LINE ID</p>
              <p>${manager.lineId || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">電子信箱</p>
              <p>${manager.email || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">管理員帳號</p>
              <p class="font-mono bg-gray-700 px-2 py-1 rounded">${manager.account || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">初始密碼</p>
              <p class="font-mono bg-gray-700 px-2 py-1 rounded">${manager.password || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">當前狀態</p>
              <span class="status-badge ${manager.status === '正常' ? 'status-active' : 'status-suspended'}">
                ${manager.status || '-'}
              </span>
            </div>
            <div>
              <p class="text-sm text-gray-400">狀態更新時間</p>
              <p class="text-sm text-gray-400">${manager.statusUpdateTime || '-'}</p>
            </div>
            <div class="md:col-span-2">
              <p class="text-sm text-gray-400">審核通過時間</p>
              <p class="text-sm text-gray-400">${manager.approveTime || '-'}</p>
            </div>
          </div>
        `;
        
        // 打開詳細模態框
        Utils.openModal('detail-modal');
      } catch (error) {
        console.error('打開詳細模態框失敗:', error);
        Utils.showAlert('錯誤', '加載管理員詳細信息失敗', 'error');
      }
    }

    async function exportPaymentRecords() {
      try {
        const payments = Utils.safeParseJSON(Utils.Storage.get(CONFIG.PAYMENT_KEY) || '[]') || [];
        
        if (payments.length === 0) {
          Utils.showAlert('提示', '暫無繳費紀錄可匯出', 'info');
          return;
        }
        
        // 構建CSV內容
        const headers = ['紀錄ID', '車隊ID', '車隊名稱', '繳費金額(NT$)', '繳費類型', '繳費日期', '繳費狀態'];
        const rows = [headers.join(',')];
        
        payments.forEach((payment, index) => {
          // 格式化數據
          const id = `PAY-${payment.id || index + 1}`;
          const fleetId = payment.fleetId || '';
          const fleetName = payment.fleetName ? `"${payment.fleetName.replace(/"/g, '""')}"` : '';
          const amount = payment.amount || 0;
          
          // 處理繳費類型
          let typeText = '';
          switch(payment.type) {
            case 'monthly': typeText = '月繳'; break;
            case 'quarterly': typeText = '季繳'; break;
            case 'halfyear': typeText = '半年繳'; break;
            case 'yearly': typeText = '年繳'; break;
            default: typeText = payment.type || '';
          }
          
          // 處理繳費狀態
          let statusText = '';
          switch(payment.status) {
            case 'paid': statusText = '已繳費'; break;
            case 'unpaid': statusText = '未繳費'; break;
            case 'overdue': statusText = '逾期'; break;
            default: statusText = payment.status || '';
          }
          
          const payDate = payment.payDate || '';
          rows.push([id, fleetId, fleetName, amount, typeText, payDate, statusText].join(','));
        });
        
        // 創建CSV文件並下載
        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = `車隊繳費紀錄_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // 清理資源
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
        Utils.showAlert('成功', '繳費紀錄已開始下載', 'success');
      } catch (error) {
        console.error('匯出繳費紀錄失敗:', error);
        Utils.showAlert('錯誤', '生成繳費紀錄文件時發生錯誤', 'error');
      }
    }

    function syncToDashboard() {
      // 同步首頁數據（例如顯示最新設定時間）
      try {
        const rentSettings = Utils.safeParseJSON(Utils.Storage.get(CONFIG.RENT_SETTING_KEY) || '{}');
        const bankSettings = Utils.safeParseJSON(Utils.Storage.get(CONFIG.BANK_SETTING_KEY) || '{}');
        
        // 可在首頁添加設定更新時間顯示（此處僅示範同步邏輯）
        console.log('✅ 數據已同步到首頁:', {
          rentLastUpdate: rentSettings.updateTime,
          bankLastUpdate: bankSettings.updateTime
        });
      } catch (error) {
        console.error('同步首頁數據失敗:', error);
      }
    }

    // ========== 異常處理增強 ==========
    // 捕獲全局錯誤，避免頁面崩潰
    window.addEventListener('error', (errorEvent) => {
      console.error('全局未捕獲錯誤:', errorEvent.error);
      
      // 僅在生產環境顯示用戶友好提示
      if (process?.env?.NODE_ENV !== 'development') {
        Utils.showAlert(
          '系統異常',
          '頁面發生未知錯誤，部分功能可能無法正常使用，建議重新登錄或聯繫技術支持',
          'error'
        );
      }
    });

    // 捕獲未處理的Promise拒絕
    window.addEventListener('unhandledrejection', (event) => {
      console.error('未處理的Promise拒絕:', event.reason);
      
      if (process?.env?.NODE_ENV !== 'development') {
        Utils.showAlert(
          '數據加載失敗',
          '部分數據加載異常，建議刷新頁面或稍後再試',
          'error'
        );
      }
    });
  </script>
</body>
</html>