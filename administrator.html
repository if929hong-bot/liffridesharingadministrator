<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>車隊管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#228B22',
            secondary: '#6c757d',
            danger: '#dc3545',
            success: '#198754',
            info: '#0dcaf0',
            dark-bg: '#1a1a1a' // 深色背景主色
          },
          boxShadow: {
            card: '0 4px 20px rgba(0, 0, 0, 0.2)',
            modal: '0 10px 25px rgba(0, 0, 0, 0.3)'
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .form-input {
        @apply w-full px-4 py-2.5 border border-gray-600 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-all;
      }
      .btn {
        @apply py-2 px-4 rounded-lg transition-all duration-200 font-medium;
      }
      .btn-primary {
        @apply bg-primary text-white hover:bg-primary/90 active:bg-primary/80;
      }
      .btn-danger {
        @apply bg-danger text-white hover:bg-danger/90 active:bg-danger/80;
      }
      .btn-success {
        @apply bg-success text-white hover:bg-success/90 active:bg-success/80;
      }
      .btn-info {
        @apply bg-info text-white hover:bg-info/90 active:bg-info/80;
      }
      .btn-outline {
        @apply border border-gray-600 bg-gray-800 text-white hover:bg-gray-700;
      }
      .table-cell {
        @apply px-4 py-3 border-b border-gray-700;
      }
      .modal {
        @apply fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4;
      }
      .modal-content {
        @apply bg-gray-800 text-white rounded-xl shadow-modal w-full max-w-md;
      }
      .tab-btn {
        @apply py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:text-primary transition-colors text-white;
      }
      .tab-btn-active {
        @apply border-primary text-primary;
      }
    }
  </style>
</head>
<body class="bg-dark-bg min-h-screen text-white">
  <!-- 頁頭 -->
  <header class="bg-gray-900 shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-primary">
        <i class="fa fa-building-o mr-2"></i>車隊管理後台
      </h1>
      <button id="logout-btn" class="btn btn-outline text-gray-300">
        <i class="fa fa-sign-out mr-1"></i>登出
      </button>
    </div>
  </header>

  <!-- 主要內容 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 功能標籤頁 -->
    <div class="border-b border-gray-800 mb-6">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn tab-btn-active" data-tab="fleet">
          <i class="fa fa-car mr-1"></i>車隊管理
        </button>
        <button class="tab-btn" data-tab="admin-audit">
          <i class="fa fa-user-plus mr-1"></i>管理員審核
        </button>
        <button class="tab-btn" data-tab="admin-manage">
          <i class="fa fa-users mr-1"></i>管理員管理
        </button>
        <button class="tab-btn" data-tab="driver-manage">
          <i class="fa fa-id-card mr-1"></i>司機管理
        </button>
        <button class="tab-btn" data-tab="rent-setting">
          <i class="fa fa-money mr-1"></i>租金及銀行設定
        </button>
      </div>
    </div>

    <!-- 車隊管理頁面 -->
    <div class="tab-content" data-tab="fleet">
      <!-- 功能按鈕區 -->
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="add-fleet-btn" class="btn btn-primary">
          <i class="fa fa-plus mr-1"></i>新增車隊
        </button>
        <button id="refresh-fleet-btn" class="btn btn-outline">
          <i class="fa fa-refresh mr-1"></i>刷新列表
        </button>
      </div>

      <!-- 車隊列表區 -->
      <div class="bg-gray-900 rounded-xl shadow-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="table-cell text-left">車隊ID</th>
                <th class="table-cell text-left">車隊名稱</th>
                <th class="table-cell text-left">車隊描述</th>
                <th class="table-cell text-center">操作</th>
              </tr>
            </thead>
            <tbody id="fleet-list-body">
              <tr class="text-center text-gray-400">
                <td colspan="4" class="table-cell">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 管理員審核頁面 -->
    <div class="tab-content hidden" data-tab="admin-audit">
      <div class="bg-gray-900 rounded-xl shadow-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="table-cell text-left">申請人姓名</th>
                <th class="table-cell text-left">電話</th>
                <th class="table-cell text-left">申請車隊</th>
                <th class="table-cell text-center">操作</th>
              </tr>
            </thead>
            <tbody id="admin-audit-body">
              <tr class="text-center text-gray-400">
                <td colspan="4" class="table-cell">暫無審核申請</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 管理員管理頁面 -->
    <div class="tab-content hidden" data-tab="admin-manage">
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="refresh-admin-btn" class="btn btn-outline">
          <i class="fa fa-refresh mr-1"></i>刷新列表
        </button>
      </div>
      <div class="bg-gray-900 rounded-xl shadow-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="table-cell text-left">車隊名稱</th>
                <th class="table-cell text-left">車隊ID</th>
                <th class="table-cell text-left">管理員姓名</th>
                <th class="table-cell text-left">電話</th>
                <th class="table-cell text-left">LINE ID</th>
                <th class="table-cell text-left">帳號</th>
                <th class="table-cell text-left">密碼</th>
                <th class="table-cell text-left">繳費日期</th>
                <th class="table-cell text-center">狀態</th>
                <th class="table-cell text-center">操作</th>
              </tr>
            </thead>
            <tbody id="admin-manage-body">
              <tr class="text-center text-gray-400">
                <td colspan="10" class="table-cell">暫無管理員數據</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 司機管理頁面 -->
    <div class="tab-content hidden" data-tab="driver-manage">
      <div class="bg-gray-900 rounded-xl shadow-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="table-cell text-left">司機姓名</th>
                <th class="table-cell text-left">電話</th>
                <th class="table-cell text-left">所屬車隊</th>
                <th class="table-cell text-center">狀態</th>
                <th class="table-cell text-center">操作</th>
              </tr>
            </thead>
            <tbody id="driver-manage-body">
              <tr class="text-center text-gray-400">
                <td colspan="5" class="table-cell">暫無司機數據</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 租金及銀行設定頁面 -->
    <div class="tab-content hidden" data-tab="rent-setting">
      <div class="bg-gray-900 rounded-xl shadow-card p-6">
        <form id="rent-setting-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">每月租金金額</label>
            <input type="number" id="monthly-rent" class="form-input" placeholder="輸入租金金額" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">銀行名稱</label>
            <input type="text" id="bank-name" class="form-input" placeholder="輸入銀行名稱" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">銀行帳號</label>
            <input type="text" id="bank-account" class="form-input" placeholder="輸入銀行帳號" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">戶名</label>
            <input type="text" id="bank-holder" class="form-input" placeholder="輸入戶名" required>
          </div>
          <button type="submit" class="btn btn-primary w-full">
            <i class="fa fa-save mr-1"></i>儲存設定
          </button>
        </form>
      </div>
    </div>
  </main>

  <!-- 新增車隊彈窗 -->
  <div id="add-fleet-modal" class="modal hidden">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium">新增車隊</h2>
        <button class="close-modal text-gray-400 hover:text-white">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <form id="add-fleet-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">車隊名稱（必填）</label>
          <input 
            type="text" 
            id="new-fleet-name" 
            class="form-input" 
            placeholder="輸入車隊名稱" 
            required
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">車隊描述（可選）</label>
          <textarea 
            id="new-fleet-desc" 
            class="form-input" 
            rows="2" 
            placeholder="輸入車隊描述"
          ></textarea>
        </div>
        <div class="flex gap-3 justify-end">
          <button type="button" class="close-modal btn btn-outline">取消</button>
          <button type="submit" class="btn btn-primary">確認新增</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 編輯車隊彈窗 -->
  <div id="edit-fleet-modal" class="modal hidden">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium">編輯車隊</h2>
        <button class="close-modal text-gray-400 hover:text-white">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <form id="edit-fleet-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">車隊ID（不可修改）</label>
          <input 
            type="text" 
            id="edit-fleet-id" 
            class="form-input" 
            readonly
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">車隊名稱（必填）</label>
          <input 
            type="text" 
            id="edit-fleet-name" 
            class="form-input" 
            placeholder="輸入車隊名稱" 
            required
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">車隊描述（可選）</label>
          <textarea 
            id="edit-fleet-desc" 
            class="form-input" 
            rows="2" 
            placeholder="輸入車隊描述"
          ></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn btn-info flex-1">確認修改</button>
          <button type="button" id="delete-fleet-btn" class="btn btn-danger flex-1">刪除車隊</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 管理員狀態操作彈窗 -->
  <div id="admin-status-modal" class="modal hidden">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium" id="status-modal-title">變更狀態</h2>
        <button class="close-modal text-gray-400 hover:text-white">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="mb-4">
        <p id="status-modal-desc" class="text-gray-300">確定要變更此管理員的狀態嗎？</p>
      </div>
      <div class="flex gap-3">
        <button type="button" class="close-modal btn btn-outline flex-1">取消</button>
        <button type="button" id="confirm-status-btn" class="btn btn-danger flex-1">確認停權</button>
      </div>
    </div>
  </div>

  <!-- 提示訊息彈窗（匹配截图样式） -->
  <div id="alert-modal" class="modal hidden">
    <div class="modal-content p-6 max-w-sm bg-white text-black">
      <div class="text-center mb-4">
        <i id="alert-icon" class="fa fa-info-circle text-3xl text-info mb-2"></i>
        <h3 class="text-lg font-medium" id="alert-title">提示</h3>
      </div>
      <p id="alert-message" class="text-gray-700 mb-4 text-center"></p>
      <button id="alert-confirm-btn" class="btn btn-primary w-full">確定</button>
    </div>
  </div>

  <script>
    // 全局常量
    const LOGGED_KEY = 'superAdminLoggedIn';
    const FLEETS_KEY = 'fleetList';
    const ADMIN_APPLY_KEY = 'fleetAdminApplications';
    const APPROVED_ADMINS_KEY = 'approvedFleetAdmins';
    const RENT_SETTING_KEY = 'rentAndBankSettings';
    const LOGIN_PAGE = 'administrator-login.html';

    // 當前狀態
    let currentEditFleetId = '';
    let currentAdminId = '';
    let currentAdminStatus = '';

    // 初始化頁面
    document.addEventListener('DOMContentLoaded', () => {
      // 驗證超管登錄狀態
      checkSuperAdminAuth();
      
      // 加載數據
      loadFleetList();
      loadAdminAuditList();
      loadApprovedAdmins();
      loadRentSettings();
      
      // 綁定事件
      bindEvents();
      bindTabEvents();
    });

    // 驗證超管登錄狀態（核心防護）
    function checkSuperAdminAuth() {
      const isLoggedIn = localStorage.getItem(LOGGED_KEY) === 'true';
      
      if (!isLoggedIn) {
        // 未授權訪問，強制跳轉登入頁
        window.location.href = LOGIN_PAGE;
        return;
      }
    }

    // 綁定標籤頁切換事件
    function bindTabEvents() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // 切換按鈕狀態
          document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('tab-btn-active'));
          btn.classList.add('tab-btn-active');
          
          // 切換內容
          const tabName = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
          document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.remove('hidden');
        });
      });
    }

    // 加載車隊列表（5位數隨機ID）
    function loadFleetList() {
      const fleetList = JSON.parse(localStorage.getItem(FLEETS_KEY) || '[]');
      const listBody = document.getElementById('fleet-list-body');
      
      listBody.innerHTML = '';
      
      if (fleetList.length === 0) {
        listBody.innerHTML = `
          <tr class="text-center text-gray-400">
            <td colspan="4" class="table-cell">暫無車隊數據，請點擊「新增車隊」創建</td>
          </tr>
        `;
        return;
      }
      
      fleetList.forEach(fleet => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="table-cell font-mono text-sm">${fleet.id}</td>
          <td class="table-cell">${fleet.name}</td>
          <td class="table-cell">${fleet.desc || '-'}</td>
          <td class="table-cell text-center">
            <button class="edit-fleet-btn btn btn-info px-3 py-1 text-sm mr-2" data-id="${fleet.id}">
              <i class="fa fa-edit mr-1"></i>編輯
            </button>
          </td>
        `;
        listBody.appendChild(tr);
      });
      
      // 綁定編輯按鈕
      document.querySelectorAll('.edit-fleet-btn').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-id')));
      });
    }

    // 加載管理員審核列表
    function loadAdminAuditList() {
      const applyList = JSON.parse(localStorage.getItem(ADMIN_APPLY_KEY) || '[]');
      const auditBody = document.getElementById('admin-audit-body');
      
      auditBody.innerHTML = '';
      
      if (applyList.length === 0) {
        auditBody.innerHTML = `
          <tr class="text-center text-gray-400">
            <td colspan="4" class="table-cell">暫無審核申請</td>
          </tr>
        `;
        return;
      }
      
      applyList.forEach((apply, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="table-cell">${apply.name}</td>
          <td class="table-cell">${apply.phone}</td>
          <td class="table-cell">${apply.fleetName}</td>
          <td class="table-cell text-center">
            <button class="approve-admin-btn btn btn-success px-3 py-1 text-sm mr-2" data-index="${index}">
              <i class="fa fa-check mr-1"></i>通過
            </button>
            <button class="reject-admin-btn btn btn-danger px-3 py-1 text-sm" data-index="${index}">
              <i class="fa fa-times mr-1"></i>駁回
            </button>
          </td>
        `;
        auditBody.appendChild(tr);
      });
      
      // 審核按鈕事件
      document.querySelectorAll('.approve-admin-btn').forEach(btn => {
        btn.addEventListener('click', () => approveAdminApplication(btn.getAttribute('data-index')));
      });
      document.querySelectorAll('.reject-admin-btn').forEach(btn => {
        btn.addEventListener('click', () => rejectAdminApplication(btn.getAttribute('data-index')));
      });
    }

    // 加載已通過管理員列表（包含LINE ID/密碼字段）
    function loadApprovedAdmins() {
      const approvedAdmins = JSON.parse(localStorage.getItem(APPROVED_ADMINS_KEY) || '[]');
      const fleetList = JSON.parse(localStorage.getItem(FLEETS_KEY) || '[]');
      const manageBody = document.getElementById('admin-manage-body');
      
      manageBody.innerHTML = '';
      
      if (approvedAdmins.length === 0) {
        manageBody.innerHTML = `
          <tr class="text-center text-gray-400">
            <td colspan="10" class="table-cell">暫無管理員數據</td>
          </tr>
        `;
        return;
      }
      
      approvedAdmins.forEach((admin, index) => {
        const fleet = fleetList.find(f => f.id === admin.fleetId) || { name: '未知車隊' };
        const statusText = admin.status === '停權' ? '<span class="text-danger">停權</span>' : '<span class="text-success">正常</span>';
        const statusBtnText = admin.status === '停權' ? '復權' : '停權';
        const statusBtnClass = admin.status === '停權' ? 'btn-success' : 'btn-danger';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="table-cell">${fleet.name}</td>
          <td class="table-cell font-mono text-sm">${admin.fleetId}</td>
          <td class="table-cell">${admin.name}</td>
          <td class="table-cell">${admin.phone}</td>
          <td class="table-cell">${admin.lineId || '-'}</td>
          <td class="table-cell">${admin.account}</td>
          <td class="table-cell">${admin.password}</td>
          <td class="table-cell">${admin.payDate || '-'}</td>
          <td class="table-cell text-center">${statusText}</td>
          <td class="table-cell text-center">
            <button class="change-status-btn btn ${statusBtnClass} px-3 py-1 text-sm" data-index="${index}" data-status="${admin.status}">
              <i class="fa fa-refresh mr-1"></i>${statusBtnText}
            </button>
          </td>
        `;
        manageBody.appendChild(tr);
      });
      
      // 狀態變更按鈕
      document.querySelectorAll('.change-status-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentAdminId = btn.getAttribute('data-index');
          currentAdminStatus = btn.getAttribute('data-status');
          openStatusModal();
        });
      });
    }

    // 加載租金及銀行設定
    function loadRentSettings() {
      const settings = JSON.parse(localStorage.getItem(RENT_SETTING_KEY) || '{}');
      if (settings.monthlyRent) document.getElementById('monthly-rent').value = settings.monthlyRent;
      if (settings.bankName) document.getElementById('bank-name').value = settings.bankName;
      if (settings.bankAccount) document.getElementById('bank-account').value = settings.bankAccount;
      if (settings.bankHolder) document.getElementById('bank-holder').value = settings.bankHolder;
    }

    // 綁定所有交互事件
    function bindEvents() {
      // 登出按鈕
      document.getElementById('logout-btn').addEventListener('click', () => {
        if (confirm('確定要登出超管後台嗎？')) {
          localStorage.removeItem(LOGGED_KEY);
          window.location.href = LOGIN_PAGE;
        }
      });

      // 刷新按鈕
      document.getElementById('refresh-fleet-btn').addEventListener('click', loadFleetList);
      document.getElementById('refresh-admin-btn').addEventListener('click', loadApprovedAdmins);

      // 新增車隊
      document.getElementById('add-fleet-btn').addEventListener('click', () => {
        document.getElementById('add-fleet-form').reset();
        document.getElementById('add-fleet-modal').classList.remove('hidden');
      });

      // 新增車隊提交
      document.getElementById('add-fleet-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const fleetName = document.getElementById('new-fleet-name').value.trim();
        const fleetDesc = document.getElementById('new-fleet-desc').value.trim();
        
        if (!fleetName) {
          showAlert('錯誤', '請輸入車隊名稱！', 'error');
          return;
        }
        
        // 生成5位數隨機車隊ID
        const fleetId = Math.floor(10000 + Math.random() * 90000).toString();
        
        const fleetList = JSON.parse(localStorage.getItem(FLEETS_KEY) || '[]');
        fleetList.push({
          id: fleetId,
          name: fleetName,
          desc: fleetDesc,
          createTime: new Date().toLocaleString('zh-TW')
        });
        
        localStorage.setItem(FLEETS_KEY, JSON.stringify(fleetList));
        closeAllModals();
        showAlert('成功', '車隊新增成功！', 'success');
        loadFleetList();
      });

      // 編輯車隊提交
      document.getElementById('edit-fleet-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!currentEditFleetId) return;
        
        const fleetName = document.getElementById('edit-fleet-name').value.trim();
        const fleetDesc = document.getElementById('edit-fleet-desc').value.trim();
        
        if (!fleetName) {
          showAlert('錯誤', '請輸入車隊名稱！', 'error');
          return;
        }
        
        const fleetList = JSON.parse(localStorage.getItem(FLEETS_KEY) || '[]');
        const fleetIndex = fleetList.findIndex(f => f.id === currentEditFleetId);
        
        if (fleetIndex !== -1) {
          fleetList[fleetIndex].name = fleetName;
          fleetList[fleetIndex].desc = fleetDesc;
          localStorage.setItem(FLEETS_KEY, JSON.stringify(fleetList));
          closeAllModals();
          showAlert('成功', '車隊修改成功！', 'success');
          loadFleetList();
        }
      });

      // 刪除車隊
      document.getElementById('delete-fleet-btn').addEventListener('click', () => {
        if (!currentEditFleetId || !confirm('確定要刪除此車隊嗎？此操作不可撤銷！')) return;
        
        const fleetList = JSON.parse(localStorage.getItem(FLEETS_KEY) || '[]');
        const newFleetList = fleetList.filter(f => f.id !== currentEditFleetId);
        
        localStorage.setItem(FLEETS_KEY, JSON.stringify(newFleetList));
        closeAllModals();
        showAlert('成功', '車隊刪除成功！', 'success');
        loadFleetList();
      });

      // 租金設定保存
      document.getElementById('rent-setting-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const monthlyRent = document.getElementById('monthly-rent').value.trim();
        const bankName = document.getElementById('bank-name').value.trim();
        const bankAccount = document.getElementById('bank-account').value.trim();
        const bankHolder = document.getElementById('bank-holder').value.trim();
        
        if (!monthlyRent || !bankName || !bankAccount || !bankHolder) {
          showAlert('錯誤', '請填寫所有必填欄位！', 'error');
          return;
        }
        
        const settings = {
          monthlyRent, bankName, bankAccount, bankHolder,
          updateTime: new Date().toLocaleString('zh-TW')
        };
        
        localStorage.setItem(RENT_SETTING_KEY, JSON.stringify(settings));
        showAlert('成功', '設定儲存成功！', 'success');
      });

      // 管理員狀態變更確認
      document.getElementById('confirm-status-btn').addEventListener('click', () => {
        const approvedAdmins = JSON.parse(localStorage.getItem(APPROVED_ADMINS_KEY) || '[]');
        const newStatus = currentAdminStatus === '正常' ? '停權' : '正常';
        
        if (currentAdminId !== '' && approvedAdmins[currentAdminId]) {
          approvedAdmins[currentAdminId].status = newStatus;
          localStorage.setItem(APPROVED_ADMINS_KEY, JSON.stringify(approvedAdmins));
          closeAllModals();
          showAlert('成功', `管理員狀態已變更為${newStatus}！`, 'success');
          loadApprovedAdmins();
        }
      });

      // 關閉所有彈窗按鈕
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', closeAllModals);
      });

      // 提示框確定按鈕
      document.getElementById('alert-confirm-btn').addEventListener('click', () => {
        document.getElementById('alert-modal').classList.add('hidden');
      });

      // 點擊彈窗外層關閉
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeAllModals();
        });
      });
    }

    // 通過管理員申請
    function approveAdminApplication(index) {
      const applyList = JSON.parse(localStorage.getItem(ADMIN_APPLY_KEY) || '[]');
      const approvedAdmins = JSON.parse(localStorage.getItem(APPROVED_ADMINS_KEY) || '[]');
      
      if (index >= 0 && index < applyList.length) {
        const approvedAdmin = applyList[index];
        // 生成帳號密碼（電話為帳號，隨機8位密碼）
        const account = approvedAdmin.phone;
        const password = Math.random().toString(36).slice(-8);
        
        approvedAdmins.push({
          ...approvedAdmin,
          account,
          password,
          status: '正常',
          payDate: '',
          lineId: approvedAdmin.lineId || ''
        });
        
        // 移除申請
        applyList.splice(index, 1);
        
        localStorage.setItem(ADMIN_APPLY_KEY, JSON.stringify(applyList));
        localStorage.setItem(APPROVED_ADMINS_KEY, JSON.stringify(approvedAdmins));
        
        showAlert('成功', `審核通過！帳號：${account}，密碼：${password}`, 'success');
        loadAdminAuditList();
        loadApprovedAdmins();
      }
    }

    // 駁回管理員申請
    function rejectAdminApplication(index) {
      const applyList = JSON.parse(localStorage.getItem(ADMIN_APPLY_KEY) || '[]');
      
      if (index >= 0 && index < applyList.length) {
        applyList.splice(index, 1);
        localStorage.setItem(ADMIN_APPLY_KEY, JSON.stringify(applyList));
        
        showAlert('成功', '已駁回該申請', 'success');
        loadAdminAuditList();
      }
    }

    // 打開編輯車隊彈窗
    function openEditModal(fleetId) {
      currentEditFleetId = fleetId;
      const fleetList = JSON.parse(localStorage.getItem(FLEETS_KEY) || '[]');
      const fleet = fleetList.find(f => f.id === fleetId);
      
      if (fleet) {
        document.getElementById('edit-fleet-id').value = fleet.id;
        document.getElementById('edit-fleet-name').value = fleet.name;
        document.getElementById('edit-fleet-desc').value = fleet.desc || '';
        document.getElementById('edit-fleet-modal').classList.remove('hidden');
      }
    }

    // 打開狀態變更彈窗
    function openStatusModal() {
      const newStatus = currentAdminStatus === '正常' ? '停權' : '復權';
      document.getElementById('status-modal-title').textContent = `${newStatus}管理員`;
      document.getElementById('status-modal-desc').textContent = `確定要將此管理員${newStatus}嗎？`;
      document.getElementById('confirm-status-btn').textContent = `確認${newStatus}`;
      document.getElementById('confirm-status-btn').className = `btn ${newStatus === '停權' ? 'btn-danger' : 'btn-success'} flex-1`;
      
      document.getElementById('admin-status-modal').classList.remove('hidden');
    }

    // 關閉所有彈窗
    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
      currentEditFleetId = '';
      currentAdminId = '';
      currentAdminStatus = '';
    }

    // 顯示提示框（匹配截图的白底黑字样式）
    function showAlert(title, message, type = 'info') {
      const alertTitle = document.getElementById('alert-title');
      const alertMessage = document.getElementById('alert-message');
      const alertIcon = document.getElementById('alert-icon');
      
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      
      switch(type) {
        case 'success':
          alertIcon.className = 'fa fa-check-circle text-3xl text-success mb-2';
          alertTitle.className = 'text-lg font-medium text-success';
          break;
        case 'error':
          alertIcon.className = 'fa fa-exclamation-circle text-3xl text-danger mb-2';
          alertTitle.className = 'text-lg font-medium text-danger';
          break;
        case 'warning':
          alertIcon.className = 'fa fa-exclamation-triangle text-3xl text-yellow-500 mb-2';
          alertTitle.className = 'text-lg font-medium text-yellow-500';
          break;
        default:
          alertIcon.className = 'fa fa-info-circle text-3xl text-info mb-2';
          alertTitle.className = 'text-lg font-medium text-info';
      }
      
      document.getElementById('alert-modal').classList.remove('hidden');
    }
  </script>
</body>
</html>