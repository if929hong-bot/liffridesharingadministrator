<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>超級管理員後台</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 全域樣式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft JhengHei", sans-serif;
      color: #333;
    }
    body {
      background: #f0f2f5;
      display: flex;
      min-height: 100vh;
    }

    /* 左側菜單 */
    .sidebar {
      width: 220px;
      background: #228B22;
      padding: 1.5rem 0;
    }
    .sidebar h2 {
      color: #fff;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 2.5rem;
      padding: 0 1rem;
    }
    .sidebar .menu {
      list-style: none;
    }
    .sidebar .menu > li {
      margin-bottom: 0.3rem;
    }
    .sidebar .menu > li > a {
      display: block;
      color: #fff;
      text-decoration: none;
      padding: 1rem 1.8rem;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .sidebar .menu > li > a:hover, 
    .sidebar .menu > li > a.active {
      background: #1E7D1E;
    }
    .sidebar .menu i {
      color: #fff;
      margin-right: 0.8rem;
      width: 18px;
      text-align: center;
    }
    .submenu {
      list-style: none;
      background: #006400;
    }
    .submenu li a {
      display: block;
      color: #fff;
      text-decoration: none;
      padding: 0.8rem 2.5rem;
      font-size: 0.95rem;
    }
    .submenu li a:hover {
      background: #004d00;
    }

    /* 主內容 */
    .main-content {
      flex: 1;
      padding: 2.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 0.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .card h3 {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid #e0e0e0;
    }

    /* 表單與搜尋樣式 */
    .search-group {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    .search-input {
      padding: 0.8rem;
      border: 1px solid #ccc;
      border-radius: 0.3rem;
      font-size: 1rem;
      flex: 1;
    }
    .search-btn {
      padding: 0.8rem 1.5rem;
      background: #008000;
      color: #fff;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      font-size: 1rem;
    }
    .reject-btn {
      padding: 0.8rem 1.5rem;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    .delete-btn {
      padding: 0.8rem 1.5rem;
      background: #ff6347;
      color: #fff;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 0.5rem;
    }

    /* 列表樣式 */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
    }
    .table th, .table td {
      padding: 1rem;
      border: 1px solid #e0e0e0;
      text-align: left;
      font-size: 0.95rem;
    }
    .table th {
      background: #f8f8f8;
      font-weight: 600;
    }
    .empty-tip {
      text-align: center;
      color: #666;
      padding: 2rem;
      font-size: 1rem;
    }

    /* 隱藏面板 */
    .panel {
      display: none;
    }
    .panel.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- 左側菜單 -->
  <aside class="sidebar">
    <h2>超級管理員</h2>
    <ul class="menu">
      <li>
        <a href="#price-setting" data-panel="price-setting">租金價格設定</a>
      </li>
      <li>
        <a href="#bank-setting" data-panel="bank-setting">銀行帳戶設定</a>
      </li>
      <li>
        <a href="#payment-records" data-panel="payment-records">繳費紀錄查看</a>
      </li>
      <li>
        <a href="#fleet-register-apply" data-panel="fleet-register-apply">車隊管理員註冊申請</a>
      </li>
      <li>
        <a href="#fleet-manager" data-panel="fleet-manager">車隊管理員列表管理</a>
      </li>
      <li>
        <a href="#data-library" data-panel="data-library">資料圖庫</a>
      </li>
    </ul>
  </aside>

  <!-- 主內容區 -->
  <main class="main-content">
    <!-- 1. 租金價格設定面板 -->
    <section id="price-setting" class="panel card">
      <h3>租金價格設定</h3>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">月繳單價（NT$）</label>
        <input type="number" id="monthly-price" class="search-input" placeholder="請輸入月繳單價" min="1" required>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">季繳單價（NT$）</label>
        <input type="number" id="quarterly-price" class="search-input" placeholder="請輸入季繳單價" min="1" required>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">半年繳單價（NT$）</label>
        <input type="number" id="halfyear-price" class="search-input" placeholder="請輸入半年繳單價" min="1" required>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">年繳單價（NT$）</label>
        <input type="number" id="yearly-price" class="search-input" placeholder="請輸入年繳單價" min="1" required>
      </div>
      <button class="search-btn" id="save-price">儲存價格設定</button>
    </section>

    <!-- 2. 銀行帳戶設定面板（新增銀行分行欄位） -->
    <section id="bank-setting" class="panel card">
      <h3>銀行帳戶設定</h3>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">銀行名稱 <span style="color:red">*</span></label>
        <input type="text" id="bank-name" class="search-input" placeholder="請輸入銀行名稱" required>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">銀行分行 <span style="color:red">*</span></label>
        <input type="text" id="bank-branch" class="search-input" placeholder="請輸入銀行分行（例如：台北信義分行）" required>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">戶名 <span style="color:red">*</span></label>
        <input type="text" id="bank-account-name" class="search-input" placeholder="請輸入戶名" required>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; font-size:1rem;">銀行帳號 <span style="color:red">*</span></label>
        <input type="text" id="bank-account-number" class="search-input" placeholder="請輸入銀行帳號" required>
      </div>
      <button class="search-btn" id="save-bank">儲存銀行帳戶</button>
    </section>

    <!-- 3. 繳費紀錄查看面板 -->
    <section id="payment-records" class="panel card">
      <h3>繳費紀錄查看</h3>
      <div class="search-group">
        <input type="text" id="search-payment" class="search-input" placeholder="搜尋車隊/金額">
        <button class="search-btn" id="search-payment-btn">搜尋</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>車隊名稱</th>
            <th>繳費週期</th>
            <th>總金額（NT$）</th>
          </tr>
        </thead>
        <tbody id="payment-records-list">
          <tr><td colspan="3" class="empty-tip">無繳費紀錄</td></tr>
        </tbody>
      </table>
    </section>

    <!-- 4. 車隊管理員註冊申請面板 -->
    <section id="fleet-register-apply" class="panel card">
      <h3>車隊管理員註冊申請</h3>
      <div class="search-group">
        <input type="text" id="search-register-apply" class="search-input" placeholder="搜尋車隊名稱／管理員／帳號">
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>車隊名稱</th>
            <th>管理員姓名</th>
            <th>聯繫電話</th>
            <th>信箱</th>
            <th>帳號</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="register-apply-list">
          <tr><td colspan="6" class="empty-tip">目前沒有待審核的註冊申請</td></tr>
        </tbody>
      </table>
    </section>

    <!-- 5. 車隊管理員列表管理面板 -->
    <section id="fleet-manager" class="panel card">
      <h3>車隊管理員列表管理</h3>
      <div class="search-group">
        <input type="text" id="search-fleet-manager" class="search-input" placeholder="搜尋車隊名稱／管理員／電話">
        <select id="filter-fleet-status" class="search-input" style="max-width:200px;">
          <option value="all">全部狀態</option>
          <option value="active">正常</option>
          <option value="suspended">停權</option>
        </select>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>車隊名稱</th>
            <th>管理員姓名</th>
            <th>聯繫電話</th>
            <th>信箱</th>
            <th>帳號</th>
            <th>密碼</th>
            <th>狀態</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="fleet-manager-list">
          <tr><td colspan="8" class="empty-tip">目前沒有任何車隊管理員資料</td></tr>
        </tbody>
      </table>
    </section>

    <!-- 6. 資料圖庫面板 -->
    <section id="data-library" class="panel card">
      <h3>資料圖庫</h3>
      <div class="search-group">
        <input type="text" class="search-input" placeholder="搜尋繳費紀錄">
        <button class="search-btn">搜尋</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>車隊名稱</th>
            <th>繳費紀錄檔案</th>
            <th>上傳時間</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="empty-tip">無上傳的繳費紀錄</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // 儲存鍵名定義（新增 approvedFleetAdmins 鍵，與 index.html 登錄驗證對應）
    const PRICE_KEY = 'carRentalPrice';
    const BANK_KEY = 'carRentalBank';
    const PAYMENT_KEY = 'carRentalPayment';
    const FLEET_REGISTER_KEY = 'fleetManagers'; 
    const FLEET_ADMIN_KEY = 'fleetAdminList';    
    const APPROVED_FLEET_ADMINS_KEY = 'approvedFleetAdmins'; // 登錄驗證用的已審核列表

    // 1. 左側菜單切換主面板
    document.querySelectorAll('.menu > li > a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.menu > li > a').forEach(a => a.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
        link.classList.add('active');
        const panelId = link.getAttribute('data-panel');
        document.getElementById(panelId).classList.add('active');
        if (panelId === 'fleet-register-apply') loadRegisterApply();
        if (panelId === 'fleet-manager') {
          loadFleetAdmins();
          syncApprovedFleetAdmins(); // 切換到列表時同步登錄驗證列表
        }
      });
    });

    // 2. 租金價格設定
    document.getElementById('save-price').addEventListener('click', () => {
      const priceData = {
        monthly: Number(document.getElementById('monthly-price').value),
        quarterly: Number(document.getElementById('quarterly-price').value),
        halfyear: Number(document.getElementById('halfyear-price').value),
        yearly: Number(document.getElementById('yearly-price').value)
      };
      localStorage.setItem(PRICE_KEY, JSON.stringify(priceData));
      alert('租金價格已儲存！');
    });

    // 3. 銀行帳戶設定（新增分行欄位處理）
    document.getElementById('save-bank').addEventListener('click', () => {
      const bankName = document.getElementById('bank-name').value.trim();
      const bankBranch = document.getElementById('bank-branch').value.trim(); // 新增分行欄位
      const accountName = document.getElementById('bank-account-name').value.trim();
      const accountNumber = document.getElementById('bank-account-number').value.trim();
      
      // 驗證所有必填欄位
      if (!bankName || !bankBranch || !accountName || !accountNumber) {
        alert('請完整填寫銀行名稱、銀行分行、戶名與銀行帳號！');
        return;
      }
      
      const bankData = { 
        bankName, 
        bankBranch, // 新增分行資訊
        accountName, 
        accountNumber 
      };
      localStorage.setItem(BANK_KEY, JSON.stringify(bankData));
      alert('銀行帳戶已儲存！');
    });

    // 4. 載入車隊管理員註冊申請（待審核）
    function loadRegisterApply() {
      const applyList = JSON.parse(localStorage.getItem(FLEET_REGISTER_KEY) || '[]');
      const keyword = document.getElementById('search-register-apply').value.trim();
      const tbody = document.getElementById('register-apply-list');
      
      let filteredList = applyList;
      if (keyword) {
        filteredList = applyList.filter(item =>
          item.fleetName.includes(keyword) ||
          item.managerName.includes(keyword) ||
          item.managerAccount.includes(keyword)
        );
      }

      tbody.innerHTML = '';
      if (filteredList.length === 0) {
        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"empty-tip\">目前沒有待審核的註冊申請</td></tr>';
        return;
      }

      filteredList.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.fleetName}</td>
          <td>${item.managerName}</td>
          <td>${item.managerPhone}</td>
          <td>${item.managerEmail}</td>
          <td>${item.managerAccount}</td>
          <td>
            <button class="search-btn approve-apply" data-id="${item.managerAccount}">通過</button>
            <button class="reject-btn reject-apply" data-id="${item.managerAccount}">駁回</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.approve-apply').forEach(btn => {
        btn.addEventListener('click', function() {
          const account = this.getAttribute('data-id');
          approveRegister(account);
        });
      });

      document.querySelectorAll('.reject-apply').forEach(btn => {
        btn.addEventListener('click', function() {
          const account = this.getAttribute('data-id');
          rejectRegister(account);
        });
      });
    }

    // 5. 通過註冊申請（同步到登錄驗證列表）
    function approveRegister(account) {
      const applyList = JSON.parse(localStorage.getItem(FLEET_REGISTER_KEY) || '[]');
      const approvedItem = applyList.find(item => item.managerAccount === account);
      if (!approvedItem) return;

      // 1. 新增到原車隊管理員列表
      const adminList = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
      const newAdmin = {
        id: `fleet-${Date.now()}`,
        fleetName: approvedItem.fleetName,
        managerName: approvedItem.managerName,
        phone: approvedItem.managerPhone,
        email: approvedItem.managerEmail,
        account: approvedItem.managerAccount,
        username: approvedItem.managerAccount, // 新增 username 字段（匹配 index.html 登錄驗證）
        password: approvedItem.managerPassword,
        status: 'active'
      };
      adminList.push(newAdmin);
      localStorage.setItem(FLEET_ADMIN_KEY, JSON.stringify(adminList));

      // 2. 同步到登錄驗證用的 approvedFleetAdmins 列表
      const approvedAdmins = JSON.parse(localStorage.getItem(APPROVED_FLEET_ADMINS_KEY) || '[]');
      approvedAdmins.push({
        teamName: approvedItem.fleetName,
        name: approvedItem.managerName,
        phone: approvedItem.managerPhone,
        email: approvedItem.managerEmail,
        username: approvedItem.managerAccount, // 登錄帳號
        password: approvedItem.managerPassword, // 登錄密碼
        status: 'active'
      });
      localStorage.setItem(APPROVED_FLEET_ADMINS_KEY, JSON.stringify(approvedAdmins));

      // 3. 移除待審核列表中的該項
      const updatedApplyList = applyList.filter(item => item.managerAccount !== account);
      localStorage.setItem(FLEET_REGISTER_KEY, JSON.stringify(updatedApplyList));

      loadRegisterApply();
      loadFleetAdmins();
      alert('已通過該車隊管理員的註冊申請！可登錄車隊管理員後台');
    }

    // 6. 駁回註冊申請
    function rejectRegister(account) {
      const applyList = JSON.parse(localStorage.getItem(FLEET_REGISTER_KEY) || '[]');
      const updatedApplyList = applyList.filter(item => item.managerAccount !== account);
      localStorage.setItem(FLEET_REGISTER_KEY, JSON.stringify(updatedApplyList));
      loadRegisterApply();
      alert('已駁回該車隊管理員的註冊申請！');
    }

    // 7. 刪除車隊管理員（同時從登錄驗證列表移除）
    function deleteFleetAdmin(id) {
      // 1. 從原列表刪除
      const adminList = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
      const deletedAdmin = adminList.find(item => item.id === id);
      const updatedList = adminList.filter(item => item.id !== id);
      localStorage.setItem(FLEET_ADMIN_KEY, JSON.stringify(updatedList));

      // 2. 從登錄驗證列表移除對應帳號
      if (deletedAdmin) {
        const approvedAdmins = JSON.parse(localStorage.getItem(APPROVED_FLEET_ADMINS_KEY) || '[]');
        const updatedApproved = approvedAdmins.filter(item => item.username !== deletedAdmin.account);
        localStorage.setItem(APPROVED_FLEET_ADMINS_KEY, JSON.stringify(updatedApproved));
      }

      loadFleetAdmins();
      alert('已刪除此車隊管理員！該帳號將無法登錄');
    }

    // 8. 載入已審核的車隊管理員列表
    function loadFleetAdmins() {
      const adminList = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
      const keyword = document.getElementById('search-fleet-manager').value.trim();
      const statusFilter = document.getElementById('filter-fleet-status').value;
      const tbody = document.getElementById('fleet-manager-list');

      let filteredList = adminList;
      if (keyword) {
        filteredList = adminList.filter(item =>
          item.fleetName.includes(keyword) ||
          item.managerName.includes(keyword) ||
          item.phone.includes(keyword) ||
          item.account.includes(keyword)
        );
      }
      if (statusFilter !== 'all') {
        filteredList = filteredList.filter(item => item.status === statusFilter);
      }

      tbody.innerHTML = '';
      if (filteredList.length === 0) {
        tbody.innerHTML = '<tr><td colspan=\"8\" class=\"empty-tip\">目前沒有任何車隊管理員資料</td></tr>';
        return;
      }

      filteredList.forEach(item => {
        const statusText = item.status === 'suspended' ? '停權' : '正常';
        const actionText = item.status === 'suspended' ? '復權' : '停權';
        const nextStatus = item.status === 'suspended' ? 'active' : 'suspended';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.fleetName}</td>
          <td>${item.managerName}</td>
          <td>${item.phone}</td>
          <td>${item.email || '未設定'}</td>
          <td>${item.account || '未設定'}</td>
          <td>${item.password || '未設定'}</td>
          <td>${statusText}</td>
          <td>
            <button class=\"search-btn status-btn\" data-id=\"${item.id}\" data-next-status=\"${nextStatus}\">${actionText}</button>
            <button class=\"delete-btn\" data-id=\"${item.id}\">刪除</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // 綁定狀態切換按鈕事件（同步更新登錄驗證列表的狀態）
      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const nextStatus = this.getAttribute('data-next-status');
          // 1. 更新原列表狀態
          const list = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
          const updated = list.map(item => item.id === id ? { ...item, status: nextStatus } : item);
          localStorage.setItem(FLEET_ADMIN_KEY, JSON.stringify(updated));
          
          // 2. 同步更新登錄驗證列表的狀態
          const targetAdmin = list.find(item => item.id === id);
          if (targetAdmin) {
            const approvedAdmins = JSON.parse(localStorage.getItem(APPROVED_FLEET_ADMINS_KEY) || '[]');
            const updatedApproved = approvedAdmins.map(item => 
              item.username === targetAdmin.account ? { ...item, status: nextStatus } : item
            );
            localStorage.setItem(APPROVED_FLEET_ADMINS_KEY, JSON.stringify(updatedApproved));
          }

          loadFleetAdmins();
        });
      });

      // 綁定刪除按鈕事件
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          if (confirm('確定要刪除此車隊管理員嗎？刪除後該帳號將無法登錄！')) {
            deleteFleetAdmin(id);
          }
        });
      });
    }

    // 9. 同步已審核列表到登錄驗證用的 approvedFleetAdmins（解決歷史數據同步問題）
    function syncApprovedFleetAdmins() {
      const adminList = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
      const approvedAdmins = adminList.map(item => ({
        teamName: item.fleetName,
        name: item.managerName,
        phone: item.phone,
        email: item.email,
        username: item.account,
        password: item.password,
        status: item.status
      }));
      localStorage.setItem(APPROVED_FLEET_ADMINS_KEY, JSON.stringify(approvedAdmins));
    }

    // 10. 搜尋註冊申請
    document.getElementById('search-register-apply').addEventListener('input', loadRegisterApply);

    // 11. 載入既有設定（新增分行欄位還原）
    window.addEventListener('load', () => {
      const storedPrice = JSON.parse(localStorage.getItem(PRICE_KEY) || '{}');
      document.getElementById('monthly-price').value = storedPrice.monthly || 9500;
      document.getElementById('quarterly-price').value = storedPrice.quarterly || 9000;
      document.getElementById('halfyear-price').value = storedPrice.halfyear || 9500;
      document.getElementById('yearly-price').value = storedPrice.yearly || 8500;

      const storedBank = JSON.parse(localStorage.getItem(BANK_KEY) || '{}');
      document.getElementById('bank-name').value = storedBank.bankName || '';
      document.getElementById('bank-branch').value = storedBank.bankBranch || ''; // 還原分行資訊
      document.getElementById('bank-account-name').value = storedBank.accountName || '';
      document.getElementById('bank-account-number').value = storedBank.accountNumber || '';

      // 初始化時同步一次已審核列表
      syncApprovedFleetAdmins();
      document.querySelector('[data-panel="fleet-register-apply"]').click();
    });
  </script>
</body>
</html>