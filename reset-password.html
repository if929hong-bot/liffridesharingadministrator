<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>重置密碼 - 帳號安全中心</title>
  <!-- 引入外部資源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 (和忘記密碼頁面一致) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: {
              100: '#F5F7FA',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            },
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 10px 30px -5px rgba(0, 0, 0, 0.1)',
            'card-hover': '0 20px 40px -5px rgba(0, 0, 0, 0.15)',
          }
        },
      }
    }
  </script>
  
  <!-- 自定義工具類 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .input-focus {
        @apply ring-2 ring-primary/50 border-primary outline-none;
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl flex items-center justify-center gap-2;
      }
      .btn-outline {
        @apply border border-neutral-200 hover:border-primary hover:text-primary font-medium py-3 px-6 rounded-lg transition-all duration-300;
      }
      .form-input {
        @apply w-full px-4 py-3 rounded-lg border border-neutral-200 focus:input-focus transition-all duration-300 text-neutral-700 placeholder-neutral-400;
      }
      .form-label {
        @apply block text-neutral-700 font-medium mb-2 text-sm;
      }
      .form-group {
        @apply mb-5;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .animate-slide-up {
        animation: slideUp 0.5s ease-out;
      }
      .animate-pulse-light {
        animation: pulseLight 2s infinite;
      }
    }
    
    /* 全局動畫定義 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulseLight {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-neutral-100 to-white min-h-screen flex items-center justify-center p-4 md:p-8">
  <!-- 頁面容器 -->
  <div class="w-full max-w-md">
    <!-- 成功提示框 (預設隱藏) -->
    <div id="successAlert" class="hidden bg-success/10 border border-success/30 text-success rounded-xl p-5 mb-6 animate-fade-in">
      <div class="flex items-start gap-3">
        <i class="fa fa-check-circle text-xl mt-0.5"></i>
        <div>
          <h3 class="font-semibold text-lg mb-1">密碼重置成功！</h3>
          <p class="text-sm text-success/80">您的密碼已更新，請使用新密碼登入系統。</p>
        </div>
      </div>
    </div>

    <!-- 錯誤提示框 (預設隱藏) -->
    <div id="errorAlert" class="hidden bg-danger/10 border border-danger/30 text-danger rounded-xl p-5 mb-6 animate-fade-in">
      <div class="flex items-start gap-3">
        <i class="fa fa-exclamation-triangle text-xl mt-0.5"></i>
        <div>
          <h3 class="font-semibold text-lg mb-1">連結無效或已過期</h3>
          <p class="text-sm text-danger/80" id="errorMsg">請重新申請密碼重置連結</p>
        </div>
      </div>
    </div>
    
    <!-- 表單卡片 -->
    <div id="resetFormCard" class="bg-white rounded-2xl shadow-card hover:shadow-card-hover transition-all duration-500 p-6 md:p-8 animate-slide-up hidden">
      <!-- 標題區域 -->
      <div class="text-center mb-8">
        <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-key text-primary text-2xl"></i>
        </div>
        <h1 class="text-[clamp(1.5rem,3vw,1.8rem)] font-bold text-neutral-700 mb-2">重置密碼</h1>
        <p class="text-neutral-500 text-sm">請設定您的新密碼</p>
      </div>
      
      <!-- 表單 -->
      <form id="resetPasswordForm" class="space-y-1">
        <!-- 新密碼輸入框 -->
        <div class="form-group">
          <label for="newPassword" class="form-label">新密碼</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
              <i class="fa fa-lock"></i>
            </span>
            <input 
              type="password" 
              id="newPassword" 
              name="newPassword" 
              class="form-input pl-10" 
              placeholder="8-20位，包含字母與數字"
              required
            >
            <span id="newPasswordError" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-danger">
              <i class="fa fa-exclamation-circle"></i>
            </span>
          </div>
          <p id="newPasswordErrorMessage" class="hidden text-danger text-xs mt-1"></p>
        </div>
        
        <!-- 確認密碼輸入框 -->
        <div class="form-group">
          <label for="confirmPassword" class="form-label">確認新密碼</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
              <i class="fa fa-lock"></i>
            </span>
            <input 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword" 
              class="form-input pl-10" 
              placeholder="請再次輸入新密碼"
              required
            >
            <span id="confirmPasswordError" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-danger">
              <i class="fa fa-exclamation-circle"></i>
            </span>
          </div>
          <p id="confirmPasswordErrorMessage" class="hidden text-danger text-xs mt-1"></p>
        </div>
        
        <!-- 安全提示 -->
        <div class="bg-neutral-100 rounded-lg p-3 mb-6">
          <p class="text-neutral-500 text-xs flex items-start gap-2">
            <i class="fa fa-info-circle text-primary mt-0.5"></i>
            <span>為了帳號安全，請勿使用與其他網站相同的密碼，並定期更換密碼。</span>
          </p>
        </div>
        
        <!-- 按鈕區域 -->
        <div class="space-y-3 mt-4">
          <button 
            type="submit" 
            id="resetSubmitBtn" 
            class="btn-primary w-full"
          >
            <i class="fa fa-refresh"></i>
            <span>確認重置密碼</span>
          </button>
          
          <div class="flex justify-center">
            <a href="login.html" class="text-primary hover:text-primary/80 text-sm font-medium transition-colors duration-300">
              返回登入頁面
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- JavaScript 邏輯處理 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 從URL獲取token
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      let userId = '';

      // DOM元素
      const resetFormCard = document.getElementById('resetFormCard');
      const successAlert = document.getElementById('successAlert');
      const errorAlert = document.getElementById('errorAlert');
      const errorMsg = document.getElementById('errorMsg');
      const resetForm = document.getElementById('resetPasswordForm');
      const resetSubmitBtn = document.getElementById('resetSubmitBtn');

      // 驗證token是否有效
      if (!token) {
        showError('未檢測到重置連結，請重新申請');
        return;
      }

      // 請求後端驗證token
      fetch(`https://forgot-password-backend.zeabur.app/api/reset-password/verify-token?token=${token}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // token有效，顯示表單
            userId = data.userId;
            resetFormCard.classList.remove('hidden');
          } else {
            showError(data.message || '連結無效或已過期');
          }
        })
        .catch(err => {
          console.error('驗證連結失敗:', err);
          showError('網絡錯誤，請稍後再試');
        });

      // 表單驗證規則
      const passwordFields = [
        {
          id: 'newPassword',
          errorElement: document.getElementById('newPasswordError'),
          errorMessageElement: document.getElementById('newPasswordErrorMessage'),
          validator: (value) => {
            if (value.trim() === '') return '請輸入新密碼';
            const pwdRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,20}$/;
            return pwdRegex.test(value) ? '' : '密碼需8-20位，包含字母與數字';
          }
        },
        {
          id: 'confirmPassword',
          errorElement: document.getElementById('confirmPasswordError'),
          errorMessageElement: document.getElementById('confirmPasswordErrorMessage'),
          validator: (value) => {
            const newPwd = document.getElementById('newPassword').value;
            if (value.trim() === '') return '請確認新密碼';
            return value === newPwd ? '' : '兩次輸入的密碼不一致';
          }
        }
      ];

      // 即時驗證密碼
      passwordFields.forEach(field => {
        const input = document.getElementById(field.id);
        input.addEventListener('input', () => validateField(field));
        input.addEventListener('blur', () => validateField(field, true));
      });

      // 表單提交處理
      resetForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // 驗證所有欄位
        let isValid = true;
        passwordFields.forEach(field => {
          if (validateField(field, true) !== '') isValid = false;
        });

        if (!isValid) return;

        // 準備提交數據
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        resetSubmitBtn.disabled = true;
        resetSubmitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>處理中...</span>';

        // 發送請求到後端更新密碼
        fetch('https://forgot-password-backend.zeabur.app/api/reset-password/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token,
            userId,
            newPassword,
            confirmPassword
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            resetFormCard.classList.add('hidden');
            successAlert.classList.remove('hidden');
            // 3秒後跳轉到登入頁
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 3000);
          } else {
            throw new Error(data.message || '重置密碼失敗');
          }
        })
        .catch(err => {
          alert(err.message);
          resetSubmitBtn.disabled = false;
          resetSubmitBtn.innerHTML = '<i class="fa fa-refresh"></i><span>確認重置密碼</span>';
        });
      });

      // 顯示錯誤訊息
      function showError(msg) {
        errorMsg.textContent = msg;
        errorAlert.classList.remove('hidden');
      }

      // 驗證單個欄位
      function validateField(field, showError = false) {
        const input = document.getElementById(field.id);
        const value = input.value.trim();
        const errorMessage = field.validator(value);

        if (errorMessage) {
          if (showError || input.dataset.touched === 'true') {
            field.errorElement.classList.remove('hidden');
            field.errorMessageElement.classList.remove('hidden');
            field.errorMessageElement.textContent = errorMessage;
            input.classList.add('border-danger');
            input.classList.remove('border-success');
          }
          input.dataset.touched = 'true';
          return errorMessage;
        } else {
          field.errorElement.classList.add('hidden');
          field.errorMessageElement.classList.add('hidden');
          input.classList.remove('border-danger');
          input.classList.add('border-success');
          input.dataset.touched = 'true';
          return '';
        }
      }
    });
  </script>
</body>
</html>