<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>搭車自由 - 乘客入口</title>
  <!-- 优先加载外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Leaflet 核心（OSM地图） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet 地址搜索插件 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>

  <!-- 基础样式重置 + 自定义工具类 -->
  <style>
    /* 重置默认样式，解决布局错乱 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      padding-top: 60px; /* 适配固定头部 */
    }
    /* 修复Leaflet地图容器必选样式 */
    #osm-map {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }
    /* 修复弹窗遮罩层级 */
    .map-modal {
      z-index: 9999 !important;
    }
  </style>

  <script>
    // Tailwind 配置
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00A86B',
            dark: '#333333',
            light: '#F5F5F5'
          },
          fontFamily: {
            sans: ['Helvetica Neue', 'Arial', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .btn-primary { 
        @apply bg-primary text-white py-3 px-6 rounded-lg font-medium hover:bg-primary/90 
               active:scale-95 shadow-md transition-all duration-300; 
      }
      .input-field { 
        @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 
               focus:ring-primary/50 focus:border-primary outline-none; 
      }
      .card { 
        @apply bg-white rounded-xl shadow-md p-6 hover:shadow-lg; 
      }
      .location-input-wrapper { 
        @apply relative; 
      }
      .location-icon { 
        @apply absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 
               cursor-pointer hover:text-primary z-10; 
      }
      .map-modal { 
        @apply fixed inset-0 bg-black/50 flex items-center justify-center hidden; 
      }
      .map-modal-content { 
        @apply bg-white rounded-xl w-[95%] max-w-[600px] h-[80vh] mx-4 relative; 
      }
      .map-close { 
        @apply absolute top-3 right-3 bg-white rounded-full w-8 h-8 flex items-center 
               justify-center cursor-pointer hover:bg-gray-100 shadow-sm z-20; 
      }
    }
  </style>
</head>

<body class="bg-light font-sans text-dark min-h-screen">
  <!-- 顶部导航（固定，解决布局错乱） -->
  <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50 h-16 flex items-center">
    <div class="container mx-auto px-4 flex items-center">
      <i class="fa fa-car text-primary text-2xl mr-2"></i>
      <h1 class="text-xl font-bold">搭車自由</h1>
    </div>
  </header>

  <!-- 主要内容（适配移动端，解决布局错乱） -->
  <main class="container mx-auto px-4 py-4">
    <div class="max-w-md mx-auto">
      <div class="card">
        <div class="text-center mb-8">
          <h2 class="text-2xl font-bold mb-2">乘客叫車</h2>
          <p class="text-gray-600">無需登錄，立即叫車</p>
        </div>
        
        <form id="ride-form">
          <div class="space-y-5">
            <!-- 姓名 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
              <input type="text" id="name" class="input-field" placeholder="輸入您的姓名" required>
            </div>
            
            <!-- 電話 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">電話</label>
              <input type="tel" id="phone" class="input-field" placeholder="輸入您的聯絡電話" required>
            </div>
            
            <!-- 上車地點（修复地图按钮点击） -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">上車地點</label>
              <div class="location-input-wrapper">
                <input type="text" id="pickup" class="input-field pr-10" placeholder="輸入您的位置" required>
                <i class="fa fa-map-marker location-icon" onclick="openOsmMap('pickup')"></i>
              </div>
            </div>
            
            <!-- 下車地點 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">下車地點</label>
              <div class="location-input-wrapper">
                <input type="text" id="dropoff" class="input-field pr-10" placeholder="輸入目的地" required>
                <i class="fa fa-map-marker location-icon" onclick="openOsmMap('dropoff')"></i>
              </div>
            </div>
            
            <!-- 乘客人數 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">乘客人數</label>
              <select id="count" class="input-field" required>
                <option value="1">1 人</option>
                <option value="2">2 人</option>
                <option value="3">3 人</option>
                <option value="4+">4 人以上</option>
              </select>
            </div>
          </div>
          
          <button type="submit" class="btn-primary w-full mt-8">我要叫車</button>
        </form>
      </div>
    </div>
  </main>

  <!-- OSM地图弹窗（修复层级和显示） -->
  <div id="osmMapModal" class="map-modal">
    <div class="map-modal-content">
      <div class="map-close" onclick="closeOsmMap()">
        <i class="fa fa-times text-gray-600"></i>
      </div>
      <div id="osm-map"></div>
    </div>
  </div>

  <script>
    // ==================== 1. 修复：Firebase 配置（必须替换为你的实际配置） ====================
    const firebaseConfig = {
      apiKey: "AIzaSyDxxx你的APIKeyxxx", // 替换为真实API Key
      authDomain: "你的项目ID.firebaseapp.com",
      databaseURL: "https://你的项目ID-default-rtdb.firebaseio.com",
      projectId: "你的项目ID",
      storageBucket: "你的项目ID.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abc123你的AppID"
    };
    // 初始化Firebase（修复未捕获的错误）
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // ==================== 2. 修复：地图核心变量 ====================
    let currentInput = '';
    let osmMap = null;

    // ==================== 3. 修复：DOM加载完成后初始化（解决地图加载时机问题） ====================
    document.addEventListener('DOMContentLoaded', function() {
      // 预初始化地图（确保DOM加载完成后执行）
      initOsmMap();
      
      // 修复表单提交事件（防止重复绑定）
      document.getElementById('ride-form').addEventListener('submit', handleFormSubmit);
    });

    // ==================== 4. 修复：OSM地图初始化（解决地图无法显示） ====================
    function initOsmMap() {
      if (osmMap) return;
      
      // 1. 创建地图实例（指定容器+初始坐标，修复台湾定位）
      osmMap = L.map('osm-map').setView([25.0330, 121.5654], 15); // 台北坐标
      
      // 2. 修复：使用稳定的OSM瓦片源（替换原不稳定源）
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(osmMap);
      
      // 3. 修复：地址搜索功能（解决搜索无响应）
      const geocoder = L.Control.Geocoder.nominatim({
        serviceUrl: 'https://nominatim.openstreetmap.org/',
        geocodingQueryParams: {
          'accept-language': 'zh-TW', // 优先台湾繁体
          'countrycodes': 'tw' // 限制台湾地区搜索
        }
      });
      
      // 添加搜索控件到地图
      L.Control.geocoder({
        defaultMarkGeocode: true,
        geocoder: geocoder
      }).addTo(osmMap).on('markgeocode', function(e) {
        // 修复：地址回填到输入框
        if (currentInput && document.getElementById(currentInput)) {
          document.getElementById(currentInput).value = e.geocode.name;
          closeOsmMap(); // 选择地址后关闭弹窗
        }
      });
      
      // 4. 修复：点击地图选位置（解决逆编码失败）
      osmMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // 逆编码：经纬度转地址（添加错误处理）
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=zh-TW`)
          .then(res => {
            if (!res.ok) throw new Error('地址解析失败');
            return res.json();
          })
          .then(data => {
            if (currentInput && document.getElementById(currentInput)) {
              document.getElementById(currentInput).value = data.display_name || `${lat}, ${lng}`;
              closeOsmMap();
            }
          })
          .catch(err => {
            alert('地址解析失敗，已填入經緯度：' + lat + ', ' + lng);
            document.getElementById(currentInput).value = `${lat}, ${lng}`;
            closeOsmMap();
          });
      });
    }

    // ==================== 5. 修复：打开地图弹窗（解决弹窗不显示） ====================
    function openOsmMap(inputId) {
      currentInput = inputId;
      const modal = document.getElementById('osmMapModal');
      modal.classList.remove('hidden'); // 显示弹窗
      
      // 修复：地图容器大小重置（解决地图加载后空白）
      setTimeout(() => {
        if (osmMap) osmMap.invalidateSize();
      }, 100);
    }

    // ==================== 6. 修复：关闭地图弹窗 ====================
    function closeOsmMap() {
      const modal = document.getElementById('osmMapModal');
      modal.classList.add('hidden');
    }

    // ==================== 7. 修复：表单提交逻辑（解决跳转失败） ====================
    function handleFormSubmit(e) {
      e.preventDefault(); // 阻止默认提交
      
      // 收集表单数据（修复输入框取值）
      const orderData = {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        pickup: document.getElementById('pickup').value.trim(),
        dropoff: document.getElementById('dropoff').value.trim(),
        count: document.getElementById('count').value,
        status: '待接單',
        createTime: new Date().toLocaleString('zh-TW'),
        orderId: Math.random().toString(36).substr(2, 8)
      };

      // 验证表单（修复空数据提交）
      if (!orderData.name || !orderData.phone || !orderData.pickup || !orderData.dropoff) {
        alert('請填寫完整信息！');
        return;
      }

      // 提交到Firebase（添加错误处理）
      db.ref('activeOrders').push(orderData)
        .then((ref) => {
          // 存储订单ID到本地
          localStorage.setItem('currentOrderId', ref.key);
          localStorage.setItem('currentOrder', JSON.stringify(orderData));
          
          alert('叫車申請已提交！');
          // 修复：跳转到乘客订单页（确保路径正确）
          window.location.href = '/passenger/passenger-order.html';
        })
        .catch(err => {
          alert('提交失敗：' + err.message);
          console.error('Firebase错误：', err); // 调试用
        });
    }
  </script>
</body>
</html>