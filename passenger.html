<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>搭車自由 - 乘客入口</title>
  <!-- 优先加载外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Mapbox 核心（替换 Leaflet/OSM） -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Mapbox 地理编码插件（地址搜索） -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>

  <!-- 基础样式重置 + 自定义工具类 -->
  <style>
    /* 重置默认样式，解决布局错乱 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      padding-top: 60px; /* 适配固定头部 */
    }
    /* 修复Mapbox地图容器必选样式 */
    #mapbox-map {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }
    /* 修复弹窗遮罩层级 */
    .map-modal {
      z-index: 9999 !important;
    }
    /* 适配Mapbox控件样式 */
    .mapboxgl-ctrl-geocoder {
      width: 100% !important;
      max-width: none !important;
      margin: 10px !important;
    }
  </style>

  <script>
    // Tailwind 配置
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00A86B',
            dark: '#333333',
            light: '#F5F5F5'
          },
          fontFamily: {
            sans: ['Helvetica Neue', 'Arial', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .btn-primary { 
        @apply bg-primary text-white py-3 px-6 rounded-lg font-medium hover:bg-primary/90 
               active:scale-95 shadow-md transition-all duration-300; 
      }
      .input-field { 
        @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 
               focus:ring-primary/50 focus:border-primary outline-none; 
      }
      .card { 
        @apply bg-white rounded-xl shadow-md p-6 hover:shadow-lg; 
      }
      .location-input-wrapper { 
        @apply relative; 
      }
      .location-icon { 
        @apply absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 
               cursor-pointer hover:text-primary z-10; 
      }
      .map-modal { 
        @apply fixed inset-0 bg-black/50 flex items-center justify-center hidden; 
      }
      .map-modal-content { 
        @apply bg-white rounded-xl w-[95%] max-w-[600px] h-[80vh] mx-4 relative; 
      }
      .map-close { 
        @apply absolute top-3 right-3 bg-white rounded-full w-8 h-8 flex items-center 
               justify-center cursor-pointer hover:bg-gray-100 shadow-sm z-20; 
      }
    }
  </style>
</head>

<body class="bg-light font-sans text-dark min-h-screen">
  <!-- 顶部导航（固定，解决布局错乱） -->
  <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50 h-16 flex items-center">
    <div class="container mx-auto px-4 flex items-center">
      <i class="fa fa-car text-primary text-2xl mr-2"></i>
      <h1 class="text-xl font-bold">搭車自由</h1>
    </div>
  </header>

  <!-- 主要内容（适配移动端，解决布局错乱） -->
  <main class="container mx-auto px-4 py-4">
    <div class="max-w-md mx-auto">
      <div class="card">
        <div class="text-center mb-8">
          <h2 class="text-2xl font-bold mb-2">乘客叫車</h2>
          <p class="text-gray-600">無需登錄，立即叫車</p>
        </div>
        
        <form id="ride-form">
          <div class="space-y-5">
            <!-- 姓名 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
              <input type="text" id="name" class="input-field" placeholder="輸入您的姓名" required>
            </div>
            
            <!-- 電話 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">電話</label>
              <input type="tel" id="phone" class="input-field" placeholder="輸入您的聯絡電話" required>
            </div>
            
            <!-- 上車地點（修复地图按钮点击） -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">上車地點</label>
              <div class="location-input-wrapper">
                <input type="text" id="pickup" class="input-field pr-10" placeholder="輸入您的位置" required>
                <i class="fa fa-map-marker location-icon" onclick="openMapboxMap('pickup')"></i>
              </div>
            </div>
            
            <!-- 下車地點 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">下車地點</label>
              <div class="location-input-wrapper">
                <input type="text" id="dropoff" class="input-field pr-10" placeholder="輸入目的地" required>
                <i class="fa fa-map-marker location-icon" onclick="openMapboxMap('dropoff')"></i>
              </div>
            </div>
            
            <!-- 乘客人數 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">乘客人數</label>
              <select id="count" class="input-field" required>
                <option value="1">1 人</option>
                <option value="2">2 人</option>
                <option value="3">3 人</option>
                <option value="4+">4 人以上</option>
              </select>
            </div>
          </div>
          
          <button type="submit" class="btn-primary w-full mt-8">我要叫車</button>
        </form>
      </div>
    </div>
  </main>

  <!-- Mapbox地图弹窗（修复层级和显示） -->
  <div id="mapboxMapModal" class="map-modal">
    <div class="map-modal-content">
      <div class="map-close" onclick="closeMapboxMap()">
        <i class="fa fa-times text-gray-600"></i>
      </div>
      <div id="mapbox-map"></div>
    </div>
  </div>

  <script>
    // ==================== 1. Mapbox 配置（填入你的Token） ====================
    mapboxgl.accessToken = 'pk.eyJ1IjoiaWY5Mjlob25nIiwiYSI6ImNtamQxczU2cjAweDMzZnM1Z3BvY2JkejgifQ.q-GNcs0rqWrZ3HtjhmysEQ';
    
    // ==================== 2. 修复：Firebase 配置（必须替换为你的实际配置） ====================
    const firebaseConfig = {
      apiKey: "AIzaSyDxxx你的APIKeyxxx", // 替换为真实API Key
      authDomain: "你的项目ID.firebaseapp.com",
      databaseURL: "https://你的项目ID-default-rtdb.firebaseio.com",
      projectId: "你的项目ID",
      storageBucket: "你的项目ID.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abc123你的AppID"
    };
    // 初始化Firebase（修复未捕获的错误）
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // ==================== 3. 修复：地图核心变量 ====================
    let currentInput = '';
    let mapboxMap = null;

    // ==================== 4. 修复：DOM加载完成后初始化（解决地图加载时机问题） ====================
    document.addEventListener('DOMContentLoaded', function() {
      // 预初始化Mapbox地图（确保DOM加载完成后执行）
      initMapboxMap();
      
      // 修复表单提交事件（防止重复绑定）
      document.getElementById('ride-form').addEventListener('submit', handleFormSubmit);
    });

    // ==================== 5. 修复：Mapbox地图初始化（替换OSM） ====================
    function initMapboxMap() {
      if (mapboxMap) return;
      
      // 1. 创建Mapbox地图实例（指定容器+初始坐标，台湾台北）
      mapboxMap = new mapboxgl.Map({
        container: 'mapbox-map',
        style: 'mapbox://styles/mapbox/streets-v12', // 地图样式
        center: [121.5654, 25.0330], // 台北经纬度（注意：Mapbox是[经度, 纬度]）
        zoom: 15 // 初始缩放级别
      });

      // 2. 添加地图控件（缩放、指南针）
      mapboxMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
      
      // 3. 添加地址搜索控件（Mapbox Geocoder）
      const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        language: 'zh-TW', // 繁体中文
        country: 'tw', // 限制台湾地区搜索
        placeholder: '搜索地址...',
        mapboxgl: mapboxgl
      });
      mapboxMap.addControl(geocoder);
      
      // 4. 监听搜索结果选中事件（回填地址到输入框）
      geocoder.on('result', function(e) {
        if (currentInput && document.getElementById(currentInput)) {
          document.getElementById(currentInput).value = e.result.place_name;
          closeMapboxMap(); // 选择地址后关闭弹窗
        }
      });
      
      // 5. 监听地图点击事件（逆编码：经纬度转地址）
      mapboxMap.on('click', function(e) {
        const lng = e.lngLat.lng;
        const lat = e.lngLat.lat;
        
        // 调用Mapbox逆地理编码API
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}&language=zh-TW`)
          .then(res => {
            if (!res.ok) throw new Error('地址解析失败');
            return res.json();
          })
          .then(data => {
            if (data.features && data.features.length > 0) {
              const address = data.features[0].place_name;
              if (currentInput && document.getElementById(currentInput)) {
                document.getElementById(currentInput).value = address;
                closeMapboxMap();
              }
            } else {
              throw new Error('未找到地址信息');
            }
          })
          .catch(err => {
            alert('地址解析失敗，已填入經緯度：' + lat + ', ' + lng);
            document.getElementById(currentInput).value = `${lat}, ${lng}`;
            closeMapboxMap();
          });
      });
      
      // 6. 等待地图加载完成后重置大小（解决弹窗打开后地图空白）
      mapboxMap.on('load', function() {
        mapboxMap.resize();
      });
    }

    // ==================== 6. 修复：打开Mapbox地图弹窗 ====================
    function openMapboxMap(inputId) {
      currentInput = inputId;
      const modal = document.getElementById('mapboxMapModal');
      modal.classList.remove('hidden'); // 显示弹窗
      
      // 修复：地图容器大小重置（解决地图加载后空白）
      setTimeout(() => {
        if (mapboxMap) mapboxMap.resize();
      }, 100);
    }

    // ==================== 7. 修复：关闭Mapbox地图弹窗 ====================
    function closeMapboxMap() {
      const modal = document.getElementById('mapboxMapModal');
      modal.classList.add('hidden');
    }

    // ==================== 8. 修复：表单提交逻辑 ====================
    function handleFormSubmit(e) {
      e.preventDefault(); // 阻止默认提交
      
      // 收集表单数据（修复输入框取值）
      const orderData = {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        pickup: document.getElementById('pickup').value.trim(),
        dropoff: document.getElementById('dropoff').value.trim(),
        count: document.getElementById('count').value,
        status: '待接單',
        createTime: new Date().toLocaleString('zh-TW'),
        orderId: Math.random().toString(36).substr(2, 8)
      };

      // 验证表单（修复空数据提交）
      if (!orderData.name || !orderData.phone || !orderData.pickup || !orderData.dropoff) {
        alert('請填寫完整信息！');
        return;
      }

      // 提交到Firebase（添加错误处理）
      db.ref('activeOrders').push(orderData)
        .then((ref) => {
          // 存储订单ID到本地
          localStorage.setItem('currentOrderId', ref.key);
          localStorage.setItem('currentOrder', JSON.stringify(orderData));
          
          alert('叫車申請已提交！');
          // 修复：跳转到乘客订单页（确保路径正确）
          window.location.href = '/passenger/passenger-order.html';
        })
        .catch(err => {
          alert('提交失敗：' + err.message);
          console.error('Firebase错误：', err); // 调试用
        });
    }
  </script>
</body>
</html>