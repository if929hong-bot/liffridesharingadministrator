<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ˆè²»é é¢ - å¤šå…ƒåŒ–ä¹˜è»Šç®¡ç†ç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS ç°¡åŒ–æ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Font Awesome åœ–æ¨™ -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- å¼•å…¥ html2canvas å¯¦ç¾æˆªåœ–åŠŸèƒ½ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f5f5f5;
        }
        .meter-card {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background: white;
        }
        .amount-display {
            font-size: 3rem;
            font-weight: bold;
            color: #22c55e;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-display {
            font-size: 1.25rem;
            color: #64748b;
        }
        .mileage-display {
            font-size: 1.5rem;
            color: #334155;
        }
        .btn-primary {
            background: #22c55e;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #16a34a;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-screenshot {
            background: #3b82f6;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-screenshot:hover {
            background: #2563eb;
        }
        .btn-close {
            background: #64748b;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-close:hover {
            background: #475569;
        }
        .timer-animation {
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.8; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- é é ­ -->
    <header class="bg-green-600 text-white py-4 px-6 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <a href="javascript:history.back()" class="text-white hover:text-gray-100">
                    <i class="fa fa-arrow-left text-xl"></i>
                </a>
                <h1 class="text-xl font-bold">å¯¦æ™‚è¨ˆè²»ç³»çµ±</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="driver-name" class="hidden md:inline-block">æ‚¨å¥½ï¼Œå¸æ©Ÿ</span>
                <button id="logout-btn" class="bg-white text-green-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <i class="fa fa-sign-out"></i>
                    <span>é€€å‡ºç™»éŒ„</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="max-w-4xl mx-auto px-4 py-8" id="meter-page"> <!-- æ–°å¢IDç”¨æ–¼æˆªåœ– -->
        <!-- è¨‚å–®åŸºæœ¬ä¿¡æ¯ -->
        <div class="meter-card p-6 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">è¨‚å–®ç·¨è™Ÿï¼š<span id="order-id" class="text-green-600"></span></h2>
                    <p class="text-gray-600 mt-1">ä¹˜å®¢ï¼š<span id="passenger-name"></span> | è¯ç¹«é›»è©±ï¼š<span id="passenger-phone"></span></p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <span id="order-status" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        å·²æŠµé”ä¸Šè»Šé»
                    </span>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-600">ä¸Šè»Šåœ°é»ï¼š<span id="pickup-location"></span></p>
                    <p class="text-gray-600 mt-1">ä¸‹è»Šåœ°é»ï¼š<span id="dropoff-location"></span></p>
                </div>
                <div>
                    <p class="text-gray-600">æŠµé”æ™‚é–“ï¼š<span id="arrive-time"></span></p>
                    <p class="text-gray-600 mt-1">ä¹˜è»Šé–‹å§‹æ™‚é–“ï¼š<span id="ride-start-time" class="text-red-500">æœªé–‹å§‹</span></p>
                </div>
            </div>
        </div>

        <!-- è¨ˆè²»æ ¸å¿ƒå€åŸŸ -->
        <div class="meter-card p-8 mb-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">å¯¦æ™‚è¨ˆè²»</h3>
            
            <!-- é‡‘é¡é¡¯ç¤º -->
            <div class="mb-6">
                <span class="amount-display" id="current-amount">0</span>
                <span class="text-xl text-gray-700 ml-2">NT$</span>
            </div>
            
            <!-- è¨ˆæ™‚å’Œé‡Œç¨‹ -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div>
                    <p class="text-gray-600 mb-2">ä¹˜è»Šæ™‚é•·</p>
                    <div class="time-display timer-animation" id="ride-duration">00:00:00</div>
                </div>
                <div>
                    <p class="text-gray-600 mb-2">è¡Œé§›é‡Œç¨‹</p>
                    <div class="mileage-display" id="ride-mileage">0.0 KM</div>
                </div>
            </div>
            
            <!-- è¨ˆè²»è¦å‰‡ -->
            <div class="text-left text-sm text-gray-500 mb-6">
                <p>ğŸ“‹ è¨ˆè²»è¦å‰‡ï¼šèµ·æ­¥åƒ¹ 80 NT$ (å‰1å…¬é‡Œ)ï¼Œä¹‹å¾Œæ¯å…¬é‡Œ 25 NT$ï¼Œæ¯åˆ†é˜ç­‰å¾…è²» 2 NT$</p>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex flex-wrap justify-center gap-4">
                <button id="start-ride-btn" class="btn-primary px-8 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-play-circle"></i>
                    <span>é–‹å§‹ä¹˜è»Š</span>
                </button>
                <button id="pause-ride-btn" class="btn-warning px-8 py-3 rounded-lg text-lg font-medium flex items-center gap-2 hidden">
                    <i class="fa fa-pause-circle"></i>
                    <span>æš«åœè¨ˆè²»</span>
                </button>
                <button id="resume-ride-btn" class="btn-warning px-8 py-3 rounded-lg text-lg font-medium flex items-center gap-2 hidden">
                    <i class="fa fa-play-circle"></i>
                    <span>æ¢å¾©è¨ˆè²»</span>
                </button>
            </div>
        </div>

        <!-- åˆ°é”ç›®çš„åœ°æ“ä½œ -->
        <div class="meter-card p-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">è¡Œç¨‹æ“ä½œ</h3>
            <div class="flex flex-wrap justify-center gap-4">
                <!-- æ–°å¢æˆªåœ–æŒ‰éˆ• -->
                <button id="screenshot-btn" class="btn-screenshot px-6 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-camera"></i>
                    <span>æˆªåœ–ä¿å­˜</span>
                </button>
                <!-- åˆ°é”ç›®çš„åœ°æŒ‰éˆ• -->
                <button id="arrive-destination-btn" class="btn-danger px-6 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-flag-checkered"></i>
                    <span>åˆ°é”ç›®çš„åœ°</span>
                </button>
                <!-- æ–°å¢é—œé–‰æŒ‰éˆ• -->
                <button id="close-page-btn" class="btn-close px-6 py-3 rounded-lg text-lg font-medium flex items-center gap-2">
                    <i class="fa fa-times-circle"></i>
                    <span>é—œé–‰é é¢</span>
                </button>
            </div>
        </div>
    </main>

    <!-- æ“ä½œæˆåŠŸæç¤º -->
    <div id="success-toast" class="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 hidden">
        <i class="fa fa-check-circle"></i>
        <span id="toast-message">æ“ä½œæˆåŠŸï¼</span>
    </div>

    <!-- æˆªåœ–åŠ è¼‰æç¤º -->
    <div id="screenshot-loading" class="fixed inset-0 bg-black/50 flex justify-center items-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center">
            <i class="fa fa-spinner refresh-animation text-3xl text-blue-600 mb-3"></i>
            <p class="text-lg font-medium text-gray-800">æ­£åœ¨ç”Ÿæˆæˆªåœ–...</p>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒå¸¸é‡å®šç¾©
        const DRIVER_ORDER_KEY = 'driverOrders';
        const DRIVER_LOGIN_KEY = 'driverLoggedIn';
        let currentOrder = null; // ç•¶å‰è¨‚å–®æ•¸æ“š
        
        // è¨ˆè²»ç›¸é—œè®Šé‡
        let rideStarted = false;        // æ˜¯å¦é–‹å§‹ä¹˜è»Š
        let ridePaused = false;         // æ˜¯å¦æš«åœè¨ˆè²»
        let startTime = null;           // ä¹˜è»Šé–‹å§‹æ™‚é–“
        let pauseTime = null;           // æš«åœæ™‚é–“
        let totalPauseTime = 0;         // ç¸½æš«åœæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        let currentAmount = 0;          // ç•¶å‰é‡‘é¡
        let currentMileage = 0;         // ç•¶å‰é‡Œç¨‹
        let timerInterval = null;       // è¨ˆæ™‚å™¨
        
        // è¨ˆè²»è¦å‰‡
        const FARE_RULES = {
            startPrice: 80,             // èµ·æ­¥åƒ¹
            startMileage: 1,            // èµ·æ­¥é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰
            perKmPrice: 25,             // æ¯å…¬é‡Œåƒ¹æ ¼
            perMinutePrice: 2           // æ¯åˆ†é˜ç­‰å¾…è²»
        };

        // DOM å…ƒç´ ç²å–
        const driverNameEl = document.getElementById('driver-name');
        const logoutBtn = document.getElementById('logout-btn');
        const orderIdEl = document.getElementById('order-id');
        const orderStatusEl = document.getElementById('order-status');
        const passengerNameEl = document.getElementById('passenger-name');
        const passengerPhoneEl = document.getElementById('passenger-phone');
        const pickupLocationEl = document.getElementById('pickup-location');
        const dropoffLocationEl = document.getElementById('dropoff-location');
        const arriveTimeEl = document.getElementById('arrive-time');
        const rideStartTimeEl = document.getElementById('ride-start-time');
        const currentAmountEl = document.getElementById('current-amount');
        const rideDurationEl = document.getElementById('ride-duration');
        const rideMileageEl = document.getElementById('ride-mileage');
        const startRideBtn = document.getElementById('start-ride-btn');
        const pauseRideBtn = document.getElementById('pause-ride-btn');
        const resumeRideBtn = document.getElementById('resume-ride-btn');
        const arriveDestinationBtn = document.getElementById('arrive-destination-btn');
        const screenshotBtn = document.getElementById('screenshot-btn'); // æ–°å¢æˆªåœ–æŒ‰éˆ•
        const closePageBtn = document.getElementById('close-page-btn');   // æ–°å¢é—œé–‰æŒ‰éˆ•
        const successToast = document.getElementById('success-toast');
        const toastMessage = document.getElementById('toast-message');
        const screenshotLoading = document.getElementById('screenshot-loading');
        const meterPage = document.getElementById('meter-page'); // æˆªåœ–å€åŸŸ

        // åˆå§‹åŒ–é é¢
        window.addEventListener('load', () => {
            // 1. é©—è­‰å¸æ©Ÿç™»éŒ„ç‹€æ…‹
            const loggedInDriver = JSON.parse(localStorage.getItem(DRIVER_LOGIN_KEY));
            if (!loggedInDriver) {
                alert('è«‹å…ˆç™»éŒ„å¸æ©Ÿè³¬è™Ÿï¼');
                window.location.href = 'driver-login.html';
                return;
            }
            driverNameEl.textContent = `æ‚¨å¥½ï¼Œ${loggedInDriver.name || 'å¸æ©Ÿ'}`;

            // 2. è·å–URLä¸­çš„è¨‚å–®ID
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            
            if (!orderId) {
                alert('è¨‚å–®IDä¸å­˜åœ¨ï¼Œè«‹è¿”å›è¨‚å–®åˆ—è¡¨ï¼');
                window.location.href = 'driver-order.html';
                return;
            }

            // 3. åŠ è¼‰è¨‚å–®æ•¸æ“š
            loadOrderData(orderId);
        });

        // åŠ è¼‰è¨‚å–®æ•¸æ“š
        function loadOrderData(orderId) {
            const orders = JSON.parse(localStorage.getItem(DRIVER_ORDER_KEY) || '[]');
            currentOrder = orders.find(order => order.id === orderId);

            if (!currentOrder) {
                alert('è¨‚å–®ä¿¡æ¯ä¸å­˜åœ¨ï¼Œè«‹è¿”å›è¨‚å–®åˆ—è¡¨ï¼');
                window.location.href = 'driver-order.html';
                return;
            }

            // æ¸²æŸ“è¨‚å–®åŸºæœ¬ä¿¡æ¯
            orderIdEl.textContent = currentOrder.id;
            passengerNameEl.textContent = currentOrder.passengerName || '-';
            passengerPhoneEl.textContent = currentOrder.passengerPhone || '-';
            pickupLocationEl.textContent = currentOrder.pickup || '-';
            dropoffLocationEl.textContent = currentOrder.dropoff || '-';
            arriveTimeEl.textContent = currentOrder.arriveTime || 'æœªè¨˜éŒ„';
            
            // è¨­ç½®åˆå§‹é‡‘é¡ï¼ˆèµ·æ­¥åƒ¹ï¼‰
            currentAmount = FARE_RULES.startPrice;
            currentAmountEl.textContent = currentAmount;

            // æ›´æ–°è¨‚å–®ç‹€æ…‹é¡¯ç¤º
            updateOrderStatusDisplay();
        }

        // æ›´æ–°è¨‚å–®ç‹€æ…‹é¡¯ç¤º
        function updateOrderStatusDisplay() {
            switch (currentOrder.status) {
                case 'arrived':
                    orderStatusEl.className = 'bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'å·²æŠµé”ä¸Šè»Šé»';
                    break;
                case 'riding':
                    orderStatusEl.className = 'bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'ä¹˜è»Šä¸­';
                    break;
                case 'completed':
                    orderStatusEl.className = 'bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'å·²å®Œæˆ';
                    break;
                default:
                    orderStatusEl.className = 'bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium';
                    orderStatusEl.textContent = 'æœªçŸ¥ç‹€æ…‹';
            }
        }

        // é¡¯ç¤ºæç¤ºæ¡†
        function showToast(message) {
            toastMessage.textContent = message;
            successToast.classList.remove('hidden');
            
            // 3ç§’å¾Œéš±è—
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ™‚é–“ï¼ˆç§’æ•¸è½‰ç‚º HH:MM:SSï¼‰
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // è¨ˆç®—ç•¶å‰é‡‘é¡
        function calculateAmount(durationSeconds, mileage) {
            let amount = FARE_RULES.startPrice;
            
            // è¶…éèµ·æ­¥é‡Œç¨‹çš„éƒ¨åˆ†è¨ˆè²»
            if (mileage > FARE_RULES.startMileage) {
                const extraMileage = mileage - FARE_RULES.startMileage;
                amount += extraMileage * FARE_RULES.perKmPrice;
            }
            
            // æ™‚é–“è²»ç”¨ï¼ˆæ¯åˆ†é˜ï¼‰
            const minutes = Math.floor(durationSeconds / 60);
            amount += minutes * FARE_RULES.perMinutePrice;
            
            return Math.round(amount);
        }

        // æ›´æ–°è¨ˆè²»é¡¯ç¤º
        function updateMeterDisplay() {
            if (!rideStarted || ridePaused) return;
            
            // è¨ˆç®—å·²éæ™‚é–“ï¼ˆæ‰£é™¤æš«åœæ™‚é–“ï¼‰
            const now = new Date().getTime();
            const elapsedTime = now - startTime - totalPauseTime;
            const elapsedSeconds = Math.floor(elapsedTime / 1000);
            
            // æ›´æ–°æ™‚é•·é¡¯ç¤º
            rideDurationEl.textContent = formatTime(elapsedSeconds);
            
            // æ¨¡æ“¬é‡Œç¨‹å¢é•·ï¼ˆæ¯10ç§’å¢åŠ 0.1å…¬é‡Œï¼‰
            if (elapsedSeconds % 10 === 0) {
                currentMileage += 0.1;
                rideMileageEl.textContent = `${currentMileage.toFixed(1)} KM`;
            }
            
            // è¨ˆç®—ä¸¦æ›´æ–°é‡‘é¡
            currentAmount = calculateAmount(elapsedSeconds, currentMileage);
            currentAmountEl.textContent = currentAmount;
        }

        // é–‹å§‹ä¹˜è»Š
        startRideBtn.addEventListener('click', () => {
            if (rideStarted) return;

            if (confirm('ç¢ºèªé–‹å§‹ä¹˜è»Šï¼Ÿå°‡é–‹å§‹è¨ˆè²»ï¼')) {
                // æ›´æ–°è¨‚å–®ç‹€æ…‹
                const orders = JSON.parse(localStorage.getItem(DRIVER_ORDER_KEY) || '[]');
                const orderIndex = orders.findIndex(order => order.id === currentOrder.id);
                
                if (orderIndex !== -1) {
                    rideStarted = true;
                    startTime = new Date().getTime();
                    orders[orderIndex].status = 'riding';
                    orders[orderIndex].rideStartTime = new Date().toLocaleString('zh-TW');
                    localStorage.setItem(DRIVER_ORDER_KEY, JSON.stringify(orders));
                    
                    // æ›´æ–°ç•¶å‰è¨‚å–®æ•¸æ“š
                    currentOrder = orders[orderIndex];
                    
                    // æ›´æ–°é é¢é¡¯ç¤º
                    rideStartTimeEl.textContent = currentOrder.rideStartTime;
                    updateOrderStatusDisplay();
                    showToast('å·²é–‹å§‹ä¹˜è»Šï¼Œè¨ˆè²»ä¸­...');
                    
                    // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
                    startRideBtn.classList.add('hidden');
                    pauseRideBtn.classList.remove('hidden');
                    
                    // å•Ÿå‹•è¨ˆæ™‚å™¨ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
                    timerInterval = setInterval(updateMeterDisplay, 1000);
                    updateMeterDisplay(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
                }
            }
        });

        // æš«åœè¨ˆè²»
        pauseRideBtn.addEventListener('click', () => {
            if (!rideStarted || ridePaused) return;

            ridePaused = true;
            pauseTime = new Date().getTime();
            
            // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
            pauseRideBtn.classList.add('hidden');
            resumeRideBtn.classList.remove('hidden');
            
            showToast('å·²æš«åœè¨ˆè²»');
        });

        // æ¢å¾©è¨ˆè²»
        resumeRideBtn.addEventListener('click', () => {
            if (!rideStarted || !ridePaused) return;

            const resumeTime = new Date().getTime();
            totalPauseTime += resumeTime - pauseTime;
            ridePaused = false;
            
            // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
            resumeRideBtn.classList.add('hidden');
            pauseRideBtn.classList.remove('hidden');
            
            showToast('å·²æ¢å¾©è¨ˆè²»');
        });

        // æ–°å¢ï¼šæˆªåœ–ä¿å­˜åŠŸèƒ½
        screenshotBtn.addEventListener('click', async () => {
            try {
                // é¡¯ç¤ºåŠ è¼‰æç¤º
                screenshotLoading.classList.remove('hidden');
                
                // ä½¿ç”¨ html2canvas ç”Ÿæˆé é¢æˆªåœ–
                const canvas = await html2canvas(meterPage, {
                    scale: 2, // æé«˜æˆªåœ–åˆ†è¾¨ç‡
                    useCORS: true, // è§£æ±ºè·¨åŸŸåœ–ç‰‡å•é¡Œ
                    logging: false
                });
                
                // å‰µå»ºä¸‹è¼‰éˆæ¥
                const link = document.createElement('a');
                // è¨­ç½®æ–‡ä»¶åï¼ˆè¨‚å–®ID + ç•¶å‰æ™‚é–“ï¼‰
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const fileName = `è¨ˆè²»é é¢_${currentOrder.id}_${timestamp}.png`;
                
                // è¨­ç½®ä¸‹è¼‰å±¬æ€§
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                
                // è§¸ç™¼ä¸‹è¼‰
                link.click();
                
                // éš±è—åŠ è¼‰æç¤º
                screenshotLoading.classList.add('hidden');
                showToast('æˆªåœ–å·²ä¿å­˜åˆ°æ‰‹æ©Ÿï¼');
                
            } catch (error) {
                // éš±è—åŠ è¼‰æç¤º
                screenshotLoading.classList.add('hidden');
                alert('æˆªåœ–å¤±æ•—ï¼š' + error.message);
            }
        });

        // åˆ°é”ç›®çš„åœ°ï¼ˆçµæŸè¡Œç¨‹ï¼‰
        arriveDestinationBtn.addEventListener('click', () => {
            if (!rideStarted) {
                alert('å°šæœªé–‹å§‹ä¹˜è»Šï¼Œç„¡æ³•çµæŸè¡Œç¨‹ï¼');
                return;
            }

            if (confirm(`ç¢ºèªåˆ°é”ç›®çš„åœ°ï¼Ÿæœ€çµ‚è²»ç”¨ï¼šNT$ ${currentAmount}`)) {
                // åœæ­¢è¨ˆæ™‚å™¨
                clearInterval(timerInterval);
                
                // æ›´æ–°è¨‚å–®ç‹€æ…‹
                const orders = JSON.parse(localStorage.getItem(DRIVER_ORDER_KEY) || '[]');
                const orderIndex = orders.findIndex(order => order.id === currentOrder.id);
                
                if (orderIndex !== -1) {
                    // è¨ˆç®—ç¸½è¡Œç¨‹æ™‚é–“
                    const endTime = new Date().getTime();
                    const totalRideTime = Math.floor((endTime - startTime - totalPauseTime) / 1000);
                    
                    // æ›´æ–°è¨‚å–®æ•¸æ“š
                    orders[orderIndex].status = 'completed';
                    orders[orderIndex].rideEndTime = new Date().toLocaleString('zh-TW');
                    orders[orderIndex].totalRideTime = formatTime(totalRideTime);
                    orders[orderIndex].totalMileage = currentMileage.toFixed(1);
                    orders[orderIndex].finalAmount = currentAmount;
                    localStorage.setItem(DRIVER_ORDER_KEY, JSON.stringify(orders));
                    
                    showToast(`è¡Œç¨‹çµæŸï¼æœ€çµ‚è²»ç”¨ï¼šNT$ ${currentAmount}`);
                    
                    // å»¶é²è·³è½‰åˆ°å®Œæˆé 
                    setTimeout(() => {
                        // æ”œå¸¶è¨‚å–®IDå’Œæœ€çµ‚é‡‘é¡è·³è½‰
                        window.location.href = `driver-complete.html?orderId=${currentOrder.id}&finalAmount=${currentAmount}`;
                    }, 2000);
                }
            }
        });

        // æ–°å¢ï¼šé—œé–‰é é¢è·³è½‰åˆ° driver-complete.html
        closePageBtn.addEventListener('click', () => {
            if (confirm('ç¢ºèªé—œé–‰è¨ˆè²»é é¢ï¼Ÿå°‡è·³è½‰åˆ°è¡Œç¨‹å®Œæˆé ï¼')) {
                // åœæ­¢è¨ˆæ™‚å™¨ï¼ˆå¦‚æœæ­£åœ¨è¨ˆæ™‚ï¼‰
                if (timerInterval) clearInterval(timerInterval);
                
                // è·³è½‰åˆ°å®Œæˆé ï¼ˆæ”œå¸¶è¨‚å–®IDï¼‰
                window.location.href = `driver-complete.html?orderId=${currentOrder.id}`;
            }
        });

        // é€€å‡ºç™»éŒ„
        logoutBtn.addEventListener('click', () => {
            if (confirm('ç¢ºèªé€€å‡ºç™»éŒ„å—ï¼Ÿ')) {
                // åœæ­¢è¨ˆæ™‚å™¨ï¼ˆå¦‚æœæ­£åœ¨è¨ˆæ™‚ï¼‰
                if (timerInterval) clearInterval(timerInterval);
                
                localStorage.removeItem(DRIVER_LOGIN_KEY);
                window.location.href = 'driver-login.html';
            }
        });

        // é é¢é—œé–‰æ™‚åœæ­¢è¨ˆæ™‚å™¨
        window.addEventListener('beforeunload', () => {
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>