<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>搭車自由 - 司機接單</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00A86B',
            secondary: '#1E40AF',
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .btn-primary { @apply bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors; }
      .btn-secondary { @apply bg-secondary text-white py-2 px-4 rounded-lg hover:bg-secondary/90 transition-colors; }
      .card { @apply bg-white rounded-xl shadow-md p-4 mb-4; }
      .order-item { @apply border border-gray-200 rounded-lg p-4 mb-3 bg-white shadow-sm; }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
  <header class="bg-white shadow-md py-4 px-6">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold text-primary flex items-center">
        <i class="fa fa-taxi mr-2"></i> 搭車自由 - 司機接單
      </h1>
      <div id="team-info" class="text-gray-700 font-medium"></div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- 車隊選擇（若URL無參數則顯示） -->
    <div id="team-select-container" class="card mb-6 hidden">
      <label class="block text-sm font-medium text-gray-700 mb-2">選擇所屬車隊</label>
      <select id="driver-team-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        <option value="">請選擇車隊</option>
        <!-- 動態填充車隊 -->
      </select>
    </div>

    <!-- 訂單列表 -->
    <h2 class="text-lg font-bold mb-4">待接訂單</h2>
    <div id="orders-list" class="space-y-3">
      <p class="text-gray-500 text-center py-8">加載中...請稍候</p>
    </div>
  </main>

  <script>
    // Firebase配置（替換為你的真實配置）
    const firebaseConfig = {
      apiKey: "你的API Key",
      authDomain: "你的Auth Domain",
      databaseURL: "你的Database URL",
      projectId: "你的Project ID",
      storageBucket: "你的Storage Bucket",
      messagingSenderId: "你的Sender ID",
      appId: "你的App ID"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // 全局變量
    let currentDriverTeamId = '';

    // 初始化車隊選擇
    function initTeamSelect() {
      // 從URL讀取車隊ID
      const urlParams = new URLSearchParams(window.location.search);
      const urlTeamId = urlParams.get('team');
      
      const teamSelect = document.getElementById('driver-team-id');
      const teamInfoEl = document.getElementById('team-info');
      const selectContainer = document.getElementById('team-select-container');

      // 加載所有車隊
      db.ref('teams').once('value', (snapshot) => {
        const teams = snapshot.val() || {};
        const teamIds = Object.keys(teams);
        
        // 填充車隊選擇框
        teamIds.forEach(teamId => {
          const team = teams[teamId];
          teamSelect.innerHTML += `<option value="${teamId}">${team.name || teamId}</option>`;
        });

        // URL有車隊ID則自動選擇
        if (urlTeamId) {
          currentDriverTeamId = urlTeamId;
          teamSelect.value = urlTeamId;
          teamInfoEl.textContent = `當前車隊：${teams[urlTeamId]?.name || urlTeamId}`;
          selectContainer.classList.add('hidden'); // 隱藏選擇框
          listenActiveOrders(); // 加載訂單
        } else {
          selectContainer.classList.remove('hidden'); // 顯示選擇框
          teamInfoEl.textContent = '';
        }
      });

      // 車隊選擇改變時加載訂單
      teamSelect.addEventListener('change', () => {
        currentDriverTeamId = teamSelect.value;
        const teams = JSON.parse(localStorage.getItem('teams') || '{}');
        teamInfoEl.textContent = `當前車隊：${teams[currentDriverTeamId]?.name || currentDriverTeamId}`;
        listenActiveOrders();
      });
    }

    // 監聽訂單變化
    function listenActiveOrders() {
      if (!currentDriverTeamId) return;
      
      const ordersListEl = document.getElementById('orders-list');
      ordersListEl.innerHTML = '<p class="text-gray-500 text-center py-8">加載中...請稍候</p>';

      // 只加載當前車隊的待接單
      db.ref('activeOrders')
        .orderByChild('teamId')
        .equalTo(currentDriverTeamId)
        .on('value', (snapshot) => {
          const orders = snapshot.val() || {};
          const orderIds = Object.keys(orders);
          
          // 過濾出待接單
          const pendingOrders = orderIds.filter(id => orders[id].status === '待接單');
          
          if (pendingOrders.length === 0) {
            ordersListEl.innerHTML = '<p class="text-gray-500 text-center py-8">當前車隊暫無待接訂單</p>';
            return;
          }
          
          // 渲染訂單
          let html = '';
          pendingOrders.forEach(orderId => {
            const order = orders[orderId];
            html += `
              <div class="order-item">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-bold text-lg">訂單ID：${order.orderId || orderId}</h3>
                  <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">待接單</span>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                  <div>
                    <i class="fa fa-user text-primary mr-1"></i> 乘客：${order.name}
                  </div>
                  <div>
                    <i class="fa fa-phone text-primary mr-1"></i> 電話：${order.phone}
                  </div>
                  <div class="col-span-2">
                    <i class="fa fa-map-marker text-red-500 mr-1"></i> 上車：${order.pickup}
                  </div>
                  <div class="col-span-2">
                    <i class="fa fa-map-marker text-green-500 mr-1"></i> 下車：${order.dropoff}
                  </div>
                  ${order.remark ? `<div class="col-span-2"><i class="fa fa-comment text-gray-500 mr-1"></i> 備註：${order.remark}</div>` : ''}
                  <div class="col-span-2">
                    <i class="fa fa-clock-o text-gray-500 mr-1"></i> 提交時間：${order.createTime}
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="acceptOrder('${orderId}')" class="btn-primary flex-1">
                    <i class="fa fa-check mr-1"></i> 接單
                  </button>
                </div>
              </div>
            `;
          });
          
          ordersListEl.innerHTML = html;
        });
    }

    // 接單操作
    function acceptOrder(orderId) {
      if (!confirm('確認接此訂單？')) return;
      
      // 更新訂單狀態
      db.ref(`activeOrders/${orderId}`).update({
        status: '已接單',
        acceptTime: new Date().toLocaleString('zh-TW')
      }).then(() => {
        alert('接單成功！請儘快聯繫乘客');
      }).catch(err => {
        console.error('接單失敗:', err);
        alert('接單失敗，請稍後重試');
      });
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      initTeamSelect();
    });
  </script>
</body>
</html>