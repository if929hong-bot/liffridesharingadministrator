<!-- register.html（車隊管理員註冊頁） -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>車隊管理員註冊</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#228B22',
            secondary: '#6c757d',
            danger: '#dc3545',
            success: '#198754'
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .form-input {
        @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-all;
      }
      .form-label {
        @apply block text-gray-700 mb-2 font-medium;
      }
      .btn-primary {
        @apply w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 active:bg-primary/80 transition-all duration-200 font-medium;
      }
      .form-error {
        @apply text-danger text-sm mt-1 hidden;
      }
      .form-success {
        @apply text-success text-sm mt-1 hidden;
      }
      .input-error {
        @apply border-danger focus:ring-danger/40 focus:border-danger;
      }
      .input-success {
        @apply border-success focus:ring-success/40 focus:border-success;
      }
      .shake-animation {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      }
      @keyframes shake {
        10%, 90% { transform: translateX(-1px); }
        20%, 80% { transform: translateX(2px); }
        30%, 50%, 70% { transform: translateX(-4px); }
        40%, 60% { transform: translateX(4px); }
      }
    }
  </style>

  <style>
    /* Utils工具類樣式 */
    .utils-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 300px;
      width: 100%;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease forwards;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .utils-alert.success {
      background: #f0fdf4;
      color: #065f46;
    }
    .utils-alert.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .utils-alert.warning {
      background: #fffbeb;
      color: #92400e;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #228B22;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      right: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      animation: spin 1s linear infinite;
    }
    /* 密碼強度指示器 */
    .password-strength {
      height: 4px;
      width: 100%;
      background: #eee;
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    .strength-bar {
      height: 100%;
      transition: width 0.3s ease;
    }
    .strength-weak {
      width: 33%;
      background: #dc3545;
    }
    .strength-medium {
      width: 66%;
      background: #ffc107;
    }
    .strength-strong {
      width: 100%;
      background: #198754;
    }
  </style>

  <script>
    /**
     * 全局工具類 - 提升網站穩定性、統一處理通用邏輯
     * 適用於所有車隊管理系統頁面（管理員註冊/登入/後台管理）
     */
    const Utils = {
      // ========== 基礎工具方法 ==========
      /**
       * 安全解析JSON（避免解析失敗導致頁面崩潰）
       * @param {string} str - 要解析的JSON字串
       * @returns {any|null} 解析後的數據，失敗返回null
       */
      safeParseJSON(str) {
        try {
          return str && str !== 'null' && str !== 'undefined' ? JSON.parse(str) : null;
        } catch (e) {
          console.error('JSON解析失敗:', e, '原始字串:', str);
          return null;
        }
      },

      /**
       * 安全獲取DOM元素（避免操作空元素報錯）
       * @param {string} id - 元素ID
       * @returns {HTMLElement|null} 元素對象或null
       */
      safeGetElement(id) {
        const el = document.getElementById(id);
        if (!el) console.warn(`[Utils] 元素#${id}不存在`);
        return el;
      },

      /**
       * 驗證數字輸入（適用價格、金額等表單）
       * @param {string} value - 輸入值
       * @param {boolean} allowZero - 是否允許0（預設不允許）
       * @returns {boolean} 是否有效
       */
      validateNumber(value, allowZero = false) {
        const trimmed = value.trim();
        // 驗證是否為純數字
        if (!/^\d+$/.test(trimmed)) return false;
        // 驗證是否大於0（如果不允許0）
        if (!allowZero && Number(trimmed) <= 0) return false;
        return true;
      },

      /**
       * 顯示統一提示訊息（取代alert，提升體驗）
       * @param {string} message - 提示內容
       * @param {string} type - 類型 success/error/warning
       * @param {number} duration - 自動關閉時間（秒，預設3秒）
       */
      showMessage(message, type = 'success', duration = 3) {
        // 移除已存在的提示
        const oldAlert = document.querySelector('.utils-alert');
        if (oldAlert) oldAlert.remove();
        
        // 創建提示元素
        const alertEl = document.createElement('div');
        alertEl.className = `utils-alert ${type}`;
        
        // 設置圖標
        const iconMap = {
          success: '<i class="fa fa-check-circle"></i>',
          error: '<i class="fa fa-times-circle"></i>',
          warning: '<i class="fa fa-exclamation-circle"></i>'
        };
        
        alertEl.innerHTML = `
          ${iconMap[type] || iconMap.success}
          <span>${message}</span>
        `;
        
        // 添加到頁面
        document.body.appendChild(alertEl);
        
        // 自動移除
        if (duration > 0) {
          setTimeout(() => {
            alertEl.style.animation = 'slideIn 0.3s ease reverse forwards';
            setTimeout(() => alertEl.remove(), 300);
          }, duration * 1000);
        }
        
        return alertEl;
      },

      // ========== 本地存儲管理（帶過期機制） ==========
      Storage: {
        /**
         * 儲存數據到localStorage（自動序列化+設置過期）
         * @param {string} key - 儲存鍵名
         * @param {any} data - 要儲存的數據
         * @param {number} expireHours - 過期小時（預設24小時）
         */
        set(key, data, expireHours = 24) {
          try {
            const value = JSON.stringify(data);
            localStorage.setItem(key, value);
            // 設置過期時間戳
            if (expireHours) {
              const expireTime = Date.now() + expireHours * 60 * 60 * 1000;
              localStorage.setItem(`${key}_expire`, expireTime);
            }
          } catch (e) {
            console.error('[Storage] 儲存失敗:', e);
            Utils.showMessage('本地存儲空間不足，無法保存數據！', 'error');
          }
        },

        /**
         * 從localStorage獲取數據（自動檢查過期）
         * @param {string} key - 儲存鍵名
         * @returns {any|null} 儲存的數據，過期/不存在返回null
         */
        get(key) {
          try {
            const expireTime = localStorage.getItem(`${key}_expire`);
            // 檢查是否過期
            if (expireTime && Date.now() > Number(expireTime)) {
              this.remove(key);
              return null;
            }
            // 解析並返回數據
            return Utils.safeParseJSON(localStorage.getItem(key));
          } catch (e) {
            console.error('[Storage] 讀取失敗:', e);
            return null;
          }
        },

        /**
         * 移除localStorage中的數據（包含過期標記）
         * @param {string} key - 儲存鍵名
         */
        remove(key) {
          localStorage.removeItem(key);
          localStorage.removeItem(`${key}_expire`);
        },

        /**
         * 檢查重複的管理員帳號
         * @param {string} account - 要檢查的帳號
         * @param {string} storageKey - 存儲鍵名
         * @returns {boolean} 是否已存在
         */
        checkDuplicateAccount(account, storageKey = 'fleetManagers') {
          const managers = this.get(storageKey) || [];
          return managers.some(manager => 
            manager.managerAccount === account || 
            manager.account === account || 
            manager.帳號 === account
          );
        },

        /**
         * 檢查重複的管理員信箱
         * @param {string} email - 要檢查的信箱
         * @param {string} storageKey - 存儲鍵名
         * @returns {boolean} 是否已存在
         */
        checkDuplicateEmail(email, storageKey = 'fleetManagers') {
          const managers = this.get(storageKey) || [];
          return managers.some(manager => 
            manager.managerEmail === email || 
            manager.email === email || 
            manager.信箱 === email
          );
        },

        /**
         * 清空所有車隊管理系統相關存儲
         */
        clearAllFleetData() {
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.includes('fleet') || key.includes('admin') || key.includes('manager') || key.includes('driver') || key.includes('order')) {
              this.remove(key);
            }
          });
        }
      },

      // ========== UI增強方法 ==========
      /**
       * 顯示加載狀態（適用按鈕/頁面加載場景）
       * @param {HTMLElement} el - 要顯示加載狀態的元素（可選）
       * @param {string} text - 加載提示文字（預設：處理中...）
       */
      showLoading(el, text = '處理中...') {
        // 頁面級加載
        if (!el) {
          const loadingEl = document.createElement('div');
          loadingEl.className = 'loading-overlay';
          loadingEl.innerHTML = `
            <div class="flex flex-col items-center gap-3">
              <div class="loading-spinner"></div>
              <span class="text-gray-700 text-base">${text}</span>
            </div>
          `;
          loadingEl.id = 'page-loading';
          document.body.appendChild(loadingEl);
          return;
        }

        // 元素級加載
        if (!el) return;
        el.disabled = true;
        el.classList.add('btn-loading');
        const originalText = el.innerHTML;
        el.setAttribute('data-original-text', originalText);
        el.innerHTML = text;
      },

      /**
       * 隱藏加載狀態
       * @param {HTMLElement} el - 要還原的元素（可選）
       * @param {string} restoreText - 還原的按鈕文字（可選）
       */
      hideLoading(el, restoreText = '') {
        // 移除頁面級加載
        const pageLoading = document.getElementById('page-loading');
        if (pageLoading) pageLoading.remove();

        // 還原元素級加載
        if (el) {
          el.disabled = false;
          el.classList.remove('btn-loading');
          const originalText = el.getAttribute('data-original-text');
          if (originalText) el.innerHTML = originalText;
          else if (restoreText) el.innerHTML = restoreText;
        }
      },

      /**
       * 安全跳轉頁面（帶加載狀態和錯誤處理）
       * @param {string} url - 目標URL
       * @param {string} message - 跳轉前提示訊息
       */
      safeNavigate(url, message = '') {
        try {
          // 顯示提示
          if (message) Utils.showMessage(message, 'success');
          
          // 顯示頁面加載
          Utils.showLoading(null, '正在跳轉...');
          
          // 延遲跳轉提升體驗
          setTimeout(() => {
            window.location.href = url;
          }, 800);
        } catch (e) {
          console.error('跳轉失敗:', e);
          Utils.hideLoading();
          Utils.showMessage('頁面跳轉失敗，請手動操作', 'error');
        }
      },

      // ========== 表單驗證專用方法 ==========
      FormValidator: {
        /**
         * 驗證台灣手機號碼
         * @param {string} phone - 手機號碼
         * @returns {boolean} 是否有效
         */
        validateTaiwanPhone(phone) {
          // 移除所有非數字字符
          const cleanPhone = phone.replace(/[^0-9]/g, '');
          // 台灣手機號格式：09開頭，共10位數字
          const phoneRegex = /^09\d{8}$/;
          return phoneRegex.test(cleanPhone);
        },

        /**
         * 驗證電子信箱格式
         * @param {string} email - 電子信箱
         * @returns {boolean} 是否有效
         */
        validateEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
        },

        /**
         * 驗證密碼強度
         * @param {string} password - 密碼
         * @returns {object} { strength: 'weak'|'medium'|'strong', isValid: boolean }
         */
        validatePasswordStrength(password) {
          let strength = 'weak';
          let isValid = false;
          
          // 密碼長度至少8位
          if (password.length < 8) {
            return { strength, isValid: false };
          }
          
          // 檢查密碼強度
          let score = 0;
          
          // 包含數字
          if (/[0-9]/.test(password)) score++;
          // 包含小寫字母
          if (/[a-z]/.test(password)) score++;
          // 包含大寫字母
          if (/[A-Z]/.test(password)) score++;
          // 包含特殊字符
          if (/[^0-9a-zA-Z]/.test(password)) score++;
          
          // 評定強度
          if (score >= 3) {
            strength = 'strong';
            isValid = true;
          } else if (score >= 2) {
            strength = 'medium';
            isValid = true;
          } else if (score >= 1 && password.length >= 10) {
            strength = 'medium';
            isValid = true;
          }
          
          return { strength, isValid };
        },

        /**
         * 驗證車隊管理員註冊表單
         * @param {object} formData - 表單數據
         * @returns {object} { isValid: boolean, errors: array }
         */
        validateRegisterForm(formData) {
          const errors = [];
          
          // 驗證車隊名稱
          if (!formData.fleetName || formData.fleetName.trim().length < 2) {
            errors.push('車隊名稱至少需要2個字符！');
          }
          
          // 驗證管理員姓名
          if (!formData.managerName || formData.managerName.trim().length < 2) {
            errors.push('管理員姓名至少需要2個字符！');
          }
          
          // 驗證手機號碼
          if (!this.validateTaiwanPhone(formData.managerPhone)) {
            errors.push('請輸入有效的台灣手機號碼（09開頭，共10位）！');
          }
          
          // 驗證信箱
          if (!this.validateEmail(formData.managerEmail)) {
            errors.push('請輸入有效的電子信箱格式！');
          }
          
          // 檢查信箱是否已存在
          if (Utils.Storage.checkDuplicateEmail(formData.managerEmail)) {
            errors.push('此信箱已被註冊，請更換其他信箱！');
          }
          
          // 驗證帳號
          if (!formData.managerAccount || formData.managerAccount.trim().length < 3) {
            errors.push('帳號至少需要3個字符！');
          } else if (formData.managerAccount.trim().length > 20) {
            errors.push('帳號長度不能超過20個字符！');
          }
          
          // 檢查帳號是否已存在
          if (Utils.Storage.checkDuplicateAccount(formData.managerAccount)) {
            errors.push('此帳號已被使用，請更換其他帳號！');
          }
          
          // 驗證密碼
          const passwordCheck = this.validatePasswordStrength(formData.managerPassword);
          if (!passwordCheck.isValid) {
            errors.push('密碼強度不足，請包含數字、字母等多種字符！');
          }
          
          // 驗證密碼確認
          if (formData.managerPassword !== formData.managerPasswordConfirm) {
            errors.push('兩次輸入的密碼不一致！');
          }
          
          return {
            isValid: errors.length === 0,
            errors: errors
          };
        }
      },

      // ========== 管理員註冊專用方法 ==========
      AdminRegister: {
        /**
         * 處理管理員註冊
         * @param {object} formData - 表單數據
         * @returns {boolean} 是否註冊成功
         */
        async processRegistration(formData) {
          try {
            // 驗證表單數據
            const validation = Utils.FormValidator.validateRegisterForm(formData);
            if (!validation.isValid) {
              // 顯示所有錯誤
              validation.errors.forEach(error => {
                Utils.showMessage(error, 'error');
              });
              return false;
            }
            
            // 準備註冊數據
            const registerData = {
              fleetName: formData.fleetName.trim(),
              managerName: formData.managerName.trim(),
              managerPhone: formData.managerPhone.replace(/[^0-9]/g, ''),
              managerEmail: formData.managerEmail.trim().toLowerCase(),
              managerAccount: formData.managerAccount.trim(),
              managerPassword: formData.managerPassword, // 實際專案中應加密存儲
              status: "待審核",
              registerTime: new Date().toLocaleString('zh-TW'),
              registerTimeStamp: Date.now(),
              id: `FM-${Date.now()}`
            };
            
            // 獲取現有數據
            let fleetManagers = Utils.Storage.get('fleetManagers') || [];
            
            // 添加新管理員
            fleetManagers.push(registerData);
            
            // 保存到本地存儲
            Utils.Storage.set('fleetManagers', fleetManagers, 0); // 永久保存
            
            // 顯示成功提示
            Utils.showMessage('註冊申請已提交，請等待超級管理員審核！', 'success', 5);
            
            // 記錄註冊日志
            this.logRegistration(registerData);
            
            return true;
          } catch (error) {
            console.error('處理註冊失敗:', error);
            Utils.showMessage('註冊處理失敗，請稍後重試！', 'error');
            return false;
          }
        },

        /**
         * 記錄註冊日志
         * @param {object} registerData - 註冊數據
         */
        logRegistration(registerData) {
          try {
            const registerLogs = Utils.Storage.get('register_logs') || [];
            
            registerLogs.push({
              account: registerData.managerAccount,
              email: registerData.managerEmail,
              fleetName: registerData.fleetName,
              timestamp: Date.now(),
              time: new Date().toLocaleString('zh-TW'),
              status: 'pending'
            });
            
            // 保存日志（30天過期）
            Utils.Storage.set('register_logs', registerLogs, 30 * 24);
          } catch (error) {
            console.error('記錄註冊日志失敗:', error);
          }
        }
      }
    };

    // ========== 頁面初始化 ==========
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化表單驗證
      initFormValidation();
      
      // 初始化密碼強度檢測
      initPasswordStrengthChecker();
      
      // 初始化表單提交事件
      initFormSubmit();
      
      // 顯示歡迎提示
      Utils.showMessage('歡迎註冊車隊管理員帳號', 'success', 2);
    });

    // ========== 表單驗證初始化 ==========
    function initFormValidation() {
      // 即時驗證手機號
      const phoneInput = Utils.safeGetElement('managerPhone');
      if (phoneInput) {
        phoneInput.addEventListener('blur', (e) => {
          const value = e.target.value;
          if (value && !Utils.FormValidator.validateTaiwanPhone(value)) {
            e.target.classList.add('input-error');
            Utils.showMessage('請輸入有效的台灣手機號碼（09開頭，共10位）', 'warning');
          } else if (value) {
            e.target.classList.remove('input-error');
            e.target.classList.add('input-success');
          } else {
            e.target.classList.remove('input-error', 'input-success');
          }
        });
      }
      
      // 即時驗證信箱
      const emailInput = Utils.safeGetElement('managerEmail');
      if (emailInput) {
        emailInput.addEventListener('blur', (e) => {
          const value = e.target.value;
          if (value && !Utils.FormValidator.validateEmail(value)) {
            e.target.classList.add('input-error');
            Utils.showMessage('請輸入有效的電子信箱格式', 'warning');
          } else if (value) {
            // 檢查信箱是否已存在
            if (Utils.Storage.checkDuplicateEmail(value)) {
              e.target.classList.add('input-error');
              Utils.showMessage('此信箱已被註冊，請更換其他信箱', 'error');
            } else {
              e.target.classList.remove('input-error');
              e.target.classList.add('input-success');
            }
          } else {
            e.target.classList.remove('input-error', 'input-success');
          }
        });
      }
      
      // 即時驗證帳號
      const accountInput = Utils.safeGetElement('managerAccount');
      if (accountInput) {
        accountInput.addEventListener('blur', (e) => {
          const value = e.target.value.trim();
          if (value) {
            if (value.length < 3 || value.length > 20) {
              e.target.classList.add('input-error');
              Utils.showMessage('帳號長度需在3-20個字符之間', 'warning');
            } else if (Utils.Storage.checkDuplicateAccount(value)) {
              e.target.classList.add('input-error');
              Utils.showMessage('此帳號已被使用，請更換其他帳號', 'error');
            } else {
              e.target.classList.remove('input-error');
              e.target.classList.add('input-success');
            }
          } else {
            e.target.classList.remove('input-error', 'input-success');
          }
        });
        
        // 限制帳號輸入特殊字符
        accountInput.addEventListener('input', (e) => {
          // 只允許字母、數字、下劃線
          const cleanValue = e.target.value.replace(/[^\w]/g, '');
          if (cleanValue !== e.target.value) {
            e.target.value = cleanValue;
            Utils.showMessage('帳號僅支持字母、數字和下劃線', 'warning', 2);
          }
        });
      }
      
      // 密碼確認驗證
      const passwordConfirmInput = Utils.safeGetElement('managerPasswordConfirm');
      if (passwordConfirmInput) {
        passwordConfirmInput.addEventListener('blur', (e) => {
          const password = Utils.safeGetElement('managerPassword')?.value || '';
          const confirmPassword = e.target.value;
          
          if (confirmPassword && password && confirmPassword !== password) {
            e.target.classList.add('input-error');
            Utils.showMessage('兩次輸入的密碼不一致', 'error');
          } else if (confirmPassword) {
            e.target.classList.remove('input-error');
            e.target.classList.add('input-success');
          } else {
            e.target.classList.remove('input-error', 'input-success');
          }
        });
      }
    }

    // ========== 密碼強度檢測初始化 ==========
    function initPasswordStrengthChecker() {
      const passwordInput = Utils.safeGetElement('managerPassword');
      if (!passwordInput) return;
      
      // 創建密碼強度指示器
      const strengthContainer = document.createElement('div');
      strengthContainer.className = 'password-strength';
      
      const strengthBar = document.createElement('div');
      strengthBar.className = 'strength-bar strength-weak';
      
      strengthContainer.appendChild(strengthBar);
      passwordInput.parentNode.appendChild(strengthContainer);
      
      // 創建強度提示文本
      const strengthText = document.createElement('div');
      strengthText.className = 'text-xs mt-1 text-gray-500';
      strengthText.textContent = '密碼強度：弱';
      passwordInput.parentNode.appendChild(strengthText);
      
      // 即時檢測密碼強度
      passwordInput.addEventListener('input', (e) => {
        const password = e.target.value;
        const result = Utils.FormValidator.validatePasswordStrength(password);
        
        // 更新強度指示器
        strengthBar.className = `strength-bar strength-${result.strength}`;
        
        // 更新提示文本
        const strengthLabels = {
          weak: '密碼強度：弱（建議包含數字、大小寫字母和特殊字符）',
          medium: '密碼強度：中（可以更強）',
          strong: '密碼強度：強（非常安全）'
        };
        
        strengthText.textContent = strengthLabels[result.strength];
        
        // 更新樣式
        if (password.length < 8) {
          strengthText.className = 'text-xs mt-1 text-danger';
          strengthText.textContent = '密碼長度至少需要8個字符！';
          passwordInput.classList.add('input-error');
          passwordInput.classList.remove('input-success');
        } else if (!result.isValid) {
          strengthText.className = 'text-xs mt-1 text-warning';
          passwordInput.classList.add('input-error');
          passwordInput.classList.remove('input-success');
        } else {
          strengthText.className = `text-xs mt-1 ${result.strength === 'strong' ? 'text-success' : 'text-warning'}`;
          passwordInput.classList.remove('input-error');
          passwordInput.classList.add('input-success');
        }
      });
    }

    // ========== 表單提交初始化 ==========
    function initFormSubmit() {
      const registerForm = Utils.safeGetElement('fleetManagerRegisterForm');
      if (!registerForm) return;

      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 獲取表單數據
        const formData = {
          fleetName: Utils.safeGetElement('fleetName')?.value.trim() || '',
          managerName: Utils.safeGetElement('managerName')?.value.trim() || '',
          managerPhone: Utils.safeGetElement('managerPhone')?.value.trim() || '',
          managerEmail: Utils.safeGetElement('managerEmail')?.value.trim() || '',
          managerAccount: Utils.safeGetElement('managerAccount')?.value.trim() || '',
          managerPassword: Utils.safeGetElement('managerPassword')?.value || '',
          managerPasswordConfirm: Utils.safeGetElement('managerPasswordConfirm')?.value || ''
        };
        
        const submitBtn = e.submitter || registerForm.querySelector('button[type="submit"]');
        
        try {
          // 顯示加載狀態
          if (submitBtn) {
            Utils.showLoading(submitBtn, '<i class="fa fa-spinner fa-spin mr-2"></i> 提交註冊中...');
          }
          
          // 處理註冊
          const registerSuccess = await Utils.AdminRegister.processRegistration(formData);
          
          if (registerSuccess) {
            // 重置表單
            registerForm.reset();
            
            // 移除所有輸入框的狀態類
            const inputs = registerForm.querySelectorAll('input');
            inputs.forEach(input => {
              input.classList.remove('input-error', 'input-success');
            });
            
            // 延遲跳轉到登入頁
            setTimeout(() => {
              Utils.safeNavigate('login.html', '註冊成功！請等待超管審核後登入');
            }, 2000);
          }
          
        } catch (error) {
          console.error('註冊失敗:', error);
          
          // 隱藏加載狀態
          if (submitBtn) {
            Utils.hideLoading(submitBtn);
          }
          
          // 表單抖動效果
          registerForm.classList.add('shake-animation');
          setTimeout(() => {
            registerForm.classList.remove('shake-animation');
          }, 500);
          
          // 顯示錯誤提示
          Utils.showMessage('註冊處理異常，請檢查表單數據或稍後重試', 'error');
        } finally {
          // 確保隱藏加載狀態
          if (submitBtn) {
            Utils.hideLoading(submitBtn);
          }
        }
      });
    }
  </script>
</head>
<body class="bg-gray-100">
  <div class="max-w-md mx-auto p-8 bg-white rounded-lg shadow-md mt-10 mb-10">
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-full mb-4">
        <i class="fa fa-user-plus text-primary text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2 text-gray-800">車隊管理員註冊</h2>
      <p class="text-gray-500 text-sm">填寫以下信息完成註冊，審核通過後即可登入</p>
    </div>
    
    <form id="fleetManagerRegisterForm" class="space-y-5">
      <!-- 車隊名稱 -->
      <div>
        <label class="form-label" for="fleetName">車隊名稱 <span class="text-danger">*</span></label>
        <input type="text" id="fleetName" class="form-input" placeholder="請輸入車隊完整名稱" required>
      </div>
      
      <!-- 管理員姓名 -->
      <div>
        <label class="form-label" for="managerName">管理員姓名 <span class="text-danger">*</span></label>
        <input type="text" id="managerName" class="form-input" placeholder="請輸入真實姓名" required>
      </div>
      
      <!-- 聯繫電話 -->
      <div>
        <label class="form-label" for="managerPhone">聯繫電話 <span class="text-danger">*</span></label>
        <input type="tel" id="managerPhone" class="form-input" placeholder="請輸入09開頭的手機號碼" required>
        <div class="text-xs text-gray-500 mt-1">格式：0912345678</div>
      </div>
      
      <!-- 信箱 -->
      <div>
        <label class="form-label" for="managerEmail">電子信箱 <span class="text-danger">*</span></label>
        <input type="email" id="managerEmail" class="form-input" placeholder="用於密碼重設和通知" required>
      </div>
      
      <!-- 帳號 -->
      <div>
        <label class="form-label" for="managerAccount">登入帳號 <span class="text-danger">*</span></label>
        <input type="text" id="managerAccount" class="form-input" placeholder="設定您的登入帳號" required>
        <div class="text-xs text-gray-500 mt-1">僅支持字母、數字和下劃線，3-20個字符</div>
      </div>
      
      <!-- 密碼 -->
      <div>
        <label class="form-label" for="managerPassword">密碼 <span class="text-danger">*</span></label>
        <input type="password" id="managerPassword" class="form-input" placeholder="至少8位，包含數字和字母" minlength="8" required>
      </div>
      
      <!-- 密碼確認 -->
      <div>
        <label class="form-label" for="managerPasswordConfirm">確認密碼 <span class="text-danger">*</span></label>
        <input type="password" id="managerPasswordConfirm" class="form-input" placeholder="再次輸入密碼" minlength="8" required>
      </div>
      
      <!-- 服務條款 -->
      <div class="flex items-start">
        <input type="checkbox" id="termsAgree" class="mt-1 mr-2" required>
        <label for="termsAgree" class="text-sm text-gray-600">
          我已閱讀並同意<a href="#" class="text-primary hover:underline">服務條款</a>和<a href="#" class="text-primary hover:underline">隱私政策</a>
        </label>
      </div>
      
      <!-- 提交按鈕 -->
      <button type="submit" class="btn-primary">
        <i class="fa fa-paper-plane mr-2"></i> 提交註冊申請
      </button>
    </form>
    
    <!-- 登入連結 -->
    <div class="mt-8 text-center pt-6 border-t border-gray-100">
      <p class="text-gray-600">已有管理員帳號？
        <a href="login.html" class="text-primary hover:underline font-medium">立即登入</a>
      </p>
    </div>
    
    <!-- 提示信息 -->
    <div class="mt-4 text-xs text-gray-500 text-center">
      <p><i class="fa fa-info-circle mr-1"></i> 註冊提交後，超級管理員將在1-2個工作日內完成審核</p>
      <p class="mt-1"><i class="fa fa-envelope-o mr-1"></i> 審核結果將通過電子信箱通知您</p>
    </div>
  </div>
</body>
</html>