<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è»ŠéšŠç®¡ç†å“¡ç™»å…¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f0f2f5;
      font-family: "Microsoft JhengHei", sans-serif;
    }
    .login-card {
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .error-tip {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="login-card bg-white rounded-lg p-8 w-full max-w-md">
    <h2 class="text-2xl font-bold text-center mb-8 text-gray-800">è»ŠéšŠç®¡ç†å“¡ç™»å…¥</h2>
    
    <!-- ç™»å…¥è¡¨å–® -->
    <form id="managerLoginForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-2" for="loginAccount">ç™»å…¥å¸³è™Ÿ</label>
        <input 
          type="text" 
          id="loginAccount" 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
          placeholder="è«‹è¼¸å…¥æ‚¨çš„ç™»å…¥å¸³è™Ÿ"
          required
        >
      </div>
      <div class="mb-6">
        <label class="block text-gray-700 mb-2" for="loginPassword">ç™»å…¥å¯†ç¢¼</label>
        <input 
          type="password" 
          id="loginPassword" 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
          placeholder="è«‹è¼¸å…¥æ‚¨çš„ç™»å…¥å¯†ç¢¼"
          required
        >
        <div class="error-tip" id="loginErrorTip"></div>
      </div>
      <button 
        type="submit" 
        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200"
      >
        ç™»å…¥ç³»çµ±
      </button>
    </form>

    <!-- å¿˜è¨˜å¯†ç¢¼æŒ‰éˆ• -->
    <div class="text-center mt-4">
      <button id="forgotPasswordBtn" class="text-blue-600 hover:underline text-sm">
        å¿˜è¨˜å¯†ç¢¼ï¼Ÿ
      </button>
    </div>
  </div>

  <script>
    // æ ¸å¿ƒé…ç½®ï¼šèˆ‡è¶…ç®¡å¾Œå°çµ±ä¸€çš„å­˜å„²éµ + ç™»å…¥è·³è½‰ç›®æ¨™
    const FLEET_ADMIN_KEY = 'fleetAdminList';       // å·²å¯©æ ¸ç®¡ç†å“¡åˆ—è¡¨éµå
    const CURRENT_MANAGER_KEY = 'currentFleetManager'; // ç•¶å‰ç™»å…¥ç”¨æˆ¶å­˜å„²éµ
    const DASHBOARD_URL = 'admin/admin-dashboard.html'; // ç™»å…¥å¾Œè·³è½‰é é¢

    // 1. ç™»éŒ„è¡¨å–®æäº¤è™•ç†
    document.getElementById('managerLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const errorTip = document.getElementById('loginErrorTip');
      errorTip.style.display = 'none'; // éš±è—ä¹‹å‰çš„éŒ¯èª¤æç¤º

      // ç²å–ä¸¦æ ¡é©—è¼¸å…¥
      const inputAccount = document.getElementById('loginAccount').value.trim();
      const inputPassword = document.getElementById('loginPassword').value.trim();
      
      if (!inputAccount) {
        errorTip.textContent = 'è«‹è¼¸å…¥ç™»å…¥å¸³è™Ÿï¼';
        errorTip.style.display = 'block';
        return;
      }
      if (!inputPassword) {
        errorTip.textContent = 'è«‹è¼¸å…¥ç™»å…¥å¯†ç¢¼ï¼';
        errorTip.style.display = 'block';
        return;
      }

      try {
        // è®€å–å·²å¯©æ ¸çš„è»ŠéšŠç®¡ç†å“¡æ•¸æ“š
        const adminList = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
        
        // åš´æ ¼é©—è­‰ï¼šå¸³è™ŸåŒ¹é… + å¯†ç¢¼åŒ¹é… + ç‹€æ…‹æ­£å¸¸
        const validManager = adminList.find(item => 
          item.account === inputAccount && 
          item.password === inputPassword && 
          item.status === 'active'
        );

        if (validManager) {
          // ç™»å…¥æˆåŠŸï¼šå­˜å„²ç”¨æˆ¶ä¿¡æ¯ï¼ˆåƒ…å­˜å¿…è¦å­—æ®µï¼Œé¿å…æ•æ„Ÿä¿¡æ¯éå¤šï¼‰
          const loginUserInfo = {
            id: validManager.id,
            fleetName: validManager.fleetName,
            managerName: validManager.managerName,
            account: validManager.account,
            phone: validManager.phone,
            email: validManager.email
          };
          localStorage.setItem(CURRENT_MANAGER_KEY, JSON.stringify(loginUserInfo));

          // å‹å¥½æç¤º + è·³è½‰å¾Œå°
          alert(`ğŸ‰ ç™»å…¥æˆåŠŸï¼æ­¡è¿ ${validManager.fleetName} - ${validManager.managerName}`);
          window.location.href = DASHBOARD_URL;
        } else {
          // ç™»éŒ„å¤±æ•—ï¼šæ¨¡ç³Šæç¤ºï¼ˆé¿å…æ´©éœ²å¸³è™Ÿæ˜¯å¦å­˜åœ¨ï¼‰
          errorTip.textContent = 'å¸³è™Ÿ/å¯†ç¢¼éŒ¯èª¤ï¼Œæˆ–å¸³è™Ÿæœªå¯©æ ¸/å·²åœæ¬Šï¼';
          errorTip.style.display = 'block';
          document.getElementById('loginPassword').value = ''; // æ¸…ç©ºå¯†ç¢¼æ¡†
        }
      } catch (err) {
        // ç•°å¸¸è™•ç†
        console.error('ç™»éŒ„é©—è­‰å¤±æ•—ï¼š', err);
        errorTip.textContent = 'ç³»çµ±ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ï¼';
        errorTip.style.display = 'block';
      }
    });

    // 2. å¿˜è¨˜å¯†ç¢¼åŠŸèƒ½ï¼ˆåŸºæ–¼å¸³è™ŸæŸ¥è©¢å¯†ç¢¼/ä¿¡ç®±ï¼‰
    document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
      const inputAccount = prompt('è«‹è¼¸å…¥æ‚¨çš„ç™»å…¥å¸³è™Ÿï¼Œæˆ‘å€‘å°‡æç¤ºå¯†ç¢¼ä¿¡æ¯ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰ï¼š');
      if (!inputAccount) return;

      const adminList = JSON.parse(localStorage.getItem(FLEET_ADMIN_KEY) || '[]');
      const manager = adminList.find(item => item.account === inputAccount);
      
      if (manager) {
        // æ¸¬è©¦ç’°å¢ƒï¼šç›´æ¥æç¤ºå¯†ç¢¼ï¼ˆæ­£å¼ç’°å¢ƒéœ€æ›¿æ›ç‚ºéƒµä»¶ç™¼é€é‚è¼¯ï¼‰
        const tipContent = manager.email 
          ? `ğŸ“§ æ‚¨çš„ç¶å®šä¿¡ç®±ï¼š${manager.email}\nğŸ”‘ æ‚¨çš„ç™»éŒ„å¯†ç¢¼ï¼š${manager.password}`
          : `ğŸ”‘ æ‚¨çš„ç™»éŒ„å¯†ç¢¼ï¼š${manager.password}\nâš ï¸ æœªç¶å®šä¿¡ç®±ï¼Œè«‹è¯ç¹«è¶…ç´šç®¡ç†å“¡`;
        alert(tipContent);
      } else {
        alert('âŒ æœªæ‰¾åˆ°è©²å¸³è™Ÿï¼Œè«‹ç¢ºèªå¸³è™Ÿæ˜¯å¦æ­£ç¢ºä¸”å·²é€šéå¯©æ ¸ï¼');
      }
    });

    // 3. é é¢åŠ è¼‰æ™‚ï¼šæª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼Œé¿å…é‡è¤‡ç™»éŒ„
    window.addEventListener('load', function() {
      const currentManager = JSON.parse(localStorage.getItem(CURRENT_MANAGER_KEY) || 'null');
      if (currentManager) {
        // å·²ç™»å…¥ï¼šç›´æ¥è·³è½‰å¾Œå°
        alert(`â„¹ï¸ æª¢æ¸¬åˆ°æ‚¨å·²ç™»å…¥ï¼š${currentManager.fleetName} - ${currentManager.managerName}\nå³å°‡è·³è½‰åˆ°ç®¡ç†å¾Œå°`);
        window.location.href = DASHBOARD_URL;
      }
    });

    // 4. é˜²å‘†ï¼šæª¢æŸ¥è·³è½‰è·¯å¾‘æ˜¯å¦åˆæ³•ï¼ˆé¿å…ç›¸å°è·¯å¾‘éŒ¯èª¤ï¼‰
    function checkDashboardPath() {
      const isLocalEnv = window.location.protocol === 'file:' || window.location.hostname === 'localhost';
      if (isLocalEnv) return; // æœ¬åœ°é–‹ç™¼ç’°å¢ƒè·³éæª¢æŸ¥
      
      // æ¨¡æ“¬æª¢æŸ¥è·¯å¾‘æ˜¯å¦å­˜åœ¨ï¼ˆæ­£å¼ç’°å¢ƒå¯æ›¿æ›ç‚ºå¾Œç«¯æ¥å£é©—è­‰ï¼‰
      fetch(DASHBOARD_URL, { method: 'HEAD' })
        .catch(err => {
          console.warn(`âš ï¸ è·³è½‰ç›®æ¨™é é¢ ${DASHBOARD_URL} å¯èƒ½ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥è·¯å¾‘ï¼`, err);
        });
    }
    // é é¢åŠ è¼‰å®Œæˆå¾Œæª¢æŸ¥è·¯å¾‘
    window.addEventListener('DOMContentLoaded', checkDashboardPath);
  </script>
</body>
</html>