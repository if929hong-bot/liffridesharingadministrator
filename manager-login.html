<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>車隊管理員登入</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#228B22',
            secondary: '#6c757d'
          },
          boxShadow: {
            card: '0 4px 20px rgba(0, 0, 0, 0.08)',
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .form-input {
        @apply w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-all;
      }
      .btn-primary {
        @apply bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary/90 active:bg-primary/80 transition-all duration-200;
      }
      .text-link {
        @apply text-primary hover:text-primary/80 hover:underline transition-colors;
      }
      .form-group {
        @apply mb-5;
      }
      .form-label {
        @apply block text-sm font-medium text-gray-700 mb-2;
      }
      .shake-animation {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      }
      @keyframes shake {
        10%, 90% { transform: translateX(-1px); }
        20%, 80% { transform: translateX(2px); }
        30%, 50%, 70% { transform: translateX(-4px); }
        40%, 60% { transform: translateX(4px); }
      }
    }
  </style>

  <style>
    /* Utils工具類樣式 */
    .utils-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 300px;
      width: 100%;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease forwards;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .utils-alert.success {
      background: #f0fdf4;
      color: #065f46;
    }
    .utils-alert.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .utils-alert.warning {
      background: #fffbeb;
      color: #92400e;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #228B22;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      right: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      animation: spin 1s linear infinite;
    }
  </style>

  <script>
    /**
     * 全局工具類 - 提升網站穩定性、統一處理通用邏輯
     * 適用於所有車隊管理系統頁面（管理員登入/後台管理/司機管理/訂單管理）
     */
    const Utils = {
      // ========== 基礎工具方法 ==========
      safeParseJSON(str) {
        try {
          return str && str !== 'null' && str !== 'undefined' ? JSON.parse(str) : null;
        } catch (e) {
          console.error('JSON解析失敗:', e, '原始字串:', str);
          return null;
        }
      },

      safeGetElement(id) {
        const el = document.getElementById(id);
        if (!el) console.warn(`[Utils] 元素#${id}不存在`);
        return el;
      },

      validateNumber(value, allowZero = false) {
        const trimmed = value.trim();
        if (!/^\d+$/.test(trimmed)) return false;
        if (!allowZero && Number(trimmed) <= 0) return false;
        return true;
      },

      showMessage(message, type = 'success', duration = 3) {
        const oldAlert = document.querySelector('.utils-alert');
        if (oldAlert) oldAlert.remove();
        
        const alertEl = document.createElement('div');
        alertEl.className = `utils-alert ${type}`;
        
        const iconMap = {
          success: '<i class="fa fa-check-circle"></i>',
          error: '<i class="fa fa-times-circle"></i>',
          warning: '<i class="fa fa-exclamation-circle"></i>'
        };
        
        alertEl.innerHTML = `
          ${iconMap[type] || iconMap.success}
          <span>${message}</span>
        `;
        
        document.body.appendChild(alertEl);
        
        if (duration > 0) {
          setTimeout(() => {
            alertEl.style.animation = 'slideIn 0.3s ease reverse forwards';
            setTimeout(() => alertEl.remove(), 300);
          }, duration * 1000);
        }
        
        return alertEl;
      },

      // ========== 本地存儲管理（帶過期機制） ==========
      Storage: {
        set(key, data, expireHours = 24) {
          try {
            const value = JSON.stringify(data);
            localStorage.setItem(key, value);
            if (expireHours) {
              const expireTime = Date.now() + expireHours * 60 * 60 * 1000;
              localStorage.setItem(`${key}_expire`, expireTime);
            }
          } catch (e) {
            console.error('[Storage] 儲存失敗:', e);
            Utils.showMessage('本地存儲空間不足，無法保存數據！', 'error');
          }
        },

        get(key) {
          try {
            const expireTime = localStorage.getItem(`${key}_expire`);
            if (expireTime && Date.now() > Number(expireTime)) {
              this.remove(key);
              return null;
            }
            return Utils.safeParseJSON(localStorage.getItem(key));
          } catch (e) {
            console.error('[Storage] 讀取失敗:', e);
            return null;
          }
        },

        remove(key) {
          localStorage.removeItem(key);
          localStorage.removeItem(`${key}_expire`);
        },

        clearInvalidLoginData(keys) {
          keys.forEach(key => {
            const data = this.get(key);
            if (data) {
              const hasValidAccount = data.帳號 || data.username || data.account;
              if (!hasValidAccount) {
                this.remove(key);
                console.log(`已移除無效的登入數據: ${key}`);
              }
            }
          });
        },

        clearAllFleetData() {
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.includes('fleet') || key.includes('admin') || key.includes('manager') || key.includes('driver') || key.includes('order')) {
              this.remove(key);
            }
          });
        }
      },

      // ========== UI增強方法 ==========
      showLoading(el, text = '處理中...') {
        if (!el) {
          const loadingEl = document.createElement('div');
          loadingEl.className = 'loading-overlay';
          loadingEl.innerHTML = `
            <div class="flex flex-col items-center gap-3">
              <div class="loading-spinner"></div>
              <span class="text-gray-700 text-base">${text}</span>
            </div>
          `;
          loadingEl.id = 'page-loading';
          document.body.appendChild(loadingEl);
          return;
        }

        if (!el) return;
        el.disabled = true;
        el.classList.add('btn-loading');
        const originalText = el.innerHTML;
        el.setAttribute('data-original-text', originalText);
        el.innerHTML = text;
      },

      hideLoading(el, restoreText = '') {
        const pageLoading = document.getElementById('page-loading');
        if (pageLoading) pageLoading.remove();

        if (el) {
          el.disabled = false;
          el.classList.remove('btn-loading');
          const originalText = el.getAttribute('data-original-text');
          if (originalText) el.innerHTML = originalText;
          else if (restoreText) el.innerHTML = restoreText;
        }
      },

      safeNavigate(url, message = '') {
        try {
          if (message) Utils.showMessage(message, 'success');
          Utils.showLoading(null, '正在進入系統...');
          setTimeout(() => {
            window.location.href = url;
          }, 800);
        } catch (e) {
          console.error('跳轉失敗:', e);
          Utils.hideLoading();
          Utils.showMessage('頁面跳轉失敗，請手動操作', 'error');
        }
      },

      // ========== 表單驗證專用方法 ==========
      FormValidator: {
        validateLoginForm(username, password) {
          if (!username || !password) {
            return {
              isValid: false,
              error: '請輸入帳號和密碼！'
            };
          }

          if (username.length < 3 || username.length > 20) {
            return {
              isValid: false,
              error: '帳號長度需在3-20個字符之間！'
            };
          }

          if (password.length < 6) {
            return {
              isValid: false,
              error: '密碼長度不能少於6個字符！'
            };
          }

          return {
            isValid: true,
            error: ''
          };
        },

        validateAdminCredentials(username, password, approvedKey) {
          const approvedList = Utils.Storage.get(approvedKey) || [];
          
          // 強化：空列表直接返回錯誤提示
          if (approvedList.length === 0) {
            Utils.showMessage('暫無已審核的車隊管理員，請先註冊並等待審核！', 'error');
            return null;
          }

          // 強化：嚴格匹配帳號密碼，防止繞過審核
          const matchAdmin = approvedList.find(admin => {
            const accMatch = admin.帳號 === username || admin.username === username || admin.account === username;
            const pwdMatch = admin.密碼 === password || admin.password === password || admin.pwd === password;
            // 新增：驗證審核狀態
            const isApproved = admin.approved === true || admin.審核狀態 === '已通過';
            return accMatch && pwdMatch && isApproved;
          });

          return matchAdmin;
        }
      },

      // ========== 管理員登入專用方法 ==========
      AdminAuth: {
        async login(username, password, approvedKey, loggedKey, backupKey, redirectUrl) {
          const validation = Utils.FormValidator.validateLoginForm(username, password);
          if (!validation.isValid) {
            Utils.showMessage(validation.error, 'error');
            return false;
          }

          const matchAdmin = Utils.FormValidator.validateAdminCredentials(username, password, approvedKey);
          
          if (matchAdmin) {
            // 強化：保存時標記審核狀態
            matchAdmin.loginTime = new Date().toLocaleString('zh-TW');
            matchAdmin.isApproved = true;
            Utils.Storage.set(loggedKey, matchAdmin, 24);
            Utils.Storage.set(backupKey, matchAdmin, 24);
            
            this.logLoginActivity(matchAdmin, 'success');
            Utils.safeNavigate(redirectUrl, `歡迎回來，${matchAdmin.姓名 || matchAdmin.name || username}！`);
            return true;
          } else {
            this.logLoginActivity({ username: username }, 'failed');
            Utils.showMessage('帳號未審核、不存在或密碼錯誤！', 'error');
            
            const form = Utils.safeGetElement('manager-login-form');
            if (form) {
              form.classList.add('shake-animation');
              setTimeout(() => form.classList.remove('shake-animation'), 500);
            }
            
            const passwordInput = Utils.safeGetElement('manager-password');
            if (passwordInput) {
              passwordInput.value = '';
              passwordInput.focus();
            }
            
            return false;
          }
        },

        logLoginActivity(adminData, status) {
          try {
            const loginLogs = Utils.Storage.get('admin_login_logs') || [];
            
            loginLogs.push({
              username: adminData.帳號 || adminData.username || adminData.account || adminData.username,
              timestamp: Date.now(),
              time: new Date().toLocaleString('zh-TW'),
              status: status,
              ip: window.location.hostname,
              userAgent: navigator.userAgent
            });
            
            if (loginLogs.length > 100) {
              loginLogs.splice(0, loginLogs.length - 100);
            }
            
            Utils.Storage.set('admin_login_logs', loginLogs, 30 * 24);
          } catch (error) {
            console.error('記錄登入日志失敗:', error);
          }
        },

        checkLoggedInStatus(loggedKey, redirectUrl) {
          const loggedAdmin = Utils.Storage.get(loggedKey);
          if (loggedAdmin) {
            // 強化：檢查登入狀態是否已審核
            const isApproved = loggedAdmin.isApproved === true || loggedAdmin.審核狀態 === '已通過';
            if (isApproved) {
              Utils.safeNavigate(redirectUrl, '檢測到您已有登入狀態，正在進入系統...');
            } else {
              // 未審核則清除狀態
              Utils.Storage.remove(loggedKey);
              Utils.showMessage('您的帳號未通過審核，請先完成審核！', 'error');
            }
          }
        }
      }
    };

    // ========== 頁面常量定義 ==========
    const APPROVED_KEY = 'approvedFleetAdmins';
    const LOGGED_KEY = 'loggedInFleetAdmin';
    const BACKUP_LOGGED_KEY = 'currentFleetAdmin';
    const BACKEND_PAGE = 'admin-dashboard.html';

    // ========== 頁面初始化 ==========
    document.addEventListener('DOMContentLoaded', () => {
      Utils.Storage.clearInvalidLoginData([LOGGED_KEY, BACKUP_LOGGED_KEY]);
      Utils.AdminAuth.checkLoggedInStatus(LOGGED_KEY, BACKEND_PAGE);
      initLoginForm();
      initFormInteractions();
      Utils.showMessage('歡迎使用車隊管理系統', 'success', 2);
    });

    // ========== 登入表單初始化 ==========
    function initLoginForm() {
      const loginForm = Utils.safeGetElement('manager-login-form');
      if (!loginForm) return;

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const usernameInput = Utils.safeGetElement('manager-username');
        const passwordInput = Utils.safeGetElement('manager-password');
        const errorEl = Utils.safeGetElement('login-error');
        
        if (!usernameInput || !passwordInput || !errorEl) return;
        
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        const submitBtn = e.submitter || loginForm.querySelector('button[type="submit"]');
        
        errorEl.classList.add('hidden');
        
        try {
          if (submitBtn) {
            Utils.showLoading(submitBtn, '<i class="fa fa-spinner fa-spin mr-2"></i> 驗證中...');
          }
          
          const loginSuccess = await Utils.AdminAuth.login(
            username, 
            password, 
            APPROVED_KEY, 
            LOGGED_KEY, 
            BACKUP_LOGGED_KEY, 
            BACKEND_PAGE
          );
          
          if (!loginSuccess && submitBtn) {
            Utils.hideLoading(submitBtn);
          }
          
        } catch (error) {
          console.error('登入處理失敗:', error);
          if (submitBtn) {
            Utils.hideLoading(submitBtn);
          }
          Utils.showMessage('登入處理異常，請稍後重試', 'error');
        }
      });
    }

    // ========== 表單交互初始化 ==========
    function initFormInteractions() {
      const passwordInput = Utils.safeGetElement('manager-password');
      if (passwordInput) {
        passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const loginForm = Utils.safeGetElement('manager-login-form');
            if (loginForm) {
              loginForm.dispatchEvent(new Event('submit'));
            }
          }
        });
        
        passwordInput.addEventListener('focus', () => {
          const errorEl = Utils.safeGetElement('login-error');
          if (errorEl && !errorEl.classList.contains('hidden')) {
            passwordInput.parentElement.parentElement.classList.add('shake-animation');
            setTimeout(() => {
              passwordInput.parentElement.parentElement.classList.remove('shake-animation');
            }, 500);
          }
        });
      }
      
      const usernameInput = Utils.safeGetElement('manager-username');
      if (usernameInput) {
        usernameInput.addEventListener('focus', () => {
          if (usernameInput.value) {
            usernameInput.select();
          }
        });
        
        usernameInput.addEventListener('input', (e) => {
          const cleanValue = e.target.value.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_]/g, '');
          if (cleanValue !== e.target.value) {
            e.target.value = cleanValue;
            Utils.showMessage('帳號僅支持字母、數字、下劃線和中文', 'warning', 2);
          }
        });
      }
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-card p-8 sm:p-10">
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-full mb-4">
        <i class="fa fa-building text-primary text-3xl"></i>
      </div>
      <h2 class="text-[clamp(1.5rem,3vw,1.8rem)] font-bold text-gray-800">車隊管理員登入</h2>
      <p class="text-gray-500 mt-1">請輸入審核通過的帳號密碼</p>
    </div>
    
    <form id="manager-login-form" class="space-y-4">
      <div class="form-group">
        <label class="form-label">管理員帳號</label>
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
            <i class="fa fa-user"></i>
          </span>
          <input 
            type="text" 
            id="manager-username" 
            class="form-input pl-10" 
            placeholder="請輸入審核通過的帳號" 
            required
            autocomplete="username"
          >
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">密碼</label>
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
            <i class="fa fa-lock"></i>
          </span>
          <input 
            type="password" 
            id="manager-password" 
            class="form-input pl-10" 
            placeholder="請輸入密碼" 
            required
            autocomplete="current-password"
          >
        </div>
      </div>
      
      <div class="text-red-500 text-sm text-center hidden mt-2" id="login-error">
        <i class="fa fa-exclamation-circle mr-1"></i> 帳號未審核或密碼錯誤！
      </div>
      
      <button type="submit" class="btn-primary w-full font-medium mt-2">
        <i class="fa fa-sign-in mr-2"></i> 登入
      </button>
    </form>
    
    <div class="mt-4 text-right">
      <a href="forgot-password.html" class="text-link text-sm">
        <i class="fa fa-question-circle mr-1"></i> 忘記密碼？
      </a>
    </div>
    
    <div class="mt-8 text-center pt-6 border-t border-gray-100">
      <p class="text-gray-600">尚未註冊車隊管理員？
        <a href="register.html" class="text-link font-medium">立即註冊</a>
      </p>
    </div>
    
    <div class="mt-4 text-xs text-gray-500 text-center">
      <p><i class="fa fa-shield mr-1"></i> 登入即表示您同意遵守系統使用規範</p>
    </div>
  </div>
</body>
</html>