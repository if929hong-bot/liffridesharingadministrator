<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>車隊管理員系統 - 首頁</title>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft JhengHei", sans-serif;
    }
    body {
      background: #F5F5F5;
      color: #333;
      display: flex;
      min-height: 100vh;
    }
    /* 未登錄提示遮罩 */
    .unauth-overlay {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    /* 側邊欄 */
    .sidebar {
      width: 200px;
      background: white;
      border-right: 1px solid #eee;
      padding: 20px 0;
    }
    .sidebar-item {
      display: block;
      padding: 14px 25px;
      color: #333;
      text-decoration: none;
      margin-bottom: 8px;
      border-left: 4px solid transparent;
    }
    .sidebar-item.active {
      background: #F0FFF4;
      color: #00C853;
      border-left: 4px solid #00C853;
    }
    /* 主內容 */
    .main {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
      height: 100vh;
    }
    .module {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .module-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .form-label {
      width: 120px;
      font-weight: 500;
    }
    input, select {
      flex: 1;
      max-width: 300px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    button {
      background: #00C853;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #00A600;
    }
    /* 提示樣式 */
    .alert {
      padding: 12px 16px;
      border-radius: 4px;
      margin: 10px 0;
      color: white;
    }
    .alert.error {
      background: #ff4444;
    }
    .alert.success {
      background: #00C853;
    }
  </style>
  <script>
    /**
     * 全局工具類 - 統一處理通用邏輯
     */
    const Utils = {
      // ========== 基礎工具方法 ==========
      safeParseJSON(str) {
        try {
          return str && str !== 'null' && str !== 'undefined' ? JSON.parse(str) : null;
        } catch (e) {
          console.error('JSON解析失敗:', e, '原始字串:', str);
          return null;
        }
      },

      safeGetElement(id) {
        const el = document.getElementById(id);
        if (!el) console.warn(`[Utils] 元素#${id}不存在`);
        return el;
      },

      validateNumber(value, allowZero = false) {
        const trimmed = value.trim();
        if (!/^\d+$/.test(trimmed)) return false;
        if (!allowZero && Number(trimmed) <= 0) return false;
        return true;
      },

      // ========== 本地存儲管理（帶過期機制） ==========
      Storage: {
        set(key, data, expireHours = 24) {
          try {
            const value = JSON.stringify(data);
            localStorage.setItem(key, value);
            if (expireHours) {
              const expireTime = Date.now() + expireHours * 60 * 60 * 1000;
              localStorage.setItem(`${key}_expire`, expireTime);
            }
          } catch (e) {
            console.error('[Storage] 儲存失敗:', e);
            alert('本地存儲空間不足，無法保存數據！');
          }
        },

        get(key) {
          try {
            const expireTime = localStorage.getItem(`${key}_expire`);
            if (expireTime && Date.now() > Number(expireTime)) {
              this.remove(key);
              return null;
            }
            return Utils.safeParseJSON(localStorage.getItem(key));
          } catch (e) {
            console.error('[Storage] 讀取失敗:', e);
            return null;
          }
        },

        remove(key) {
          localStorage.removeItem(key);
          localStorage.removeItem(`${key}_expire`);
        },

        clearAllFleetData() {
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.includes('fleet') || key.includes('admin') || key.includes('price') || key.includes('finance')) {
              this.remove(key);
            }
          });
        }
      },

      // ========== 登錄狀態管理（強化版） ==========
      Auth: {
        KEYS: {
          LOGGED_IN: 'loggedInFleetAdmin',
          BACKUP: 'currentFleetAdmin',
          APPROVED: 'approvedFleetAdmins'
        },

        // 強化：雙重驗證（登入狀態 + 審核狀態）
        checkLoginStatus() {
          // 1. 獲取登入狀態
          let adminData = Utils.Storage.get(Utils.Auth.KEYS.LOGGED_IN);
          if (!adminData) {
            adminData = Utils.Storage.get(Utils.Auth.KEYS.BACKUP);
          }

          // 2. 驗證基本信息
          const hasValidAccount = adminData && (
            adminData.帳號 || adminData.username || adminData.account || adminData.phone
          );
          if (!hasValidAccount) {
            Utils.Storage.clearAllFleetData();
            return false;
          }

          // 3. 驗證審核狀態（核心：防止跳過審核）
          const approvedList = Utils.Storage.get(Utils.Auth.KEYS.APPROVED) || [];
          const isApproved = approvedList.some(admin => {
            const accMatch = admin.帳號 === adminData.帳號 || admin.username === adminData.username;
            const isApprovedStatus = admin.approved === true || admin.審核狀態 === '已通過';
            return accMatch && isApprovedStatus;
          });

          if (!isApproved) {
            Utils.Storage.clearAllFleetData();
            return false;
          }

          // 4. 刷新登入狀態
          Utils.Storage.set(Utils.Auth.KEYS.LOGGED_IN, adminData, 24);
          return true;
        },

        redirectToLogin() {
          const overlay = Utils.safeGetElement('unauthOverlay');
          if (overlay) {
            overlay.innerHTML = `
              <div class="text-center max-w-md">
                <i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">未登錄/帳號未審核</h2>
                <p class="text-gray-600 mb-6">請先完成車隊管理員註冊並通過審核後登入</p>
                <a href="manager-login.html" class="inline-block py-3 px-6 bg-#00C853 text-white rounded-lg font-medium hover:bg-#00A600 transition-all">
                  返回登入頁面
                </a>
              </div>
            `;
            overlay.classList.remove('hidden');
          } else {
            alert('您尚未登入或帳號未通過審核，請重新操作！');
            window.location.href = 'manager-login.html';
          }
        },

        logout() {
          Utils.Storage.clearAllFleetData();
          window.location.href = 'manager-login.html';
        }
      },

      // ========== UI增強方法 ==========
      showLoading(el, text = '加載中...') {
        if (!el) return;
        el.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
              <i class="fa fa-spinner fa-spin mr-2"></i>${text}
          </div>
        `;
      },

      showEmptyData(el, text = '暫無數據', colspan = 1) {
        if (!el) return;
        if (el.tagName === 'TBODY') {
          el.innerHTML = `
            <tr>
              <td colspan="${colspan}" style="padding: 30px; text-align: center; color: #666;">
                ${text}
              </td>
            </tr>
          `;
        } else {
          el.innerHTML = `
            <div style="padding: 30px; text-align: center; color: #666;">
              ${text}
            </div>
          `;
        }
      },

      validateFormNumbers(inputs) {
        let isValid = true;
        inputs.forEach(input => {
          const label = input.previousElementSibling?.textContent || input.name || '該項';
          const value = input.value;

          if (!Utils.validateNumber(value)) {
            alert(`${label}只能填大於0的數字！`);
            input.focus();
            isValid = false;
            return false;
          }
        });
        return isValid;
      }
    };
  </script>
</head>
<body>
  <!-- 未登錄提示遮罩 -->
  <div id="unauthOverlay" class="unauth-overlay hidden">
    <div class="text-center max-w-md">
      <i class="fa fa-spinner fa-spin text-4xl text-gray-500 mb-4"></i>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">驗證中...</h2>
      <p class="text-gray-600">請稍候，正在檢查您的登入狀態和審核信息</p>
    </div>
  </div>

  <!-- 左側菜單 -->
  <div class="sidebar">
    <a href="admin-dashboard.html" class="sidebar-item active">首頁</a>
    <a href="admin-area.html" class="sidebar-item">區域管理</a>
    <a href="admin-driver.html" class="sidebar-item">司機管理</a>
    <a href="admin-order.html" class="sidebar-item">訂單管理</a>
    <a href="admin-finance.html" class="sidebar-item">財務管理</a>
    <a href="admin-report.html" class="sidebar-item">報表統計</a>
    <a href="javascript:void(0)" class="sidebar-item" id="logoutLink">退出登入</a>
  </div>

  <!-- 主內容 -->
  <div class="main">
    <!-- 1. 繳租金額填寫 -->
    <div class="module">
      <div class="module-title">繳租金額填寫</div>
      <div class="form-row">
        <div class="form-label">繳費類型</div>
        <select id="paymentType">
          <option value="10000">月繳 (10000/月)</option>
          <option value="28500">季繳 (9500/月 ×3)</option>
          <option value="54000">半年繳 (9000/月 ×6)</option>
          <option value="102000">年繳 (8500/月 ×12)</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-label">金額總和</div>
        <input type="text" id="totalAmount" value="NT$ 10000" readonly>
      </div>
      <div class="form-row">
        <div class="form-label">匯款後五碼</div>
        <input type="text" id="remitCode">
      </div>
      <div class="form-row">
        <div class="form-label">上傳截圖</div>
        <input type="file" id="remitFile">
      </div>
    </div>

    <!-- 2. 繳費銀行資訊 -->
    <div class="module">
      <div class="module-title">繳費銀行資訊</div>
      <div class="form-row">
        <div class="form-label">銀行名稱</div>
        <input type="text" value="國泰世華" readonly>
      </div>
      <div class="form-row">
        <div class="form-label">分行</div>
        <input type="text" value="台北分行" readonly>
      </div>
      <div class="form-row">
        <div class="form-label">戶名</div>
        <input type="text" value="車隊管理中心" readonly>
      </div>
      <div class="form-row">
        <div class="form-label">帳號</div>
        <input type="text" value="123-456789" readonly>
      </div>
    </div>

    <!-- 3. 價格設定 -->
    <div class="module" id="priceModule">
      <div class="module-title">價格設定</div>
      <div class="form-row">
        <div class="form-label">起步價格</div>
        <input type="text" id="startPrice" value="100">
      </div>
      <div class="form-row">
        <div class="form-label">里程費用(每km)</div>
        <input type="text" id="kmPrice" value="15">
      </div>
      <div class="form-row">
        <div class="form-label">時間費用(每min)</div>
        <input type="text" id="minPrice" value="2">
      </div>
      <div class="form-row">
        <div class="form-label">固定回給</div>
        <input type="text" id="fixedReturn" value="50">
      </div>
      <div class="form-row">
        <div class="form-label">固定百回(%)</div>
        <input type="text" id="percentReturn" value="5">
      </div>
      <button style="margin-top: 15px;" id="savePriceBtn">儲存設定</button>
    </div>

    <!-- 4. 司機固定月費設定 -->
    <div class="module">
      <div class="module-title">司機固定月費設定</div>
      <div class="form-row">
        <div class="form-label">月費金額</div>
        <input type="text" id="monthlyFee" value="500">
      </div>
    </div>

    <button id="submitRemitBtn">提交繳費資訊</button>
  </div>

  <script>
    // 頁面加載初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 1. 強制驗證登入+審核狀態（核心修復）
      if (!Utils.Auth.checkLoginStatus()) {
        Utils.Auth.redirectToLogin();
        return;
      }

      // 2. 初始化功能
      initPaymentType();
      initPriceSave();
      initRemitSubmit();
      initLogout();
      loadSavedPriceConfig();
    });

    // ========== 繳費類型切換 ==========
    function initPaymentType() {
      const paymentType = Utils.safeGetElement('paymentType');
      const totalAmount = Utils.safeGetElement('totalAmount');

      if (paymentType && totalAmount) {
        totalAmount.value = `NT$ ${paymentType.value}`;

        paymentType.addEventListener('change', function() {
          const value = this.value || '10000';
          totalAmount.value = `NT$ ${value}`;
        });
      }
    }

    // ========== 價格設定儲存 ==========
    function initPriceSave() {
      const saveBtn = Utils.safeGetElement('savePriceBtn');
      if (!saveBtn) return;

      saveBtn.addEventListener('click', function() {
        const priceInputs = [
          Utils.safeGetElement('startPrice'),
          Utils.safeGetElement('kmPrice'),
          Utils.safeGetElement('minPrice'),
          Utils.safeGetElement('fixedReturn'),
          Utils.safeGetElement('percentReturn')
        ].filter(el => el);

        if (!Utils.validateFormNumbers(priceInputs)) {
          return;
        }

        const priceConfig = {
          startPrice: Utils.safeGetElement('startPrice').value,
          kmPrice: Utils.safeGetElement('kmPrice').value,
          minPrice: Utils.safeGetElement('minPrice').value,
          fixedReturn: Utils.safeGetElement('fixedReturn').value,
          percentReturn: Utils.safeGetElement('percentReturn').value
        };

        Utils.Storage.set('priceConfig', priceConfig, 7 * 24);
        alert('價格設定已成功保存！');
      });
    }

    // ========== 繳費資訊提交 ==========
    function initRemitSubmit() {
      const submitBtn = Utils.safeGetElement('submitRemitBtn');
      const remitCode = Utils.safeGetElement('remitCode');
      const remitFile = Utils.safeGetElement('remitFile');

      if (!submitBtn) return;

      submitBtn.addEventListener('click', function() {
        if (remitCode) {
          const codeValue = remitCode.value.trim();
          if (!/^\d{5}$/.test(codeValue)) {
            alert('匯款後五碼必須是5位數字！');
            remitCode.focus();
            return;
          }
        }

        const remitData = {
          paymentType: Utils.safeGetElement('paymentType')?.value || '10000',
          totalAmount: Utils.safeGetElement('totalAmount')?.value || 'NT$ 10000',
          remitCode: remitCode?.value || '',
          remitTime: new Date().toLocaleString('zh-TW')
        };

        const remitHistory = Utils.Storage.get('remitHistory') || [];
        remitHistory.push(remitData);
        Utils.Storage.set('remitHistory', remitHistory, 30 * 24);

        alert('繳費資訊已提交成功！');
        if (remitCode) remitCode.value = '';
        if (remitFile) remitFile.value = '';
      });
    }

    // ========== 退出登錄 ==========
    function initLogout() {
      const logoutLink = Utils.safeGetElement('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', function() {
          if (confirm('確定要退出登入嗎？')) {
            Utils.Auth.logout();
          }
        });
      }
    }

    // ========== 加載已保存的價格設定 ==========
    function loadSavedPriceConfig() {
      const priceConfig = Utils.Storage.get('priceConfig');
      if (!priceConfig) return;

      if (priceConfig.startPrice) Utils.safeGetElement('startPrice').value = priceConfig.startPrice;
      if (priceConfig.kmPrice) Utils.safeGetElement('kmPrice').value = priceConfig.kmPrice;
      if (priceConfig.minPrice) Utils.safeGetElement('minPrice').value = priceConfig.minPrice;
      if (priceConfig.fixedReturn) Utils.safeGetElement('fixedReturn').value = priceConfig.fixedReturn;
      if (priceConfig.percentReturn) Utils.safeGetElement('percentReturn').value = priceConfig.percentReturn;
    }
  </script>
</body>
</html>